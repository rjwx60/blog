<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>总结 | Leibnize 个人学习笔记</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="素材整理自网络，仅供个人学习记录之用">
    <link rel="preload" href="/assets/css/0.styles.4c1fe16c.css" as="style"><link rel="preload" href="/assets/js/app.58d463af.js" as="script"><link rel="preload" href="/assets/js/3.5b6bd7ce.js" as="script"><link rel="preload" href="/assets/js/1.53e5735b.js" as="script"><link rel="preload" href="/assets/js/173.4fa13f79.js" as="script"><link rel="prefetch" href="/assets/js/10.47a34be1.js"><link rel="prefetch" href="/assets/js/100.2f7c82fb.js"><link rel="prefetch" href="/assets/js/101.57a81617.js"><link rel="prefetch" href="/assets/js/102.8befc7fd.js"><link rel="prefetch" href="/assets/js/103.c690f409.js"><link rel="prefetch" href="/assets/js/104.c8b86b63.js"><link rel="prefetch" href="/assets/js/105.9bac0b69.js"><link rel="prefetch" href="/assets/js/106.77dcd9f8.js"><link rel="prefetch" href="/assets/js/107.305a0cd6.js"><link rel="prefetch" href="/assets/js/108.197f379c.js"><link rel="prefetch" href="/assets/js/109.ed1f6dd8.js"><link rel="prefetch" href="/assets/js/11.d67029e2.js"><link rel="prefetch" href="/assets/js/110.b10adffc.js"><link rel="prefetch" href="/assets/js/111.27cb5e44.js"><link rel="prefetch" href="/assets/js/112.598f5429.js"><link rel="prefetch" href="/assets/js/113.b7f9fe99.js"><link rel="prefetch" href="/assets/js/114.cb9df12d.js"><link rel="prefetch" href="/assets/js/115.4d812f2c.js"><link rel="prefetch" href="/assets/js/116.3a4f5195.js"><link rel="prefetch" href="/assets/js/117.be29161e.js"><link rel="prefetch" href="/assets/js/118.eb6b99b9.js"><link rel="prefetch" href="/assets/js/119.b3f342d7.js"><link rel="prefetch" href="/assets/js/12.f13f81de.js"><link rel="prefetch" href="/assets/js/120.f343ff14.js"><link rel="prefetch" href="/assets/js/121.5983ebbd.js"><link rel="prefetch" href="/assets/js/122.8dd46465.js"><link rel="prefetch" href="/assets/js/123.71ffc4a2.js"><link rel="prefetch" href="/assets/js/124.4e568dbe.js"><link rel="prefetch" href="/assets/js/125.43b22375.js"><link rel="prefetch" href="/assets/js/126.6522a7eb.js"><link rel="prefetch" href="/assets/js/127.8308b909.js"><link rel="prefetch" href="/assets/js/128.1fd06c87.js"><link rel="prefetch" href="/assets/js/129.91e28eff.js"><link rel="prefetch" href="/assets/js/13.ac76083d.js"><link rel="prefetch" href="/assets/js/130.5027f9f0.js"><link rel="prefetch" href="/assets/js/131.4554c2f2.js"><link rel="prefetch" href="/assets/js/132.c643aed4.js"><link rel="prefetch" href="/assets/js/133.5e499634.js"><link rel="prefetch" href="/assets/js/134.59b1b330.js"><link rel="prefetch" href="/assets/js/135.da46fa8a.js"><link rel="prefetch" href="/assets/js/136.3a67d738.js"><link rel="prefetch" href="/assets/js/137.4d5f5f5e.js"><link rel="prefetch" href="/assets/js/138.1fe93dba.js"><link rel="prefetch" href="/assets/js/139.d7f54242.js"><link rel="prefetch" href="/assets/js/14.8e5c3120.js"><link rel="prefetch" href="/assets/js/140.82be0f82.js"><link rel="prefetch" href="/assets/js/141.979c5a91.js"><link rel="prefetch" href="/assets/js/142.658ae82d.js"><link rel="prefetch" href="/assets/js/143.17532399.js"><link rel="prefetch" href="/assets/js/144.dc947607.js"><link rel="prefetch" href="/assets/js/145.fc89bd8c.js"><link rel="prefetch" href="/assets/js/146.a5e1b7eb.js"><link rel="prefetch" href="/assets/js/147.0f8384fc.js"><link rel="prefetch" href="/assets/js/148.fccbb459.js"><link rel="prefetch" href="/assets/js/149.d2d32bbc.js"><link rel="prefetch" href="/assets/js/15.e17af96c.js"><link rel="prefetch" href="/assets/js/150.73f88a17.js"><link rel="prefetch" href="/assets/js/151.dd85d521.js"><link rel="prefetch" href="/assets/js/152.ca632725.js"><link rel="prefetch" href="/assets/js/153.02b859a6.js"><link rel="prefetch" href="/assets/js/154.268e5dd0.js"><link rel="prefetch" href="/assets/js/155.0df9a80c.js"><link rel="prefetch" href="/assets/js/156.0e786e96.js"><link rel="prefetch" href="/assets/js/157.79cdcd86.js"><link rel="prefetch" href="/assets/js/158.8a131380.js"><link rel="prefetch" href="/assets/js/159.7aed0b17.js"><link rel="prefetch" href="/assets/js/16.472bfca7.js"><link rel="prefetch" href="/assets/js/160.31daa77a.js"><link rel="prefetch" href="/assets/js/161.a44e6bf4.js"><link rel="prefetch" href="/assets/js/162.86180287.js"><link rel="prefetch" href="/assets/js/163.c9fd632a.js"><link rel="prefetch" href="/assets/js/164.15e04e68.js"><link rel="prefetch" href="/assets/js/165.69bcb02b.js"><link rel="prefetch" href="/assets/js/166.084ab8e2.js"><link rel="prefetch" href="/assets/js/167.0f42977a.js"><link rel="prefetch" href="/assets/js/168.a4474b7b.js"><link rel="prefetch" href="/assets/js/169.3d05b3ba.js"><link rel="prefetch" href="/assets/js/17.f9d21c6e.js"><link rel="prefetch" href="/assets/js/170.484ffe30.js"><link rel="prefetch" href="/assets/js/171.01628965.js"><link rel="prefetch" href="/assets/js/172.2dc6c763.js"><link rel="prefetch" href="/assets/js/174.5da03623.js"><link rel="prefetch" href="/assets/js/175.7c3cae2a.js"><link rel="prefetch" href="/assets/js/176.3df0d63b.js"><link rel="prefetch" href="/assets/js/177.3aa8d705.js"><link rel="prefetch" href="/assets/js/178.5b48450e.js"><link rel="prefetch" href="/assets/js/179.3a963dce.js"><link rel="prefetch" href="/assets/js/18.8314222e.js"><link rel="prefetch" href="/assets/js/180.d67c14c9.js"><link rel="prefetch" href="/assets/js/181.c7bf4046.js"><link rel="prefetch" href="/assets/js/182.4a4705fd.js"><link rel="prefetch" href="/assets/js/183.9183a7da.js"><link rel="prefetch" href="/assets/js/184.290760c3.js"><link rel="prefetch" href="/assets/js/185.64cd4609.js"><link rel="prefetch" href="/assets/js/186.2940410e.js"><link rel="prefetch" href="/assets/js/187.12b14c61.js"><link rel="prefetch" href="/assets/js/188.1fea2b8b.js"><link rel="prefetch" href="/assets/js/189.04b7d343.js"><link rel="prefetch" href="/assets/js/19.ed77427b.js"><link rel="prefetch" href="/assets/js/190.a7d6ec94.js"><link rel="prefetch" href="/assets/js/191.8ad7d925.js"><link rel="prefetch" href="/assets/js/192.2fd0c8f8.js"><link rel="prefetch" href="/assets/js/193.4f8a87cd.js"><link rel="prefetch" href="/assets/js/194.9e2e73ca.js"><link rel="prefetch" href="/assets/js/195.c6292340.js"><link rel="prefetch" href="/assets/js/196.b7ff135e.js"><link rel="prefetch" href="/assets/js/197.83a7d260.js"><link rel="prefetch" href="/assets/js/198.530f7c9c.js"><link rel="prefetch" href="/assets/js/199.c5048869.js"><link rel="prefetch" href="/assets/js/20.09503993.js"><link rel="prefetch" href="/assets/js/200.3435c341.js"><link rel="prefetch" href="/assets/js/201.1e492eea.js"><link rel="prefetch" href="/assets/js/202.f7b55746.js"><link rel="prefetch" href="/assets/js/203.08e404b6.js"><link rel="prefetch" href="/assets/js/204.1bc4bdd8.js"><link rel="prefetch" href="/assets/js/21.38c15b75.js"><link rel="prefetch" href="/assets/js/22.ae59de53.js"><link rel="prefetch" href="/assets/js/23.1c6d3160.js"><link rel="prefetch" href="/assets/js/24.28c7c43e.js"><link rel="prefetch" href="/assets/js/25.e53d1234.js"><link rel="prefetch" href="/assets/js/26.6fe14a49.js"><link rel="prefetch" href="/assets/js/27.910bdd9c.js"><link rel="prefetch" href="/assets/js/28.9d9cd019.js"><link rel="prefetch" href="/assets/js/29.525906aa.js"><link rel="prefetch" href="/assets/js/30.8a1a47c0.js"><link rel="prefetch" href="/assets/js/31.750a297b.js"><link rel="prefetch" href="/assets/js/32.290c8619.js"><link rel="prefetch" href="/assets/js/33.885855c1.js"><link rel="prefetch" href="/assets/js/34.fb5b3f84.js"><link rel="prefetch" href="/assets/js/35.22021291.js"><link rel="prefetch" href="/assets/js/36.6736dcbf.js"><link rel="prefetch" href="/assets/js/37.50fc071e.js"><link rel="prefetch" href="/assets/js/38.a6f00886.js"><link rel="prefetch" href="/assets/js/39.e5f0c600.js"><link rel="prefetch" href="/assets/js/4.4c62e10b.js"><link rel="prefetch" href="/assets/js/40.7eaf6de1.js"><link rel="prefetch" href="/assets/js/41.c55fd828.js"><link rel="prefetch" href="/assets/js/42.2c5aaafc.js"><link rel="prefetch" href="/assets/js/43.6c939d74.js"><link rel="prefetch" href="/assets/js/44.22ccc866.js"><link rel="prefetch" href="/assets/js/45.56a056b8.js"><link rel="prefetch" href="/assets/js/46.6901927f.js"><link rel="prefetch" href="/assets/js/47.78460423.js"><link rel="prefetch" href="/assets/js/48.12fddaae.js"><link rel="prefetch" href="/assets/js/49.55f5515e.js"><link rel="prefetch" href="/assets/js/5.97a7c0dc.js"><link rel="prefetch" href="/assets/js/50.5c665644.js"><link rel="prefetch" href="/assets/js/51.9fbd3941.js"><link rel="prefetch" href="/assets/js/52.f3a93332.js"><link rel="prefetch" href="/assets/js/53.f7c91d71.js"><link rel="prefetch" href="/assets/js/54.035bd227.js"><link rel="prefetch" href="/assets/js/55.9d4300de.js"><link rel="prefetch" href="/assets/js/56.1fa21a7d.js"><link rel="prefetch" href="/assets/js/57.c6af5e20.js"><link rel="prefetch" href="/assets/js/58.8c0baaa7.js"><link rel="prefetch" href="/assets/js/59.63f1befc.js"><link rel="prefetch" href="/assets/js/6.8e992509.js"><link rel="prefetch" href="/assets/js/60.35539f20.js"><link rel="prefetch" href="/assets/js/61.0872b63b.js"><link rel="prefetch" href="/assets/js/62.6749d184.js"><link rel="prefetch" href="/assets/js/63.0a8a07d3.js"><link rel="prefetch" href="/assets/js/64.a2eeb6f7.js"><link rel="prefetch" href="/assets/js/65.d78ecb46.js"><link rel="prefetch" href="/assets/js/66.1e1a87a2.js"><link rel="prefetch" href="/assets/js/67.b550d647.js"><link rel="prefetch" href="/assets/js/68.68258f2e.js"><link rel="prefetch" href="/assets/js/69.9f502a69.js"><link rel="prefetch" href="/assets/js/7.159745e4.js"><link rel="prefetch" href="/assets/js/70.c9b2fe76.js"><link rel="prefetch" href="/assets/js/71.b7b04483.js"><link rel="prefetch" href="/assets/js/72.edb7dfe5.js"><link rel="prefetch" href="/assets/js/73.869de1e4.js"><link rel="prefetch" href="/assets/js/74.7816f275.js"><link rel="prefetch" href="/assets/js/75.0457b07c.js"><link rel="prefetch" href="/assets/js/76.79a2eaee.js"><link rel="prefetch" href="/assets/js/77.66cfa995.js"><link rel="prefetch" href="/assets/js/78.9dd75caf.js"><link rel="prefetch" href="/assets/js/79.f6111e69.js"><link rel="prefetch" href="/assets/js/8.b79c23ae.js"><link rel="prefetch" href="/assets/js/80.fff0a469.js"><link rel="prefetch" href="/assets/js/81.42c5ebec.js"><link rel="prefetch" href="/assets/js/82.ca2f7f18.js"><link rel="prefetch" href="/assets/js/83.ed547319.js"><link rel="prefetch" href="/assets/js/84.377155d9.js"><link rel="prefetch" href="/assets/js/85.e5aab871.js"><link rel="prefetch" href="/assets/js/86.14705636.js"><link rel="prefetch" href="/assets/js/87.502cb8e9.js"><link rel="prefetch" href="/assets/js/88.d8f271ec.js"><link rel="prefetch" href="/assets/js/89.3e9deca1.js"><link rel="prefetch" href="/assets/js/9.23c0899b.js"><link rel="prefetch" href="/assets/js/90.4de4929c.js"><link rel="prefetch" href="/assets/js/91.307ce9fd.js"><link rel="prefetch" href="/assets/js/92.47e69683.js"><link rel="prefetch" href="/assets/js/93.34abda4c.js"><link rel="prefetch" href="/assets/js/94.00078270.js"><link rel="prefetch" href="/assets/js/95.4c9ca2ce.js"><link rel="prefetch" href="/assets/js/96.9121392c.js"><link rel="prefetch" href="/assets/js/97.41f6bdb8.js"><link rel="prefetch" href="/assets/js/98.4524a102.js"><link rel="prefetch" href="/assets/js/99.7d313788.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4c1fe16c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-dad8a512><div data-v-dad8a512><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-dad8a512 data-v-dad8a512><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-dad8a512 data-v-dad8a512><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>Leibnize 个人学习笔记</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Leibnize 个人学习笔记</span>
            
          <!---->
          2020
        </a></span></div></div> <div class="hide" data-v-dad8a512><header class="navbar" data-v-dad8a512><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Leibnize 个人学习笔记</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Basics/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  基本
</a></div><div class="nav-item"><a href="/NetWork/" class="nav-link"><i class="iconfont undefined"></i>
  网络
</a></div><div class="nav-item"><a href="https://github.com/rjwx60" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-dad8a512></div> <aside class="sidebar" data-v-dad8a512><div class="personal-info-wrapper" data-v-ca798c94 data-v-dad8a512><!----> <h3 class="name" data-v-ca798c94>
    Leibnize 个人学习笔记
  </h3> <div class="num" data-v-ca798c94><div data-v-ca798c94><h3 data-v-ca798c94>0</h3> <h6 data-v-ca798c94>Article</h6></div> <div data-v-ca798c94><h3 data-v-ca798c94>0</h3> <h6 data-v-ca798c94>Tag</h6></div></div> <hr data-v-ca798c94></div> <nav class="nav-links"><div class="nav-item"><a href="/Basics/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  基本
</a></div><div class="nav-item"><a href="/NetWork/" class="nav-link"><i class="iconfont undefined"></i>
  网络
</a></div><div class="nav-item"><a href="https://github.com/rjwx60" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端专题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/01-前端基础" class="sidebar-heading clickable"><span>01-前端基本</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/02-前端性能" class="sidebar-heading clickable"><span>02-前端性能</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/03-前端工程" class="sidebar-heading clickable"><span>03-前端工程</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/04-前端异步" class="sidebar-heading clickable"><span>04-前端异步</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/05-前端设计" class="sidebar-heading clickable"><span>05-前端设计</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/06-前端数据" class="sidebar-heading clickable"><span>06-前端数据</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/07-前端安全" class="sidebar-heading clickable"><span>07-前端安全</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/08-前端概念" class="sidebar-heading clickable"><span>08-前端概念</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/09-前端实现" class="sidebar-heading clickable"><span>09-前端实现</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/10-前端新标" class="sidebar-heading clickable"><span>10-前端新标</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/11-前端会话" class="sidebar-heading clickable"><span>11-前端会话</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/12-前端框架" class="sidebar-heading clickable"><span>12-前端框架</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/14-浏览器相关" class="sidebar-heading clickable"><span>14-浏览器相关</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/15-前端核心" class="sidebar-heading clickable open"><span>15-前端核心</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Basics/15-前端核心/代码运行机制.html" class="sidebar-link">一、代码运行机制</a></li><li><a href="/Basics/15-前端核心/事件循环机制.html" class="sidebar-link">二、事件循环机制</a></li><li><a href="/Basics/15-前端核心/垃圾回收机制.html" class="sidebar-link">三、垃圾回收机制</a></li><li><a href="/Basics/15-前端核心/Summary.html" class="active sidebar-link">四、Summary</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/16-前端Node" class="sidebar-heading clickable"><span>16-前端Node</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-dad8a512><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e></h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Leibnize 个人学习笔记</span>
            
          <!---->
          2020
        </a></span></div></div> <div data-v-dad8a512><main class="page"><div class="page-title" style="display:none;"><h1>总结</h1> <div data-v-3b7f5bdf><i class="iconfont reco-account" data-v-3b7f5bdf><span data-v-3b7f5bdf>Leibnize 个人学习笔记</span></i> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default" style="display:none;"><h1 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h1> <p>例子太多，故篇幅会很长……</p> <h2 id="一、代码执行"><a href="#一、代码执行" class="header-anchor">#</a> 一、代码执行</h2> <p>包含：执行上下文、作用域链、变量对象、this确定、作用域、变量提升、闭包、执行栈等内容；实际上关系紧密但不深奥，从代码是如何在计算机内部执行(各种寄存器，加法器)的角度看会更容易理解；</p> <h3 id="_1-1、代码执行"><a href="#_1-1、代码执行" class="header-anchor">#</a> 1-1、代码执行</h3> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123716.png" align="" style="zoom:50%;"> <p><strong><u><em>1、从物理层面上看</em></u></strong>：JS 代码的执行，首先会通过 <u><strong>预解析-parser</strong></u> 检查语法错误；然后经过分词、语法/词法分析 <u><strong>生成AST</strong></u>；然后通过 <u>基线编译器-Ignition</u> 将其转换为 <u><strong>字节码</strong>(一种形如汇编码的码 Ldar a1 Add a0, [0]...，过去是直接生成机器码，但有内存占用问题)</u>；然后通过 <u>优化编译器-Turbofan</u> 将字节码转为 <strong><u>机器码</u></strong> (转换是通过执行字节码实现的，若某段代码经常被执行，则会被标记为 <u>热点代码-HotSpot</u> 并将其机器码缓存起来以便后续快速利用)；最后 <strong><u>执行</u></strong> 机器码；</p> <ul><li>注意：<strong><u>JS 并非纯粹的解释器语言，因为字节码不仅配合解释器，还有编译器的参与</u></strong>，而<u>两者根本区别</u>在于：前者会编译生成二进制文件，但后者不会；此外，这种字节码跟编译器、解释器结合的技术，称为 <strong><u>即时编译(JIT)</u></strong>；</li></ul> <p><strong><u><em>2、从逻辑层面上看</em></u></strong>：<u>在调用函数，执行函数代码前，会有两个阶段：内存分配的创建阶段、以及代码执行阶段；</u></p> <ul><li>注意：红宝石书的描述很含糊，强调函数调用时创建执行上下文但无进一步的细分；</li></ul> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123717.png" align="" style="zoom:50%;"> <ul><li><p><strong><u>创建阶段—CreationPhase</u></strong>：<strong>完成执行上下文/执行环境(执行代码时的运行环境)的创建，上下文的创建还包含以下对象的创建：</strong></p> <ul><li>2-1、<strong>作用域链 ScopeChain 的初始化：</strong> <ul><li>可理解为一个链表，而函数的 [[scope]] 指针指向此链表的头结点，可理解为作用域链对象存储在 [[scope]] 属性中，其复制外层函数 [[scope]] 属性中的对象，若嵌套越深，复制的对象越多；</li></ul></li> <li>2-2、<strong>变量对象 VO 的创建</strong>：此对象形成所有可访问变量，可理解为 <strong><u>作用域</u></strong> 实体，进入变量的生命周期(声明/初始化/定义)；
<ul><li>创建实参对象 (arguments object)</li> <li>检查 context 形参 (parameters)，初始化参数名和参数值，并创建一份引用拷贝；</li></ul></li></ul></li> <li><p>扫描 context 中函数声明：</p> <div class="language- extra-class"><pre><code>- 为每一函数在 VO 上创建属性，属性名即函数名，含有一个指向内存中函数的引用指针，进行声明/初始化/赋值操作；
</code></pre></div><ul><li>若函数名已存在，则此引用指针值将会被重写；
<ul><li>扫描 context 中变量声明：
<ul><li>为每一变量在 VO 上创建属性， 属性名即变量名：
<ul><li>若为 var 变量，则将变量值初始化为 undefined； 所以才会有 <strong><u>变量提升—Hoisting</u></strong> 的错觉；</li> <li>若为 let 变量，则不进行初始化；而在 let 真正被初始化前使用，即使用已声明但未初始化变量，则进入 TDZ 报错；xx is not defined</li></ul></li> <li>若变量名已存在：
<ul><li>若为 var 变量，则什么均不会发生，并继续扫描；</li> <li>若为 let 变量，则报错重复声明；</li></ul></li></ul></li></ul></li> <li>2-3、<strong>this 值的确定：</strong> <ul><li>所以说 <strong><u>this 指向在函数被调用时才发生绑定，this 指向最近的调用方(匿名函数除外)</u></strong>，</li></ul></li> <li>2-4、其他信息的创建：函数在哪被调用(调用栈)，函数的调用方法等；</li></ul></li></ul> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123718.png" align="" style="zoom:50%;"> <ul><li><strong><u>执行阶段—ExecutionPhase</u></strong>：执行上下文被推入 <strong><u>执行栈</u></strong>，运行/解释 执行上下文 中函数代码，并且根据代码一行一行的执行；
<ul><li>2-1、<strong>变量对象的转换</strong>：由 VO 转为 AO，实际乃同一对象不同时期的称呼；执行时发生变量的赋值也即定义操作；
<ul><li>若为 var 变量，则简单的定义操作；</li> <li>若为 let 变量，则进入变量的初始化，后续若有别的赋值操作则进行赋值操作；</li></ul></li> <li>2-2、<strong>作用域链的确定</strong>：上述的变量对象，在执行时被推入当下执行上下文的 ScopeChain 的前端：
<ul><li><strong><u>确定</u></strong>：创建阶段的作用域链—ScopeChain 复制了父级 [[scope]] 属性中的对象，也即复制了作用域链中的对象，而父级被创建时的作用域链对象，又复制了爷级的………所以此时的作用域链对象：由当前执行上下文的 AO、同所有外层已完成的激活对象组成，即包含：当前本地 VO(AO)—父级AO—爷级AO—……—全局AO；至此，作用域链被确定下来；</li> <li><strong><u>本质</u></strong>：作用域链的本质，即存放系列变量对象的指针列表；但注意，其存放的只是引用，而不包含实际变量对象的；</li> <li><strong><u>查询</u></strong>：此道工序保证了变量和函数的有序访问；即查找一个变量时，若当前变量对象(作用域)中未找到对应，则会通过作用域链，继续逐个向上查找(神似 node 模块的查找机制)；</li> <li><strong><u>循环</u></strong>：如果后续执行再遇函数调用，则再创建、初始、填充、为变量赋值、新一轮的函数创建-压栈执行；</li></ul></li></ul></li> <li><strong><u><em>执行完毕—FinshPhase</em></u></strong>：执行完毕，切换上下文，进行退栈操作；
<ul><li>注意：若退栈时，返回了函数或函数的引用，而函数包含了 [[scope]] 属性，即包含作用域链，就成为了 <u><strong>闭包</strong></u>；所以其可通过作用域链来访问系列上级函数中的变量；但同时因为引用被确定，执行栈虽然切换了上下文，但实际内存并未清除，容易导致内存泄露；</li></ul></li></ul> <p><strong><u><em>3、两个层面的区别</em></u></strong>：两个阶段并不冲突，个人认为：在生成字节码时，即进入逻辑层面上的内存分配阶段，包含变量对象、作用域链、this 对象等内容的生成；而在转换为机器码时，<strong><u>需要逐行执行字节码</u>，而这即进入 &quot;代码执行阶段——包含作用域链的完善、赋值操作等&quot;</strong>，最后才将机器码真正执行；</p> <h3 id="_1-2、其他内容再述"><a href="#_1-2、其他内容再述" class="header-anchor">#</a> 1-2、其他内容再述</h3> <p>详看前面内容；</p> <p><strong><u>执行上下文</u></strong>：个人认为其乃字节码执行时创建的隐式的对象，包含众多辅助代码执行的对象，比如变量对象、this、作用域链，为方便分析还分为几类：全局执行上下文、函数执行上下文、eval 函数执行上下文；</p> <p><strong><u>执行栈</u></strong>：执行上下文创建后，进入执行阶段，将执行上下文压栈执行；从机器码执行层面上看，更感觉是 ESP 指针移动，进入此对象的引用地址的区域执行代码；亦可理解为一个存储函数调用的栈结构；</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123737.png" align="" style="zoom:80%;"> <p><strong><u>闭包</u></strong>：一般情况下，在函数执行完毕并出栈时，函数内局部变量在下一个垃圾回收节点会被回收，该函数对应的执行上下文将会被销毁，这也正是在外界无法访问函数内定义的变量的原因；即只有在函数执行时，相关函数可以访问该变量，该变量在预编译阶段进行创建，在执行阶段进行激活，在函数执行完毕后，相关上下文被销毁；</p> <p>但非正常情况下，父级上下文返回了一个子函数，子函数内部的<code>[[scope]]</code>(指向作用域链) 中仍保留系列父级变量对象，因此可继续访问到父级的变量对象；这样函数或函数引用的变量称为闭包，因其保留着引用，所以执行上下文无法通过正常模式销毁，而作为活动对象长期存在，并从新生代提升至老生代，占用内存，容易导致内存泄露；</p> <p>闭包用于实现 OOP 的封装性(特权方法)、模块化、命名空间、函数工厂、延期执行等，实际上利用的是当前执行上下文的作用域链对象没有包含父级VO，变量查找不到==私有变量；注意：在定时器、事件监听、Ajax请求、跨窗口通信、Web Workers 或任何异步中，只要使用回调函数，实际上就是在使用闭包；</p> <p><strong><u><em>作用域及其查找</em></u></strong>：作用域其实就是变量对象的实体，作用域查找其实就是变量对象上的检索；但若当前 AO(VO) 找不到，就从 [[scope]] 指向的作用域链上的 AO 列表逐个查找，行为表现类似依据作用域链查找，而实际上是 VO 链表的查询；为便于分析，衍生为全局、函数作用域等概念；至于 <strong><u>块级作用域</u></strong>，个人觉得与创建变量对象时，变量生命周期有关，引擎限定了 let/const 在初始化-定义前不得使用，故存在 TDZ，存在块级作用域；</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 块级作用域示例</span>
<span class="token comment">// Ex1</span>
<span class="token keyword">let</span> xx <span class="token operator">=</span> yyy
<span class="token comment">// Uncaught ReferenceError: yyy is not defined</span>

<span class="token comment">// Ex2</span>
<span class="token comment">// 注意: 除了块级作用域以外，函数参数默认值也会受到 TDZ 影响；</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">arg1 <span class="token operator">=</span> arg2<span class="token punctuation">,</span> arg2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token comment">// Uncaught ReferenceError: arg2 is not defined</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token string">'arg2'</span><span class="token punctuation">)</span>  
<span class="token comment">// 将函数参数默认值区域也想象成为一个 TDZ 范围会比较容易理解</span>
<span class="token comment">// 即 arg2 虽然已经声明但未初始化-定义，在执行阶段 arg1 的初始化时，寻找 arg2 就会报错</span>
                                 
<span class="token comment">// Ex3</span>
<span class="token comment">// 至于为何下面传入 null 没有报错是因为前者传 undefined 相当于不传值，使用 arg2，后者则替代了 arg2 避免了出错</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">arg1 <span class="token operator">=</span> arg2<span class="token punctuation">,</span> arg2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'arg2'</span><span class="token punctuation">)</span> <span class="token comment">// null arg2</span>
</code></pre></div><p><strong><u>变量提升</u></strong>：变量对象创建的衍生概念，即开始进入变量的生命周期的系列现象：声明(Declaration)、初始化(Initialization) 与赋值(Assignment)；</p> <ul><li><p>Var：在内存分配阶段，进行变量的创建-声明与初始化-定义，最后在代码执行阶段进行赋值操作；</p></li> <li><p>Function：在内存分配阶段就已经完成三个变量周期；同名情况下，比 Var 优先级高；</p></li> <li><p>Let：在内存分配阶段仅完成变量的创建-声明，并未初始化-定义，只有在执行阶段的 let x = xxx 时才进行首次初始化-定义，若后续还有操作才是赋值行为；所以，在 let x = xx 前就使用就会报错：x is not define，即 TDZ—未初始化-定义前不准使用变量；</p></li> <li><p>Const：在代码执行阶段进行创建-声明与初始化-定义，没有赋值行为；</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Ex1</span>
<span class="token keyword">var</span> liList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span> <span class="token comment">// 共5个li</span>
<span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>liList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  liList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Ex2</span>
<span class="token keyword">var</span> liList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span> <span class="token comment">// 共5个li</span>
<span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>liList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  liList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// for( let i = 0; i&lt; 5; i++) 这句话的圆括号之间，有一个隐藏的作用域</span>
<span class="token comment">// for( let i = 0; i&lt; 5; i++) { 循环体 } 在每次执行循环体之前，JS 引擎会把 i 在循环体的上下文中重新声明及初始化一次</span>

<span class="token comment">// Ex3</span>
<span class="token keyword">var</span> liList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span> <span class="token comment">// 共5个li</span>
<span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>liList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// let i = 隐藏作用域中的i </span>
  <span class="token comment">// 5 次循环，就会有 5 个不同的 i，console.log 出来的 i 当然也是不同的值</span>
  liList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意：变量提升只对 var 命令声明的变量有效，若一变量不是用 var 命令声明的，就不会发生变量提升：其实变量提升概念模糊，标准协会内部也存在争议，但更倾向于创建阶段变量的处理；</p> <p>注意：函数表达式也会提升，但作为普通变量提升，而非函数提升；而同名函数和变量同存时，函数优先，变量延后提升，相当于变量会覆盖函数声明；</p> <h3 id="_1-3、作用域查找"><a href="#_1-3、作用域查找" class="header-anchor">#</a> 1-3、作用域查找</h3> <p>万变不离其宗——VO 对象的值的查找—&gt;[父级VO集合]上的值的查找</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// setTimeout 宏任务, JS 单线程、 EvLoop 机制，在主线程同步任务执行完后才去执行宏任务，此时循环已结束，i 也已变成 6；</span>
<span class="token comment">// loop 结束后, setTimeout 依次执行回调，但输出时在当前变量对象无 i，遂通过作用域链向上寻找 i, 因此会全部输出6；</span>


<span class="token comment">// 解决1</span>
<span class="token comment">// 利用 IIFE，使得每次 for 均创建不一样的 VO(每 VO 含有不一样的 j——虽然同名)，但注意到均包含父级 VO，均能找到 a</span>
<span class="token comment">// 输出 5 个 6，1-5</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">j</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 解决2</span>
<span class="token comment">// 给定时器传入第三个参数, 与 IIFE 原理类似，创建单独的 VO，但注意到均包含父级 VO，均能找到 i</span>
<span class="token comment">// 输出 5 个 6，1-5</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token parameter">j</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token parameter">j</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token comment">// 解决3</span>
<span class="token comment">// 使用块级作用域 let 使 JS 发生革命性的变化，让 JS 有函数作用域变为块级作用域</span>
<span class="token comment">// 原理其实还是一样，利用 VO 的查找层级</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// babel 转译后结果</span>
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">_loop</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">_loop</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">_loop</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 加个 const 怎么样</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// babel 转译后结果</span>
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">_loop</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">_loop</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 啊哈</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">_loop</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123746.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 前面考虑的是多个子函数的 ScopeChain 包含的 父级 VO 是一样的，所以输出为：undefined 0 0 0 </span>
<span class="token comment">// 中间考虑的是嵌套子函数的 VO 查找，单纯考你思维性，输出为：undefined 0 1 2</span>
<span class="token comment">// 后面就是上面的多个利用，无他，输出为：undefined 0 1 1</span>
</code></pre></div><h3 id="_1-4、this指向"><a href="#_1-4、this指向" class="header-anchor">#</a> 1-4、this指向</h3> <p>其实 this 指向不难，在函数调用时确定，除了箭头函数的引擎特殊处理外的类型外，其他修改 this 执行的行为，比如 apply、call，无外乎进行多一次的函数创建操作，重新为 this 指向赋值；而 new 内部，也有这种操作，且更为间接和隐秘，故优先级也最高；但理论与实际是存在差异的，this 不难，也不能说完全不难，其难就难在复杂的多种情况下的 this 指向确定；</p> <p><strong><u>this 值</u></strong>，在上下文创建时的 this 确定，即外层调用，而 call/apply/bind 形式的调用是重新进行了一次执行上下文创建过程，修改调用主体，修改 this 确定；</p> <ul><li><p>默认绑定：this 指向全局对象，严格模式指向 undefined；</p> <ul><li>注意，非严格模式下，var 默认绑定到 window，可通过 this 获取，但 let/const 不会绑定到 window；</li> <li>注意，赋值操作，因赋值后的调用又创建了一次上下文，又进行了一次 this 确定；</li> <li>注意，虽然严格模式下，函数体内 this 指向 undefeind，但在全局环境的 this 还是会指向 window 无报错…</li></ul></li> <li><p>隐式绑定：即对象点方法的形式调用；</p> <ul><li>注意，赋值操作，因赋值后的调用又创建了一次上下文，又进行了一次 this 确定；</li> <li>注意：赋值操作并不限于等号/冒号/传参/逗号操作符；</li></ul></li> <li><p>显式绑定：即 call/apply(obj, ...) 绑定，意为：在 obj 中使用 function；在对象上强制调用函数，直接指定 this 绑定对象；</p> <ul><li>注意：一参是：空/null/undefined，则效果与不传参数一致(占位、普通调用)</li> <li>注意：从 this 绑定角度上看，两者本质相同，区别在参数2，前者数组形式传入，后者元素形式传入；</li></ul></li> <li><p>显式硬绑：显式绑定的变种 (本质是：在显式绑定的基础上用一层函数包裹)</p> <ul><li>无法再次修改 this 指向，除非 new 操作</li> <li>bind 会判断硬绑定函数，是否是被 new 调用，若是则使用 new 操作中新创建的 this 替换硬绑定的 this (确保 new 最高优先)</li></ul></li> <li><p>new 绑定：构造函数中的 this 指向实例对象；个人理解为内部做了一层无法改变的 this 绑定；</p> <ul><li><p>1、创建一个新的对象；2、将构造函数的 <code>this</code> 指向这个新对象；3、为这个对象添加属性、方法等；4、最终返回新对象；</p></li> <li><p>注意：若在构造函数中出现了显式 <code>return</code> 的情况</p> <ul><li><p>若构造函数中显式返回一个值，且返回的是对象，则 <code>this</code> 就指向这个返回的对象；</p></li> <li><p>若构造函数中显式返回一个值，且返回的非对象，则 <code>this</code> 仍然指向实例；</p></li> <li><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 返回对象</span>
<span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token string">&quot;TLP&quot;</span>
    <span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> o
<span class="token punctuation">}</span>
<span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token comment">// undefined</span>

<span class="token comment">// 返回非对象</span>
<span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token string">&quot;TLP&quot;</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token comment">// TLP</span>
</code></pre></div></li></ul></li></ul></li> <li><p>特殊：DOM 事件绑定：onclick 和  addEventerListener中 this 默认指向绑定事件的元素；</p></li> <li><p>特殊：箭头函数，根据外层上下文绑定的 <code>this</code> 决定 <code>this</code> 指向；</p></li> <li><p>特殊：匿名函数：默认指向全局对象，严格模式指向 undefined；比如 setTimeout、匿名函数的赋值调用而非对象点方法调用；</p></li> <li><p>注意：赋值操作(=/:/传参/)+匿名函数-&gt; 全局环境下调用匿名函数(个人认为是因为赋值的是一个地址引用，最后调用时，凭空创建上下文，this 默认绑定全局)</p></li></ul> <p><strong><u>this 指向绑定优先级</u></strong>：默认绑定 &lt; 隐式绑定 &lt; 显式绑定 &lt; 显式硬绑定 &lt; new 绑定；以及判断 this 绑定位置：</p> <ol><li>函数是否在 new 中调用(new 绑定)？如果是的话 this 绑定的是，新创建的对象；var bar = new foo()</li> <li>函数是否通过 call、apply(显式绑定)或者 bind (显示硬绑定)调用？如果是的话this 绑定的是，指定的对象；var bar = foo.call(obj2)</li> <li>函数是否在某个上下文对象中调用(隐式绑定)？如果是的话this 绑定的是，那个上下文对象；var bar = obj1.foo()</li> <li>若都不是的话，使用默认绑定。严格模式下，就绑定到 undefined，否则绑定到，全局对象；var bar = foo()</li></ol> <p>注意：箭头函数不遵从上述规则，其 this 的指向 根据外层(函数或者全局)作用域来决定，且这种绑定无法被修改，常用于回调中；</p> <p>注意：箭头函数使用了词法作用域取代传统的 this 机制，同 self = this 机制一致；</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200913134636.png" alt="截屏2020-09-13 下午1.46.33" style="zoom:50%;"> <h3 id="_1-5、this-示例"><a href="#_1-5、this-示例" class="header-anchor">#</a> 1-5、this 示例</h3> <p>万变不离其宗：调用，创建上下文，this 指向 确定——即调用即确定；注意匿名、注意赋值操作(=或:)(实际上还是通过调用即指向)；</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1、默认绑定</span>
<span class="token comment">// 1、默认绑定</span>
<span class="token comment">// 1、默认绑定</span>
<span class="token comment">// Ex1</span>
<span class="token comment">// 匿名函数实际上还是走那个形式，只不过它因为是宏任务，先交给浏览器 WebAPI, 完成计时后放入队列，等真正执行时是 window 执行</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'tlp'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">fun1</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">fun2</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fun1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// TypeError: fun1 is not a function &quot;undefined&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token comment">// 2、隐式绑定</span>
<span class="token comment">// 2、隐式绑定</span>
<span class="token comment">// 2、隐式绑定</span>
<span class="token comment">// Ex1</span>
<span class="token keyword">function</span> <span class="token function">foo</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> foo <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> foo2 <span class="token operator">=</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> foo2<span class="token operator">:</span> obj<span class="token punctuation">.</span>foo <span class="token punctuation">}</span>

obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">// 1 隐式绑定；调用者为 obj 没毛病</span>
<span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 			<span class="token comment">// 2 隐式丢失，赋值方式-等号；赋值后，调用时，上下文，this 为 window	 </span>
obj2<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">// 3 隐式丢失，赋值方式-冒号；foo2: obj.foo 乃赋值的另一种形式，所以最后调用者为 obj2 </span>


<span class="token comment">// Ex2</span>
<span class="token keyword">function</span> <span class="token function">foo</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">doFoo</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// window</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> foo <span class="token punctuation">}</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span>
<span class="token function">doFoo</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span> <span class="token comment">// 2	隐式丢失，赋值方式-传参；参数传参也是赋值操作，随后 doFoo 创建上下文时，this 为 window</span>


<span class="token comment">// Ex3</span>
<span class="token keyword">function</span> <span class="token function">foo</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">doFoo</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// obj2</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span> <span class="token comment">// 3</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> foo <span class="token punctuation">}</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> doFoo <span class="token punctuation">}</span>
obj2<span class="token punctuation">.</span><span class="token function">doFoo</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span> <span class="token comment">// 2 隐式丢失，赋值方式-传参；</span>
<span class="token comment">// 迷惑题，但本质还是一样，虽然 obj2.doFoo 形式，让 doFoo this 指向 obj2, 但 fn 调用时，采取的是变量对象寻值的方式!!</span>


<span class="token comment">// Ex4</span>
<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span>
  x<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
  <span class="token function-variable function">bar</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>foo<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>foo<span class="token punctuation">.</span>bar <span class="token operator">=</span> foo<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>foo<span class="token punctuation">.</span>bar<span class="token punctuation">,</span> foo<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 隐式丢失，赋值方式-等号/逗号操作符；20 20 10 10 </span>


<span class="token comment">// Ex5</span>
<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span>
  x<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  baz<span class="token operator">:</span> <span class="token punctuation">{</span>
    x<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token function-variable function">bar</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> go <span class="token operator">=</span> foo<span class="token punctuation">.</span>baz<span class="token punctuation">.</span>bar<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 3</span>
<span class="token comment">// 隐式丢失，赋值方式-等号</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>baz<span class="token punctuation">.</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
<span class="token comment">// 指向最后</span>



<span class="token comment">// 3、显式绑定</span>
<span class="token comment">// 3、显式绑定</span>
<span class="token comment">// 3、显式绑定</span>
<span class="token comment">// Ex1</span>
<span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo1</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo2</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment">// 注意：不能是 obj2.foo2.call(obj1) 写法，否则改变 this 为 foo1 环境，但内部计时器存在仍会指向 window</span>
    <span class="token comment">// 相当于为匿名函数的作用域链增加 obj1 的变量对象，好让其搜索得到变量</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span>
obj2<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
obj2<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// obj1 1 改变的不是匿名函数，而是匿名的回调</span>


<span class="token comment">// Ex2</span>
<span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo1</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo2</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">inner</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span>
obj2<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
obj2<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// window 3  若 inner.call(obj1) 则 obj1 1</span>
<span class="token comment">// 迷惑题，obj2.foo2 是隐式绑定，但执行 inner 时，就变为默认绑定了!!! </span>


<span class="token comment">// Ex3</span>
<span class="token keyword">function</span> <span class="token function">foo</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 					<span class="token comment">// 2</span>
<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> 	<span class="token comment">// function point</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token comment">// 2 function point</span>
<span class="token comment">// 考察 bind 返回值形式</span>


<span class="token comment">// Ex4</span>
<span class="token keyword">function</span> <span class="token function">foo</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token operator">:</span> <span class="token string">'obj'</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">'window'</span>
<span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token comment">// arr.forEach(foo, obj)</span>
<span class="token comment">// arr.map(foo, obj)</span>
arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1 'obj'</span>
  <span class="token comment">// 2 'obj'</span>
 	<span class="token comment">// 3 'obj'</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span>
  <span class="token keyword">return</span> i <span class="token operator">&gt;</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span> 
<span class="token comment">// forEach、map、filter 函数的第二个参数也是能显式绑定 this</span>


<span class="token comment">// Ex5</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    b <span class="token operator">=</span> b <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span>
obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// 3 + 2 + 1 == 6 </span>
obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
<span class="token comment">// 2 + 3 + 1 == 6</span>
<span class="token comment">// 综合考察传参、默认绑定、隐式绑定、闭包</span>






<span class="token comment">// 4、显示硬绑</span>
<span class="token comment">// 4、显示硬绑</span>
<span class="token comment">// 4、显示硬绑</span>






<span class="token comment">// 5、new 绑定</span>
<span class="token comment">// 5、new 绑定</span>
<span class="token comment">// 5、new 绑定</span>
<span class="token comment">// Ex1</span>
<span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'window'</span>
<span class="token keyword">function</span> <span class="token function">Person</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'person1'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'person2'</span><span class="token punctuation">)</span>
person1<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// person2 window </span>
<span class="token comment">// 最后返回匿名函数并在 window 下调用，除非改变匿名绑定</span>
person1<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">// person1 person2 </span>


<span class="token comment">// Ex2</span>
<span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Foo<span class="token punctuation">.</span><span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token class-name">Foo</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
Foo<span class="token punctuation">.</span><span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
Foo<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
obj<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
Foo<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>






<span class="token comment">// 6、箭头函数</span>
<span class="token comment">// 6、箭头函数</span>
<span class="token comment">// 6、箭头函数</span>
<span class="token comment">// Ex1</span>
<span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'window'</span>
<span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'obj1'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'obj2'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> obj3 <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'obj3'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> obj4 <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'obj4'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
obj1<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// obj1 window</span>
obj2<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// obj2 obj2</span>
obj3<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// window window</span>
obj4<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// window window</span>
<span class="token comment">// 箭头函数指向外层，但并非指对象中的层级，而是以函数为层级区分，其中的 foo 与 name 是同层的, 所以最终指向 window</span>
<span class="token comment">// 即字面量创建的对象，作用域是 window，若里面有箭头函数属性的话，this 指向的是 window</span>



<span class="token comment">// Ex2</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'obj'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo1</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo2</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'window'</span>
obj<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// window 注意: window.obj.foo1 故应为 window</span>
obj<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// obj obj</span>




<span class="token comment">// Ex3</span>
<span class="token comment">// 箭头函数的 this 无法通过 bind、call、apply 来直接修改，但可通过改变作用域中 this 的指向来间接修改</span>
<span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'window'</span>
<span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'obj1'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo1</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo2</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'obj2'</span>
<span class="token punctuation">}</span>
obj1<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// obj2 obj2</span>
obj1<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span> <span class="token comment">// obj1 obj1</span>
obj1<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// window window</span>
obj1<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span> <span class="token comment">// window obj2</span>
<span class="token comment">// 箭头函数里面的 this 是由外层作用域来决定的，且指向函数定义时的 this 而非执行时</span>
<span class="token comment">// 箭头函数的 this 无法通过 bind、call、apply 来直接修改，但可通过改变作用域中 this 的指向来间接修改</span>



<span class="token comment">// Ex4</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">123</span>
<span class="token keyword">const</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">a</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">bar</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 123</span>




<span class="token comment">// 7、匿名函数永远指向 window</span>
<span class="token comment">// 7、匿名函数永远指向 window</span>
<span class="token comment">// 7、匿名函数永远指向 window</span>






<span class="token comment">// 综合示例</span>
<span class="token keyword">const</span> o1 <span class="token operator">=</span> <span class="token punctuation">{</span>
    text<span class="token operator">:</span> <span class="token string">'o1'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>text
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> o2 <span class="token operator">=</span> <span class="token punctuation">{</span>
    text<span class="token operator">:</span> <span class="token string">'o2'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> o1<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> o3 <span class="token operator">=</span> <span class="token punctuation">{</span>
    text<span class="token operator">:</span> <span class="token string">'o3'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> fn <span class="token operator">=</span> o1<span class="token punctuation">.</span>fn
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>o1<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// o1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>o2<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// o1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>o3<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>




<span class="token comment">// 综合示例2：字面量对象中的各种场景</span>
<span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'window'</span>
<span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'person1'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo1</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo2</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo3</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">foo4</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'person2'</span> <span class="token punctuation">}</span>

person1<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// person1</span>
person1<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">// person2</span>

person1<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// window</span>
person1<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">// window</span>

person1<span class="token punctuation">.</span><span class="token function">foo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// window</span>
person1<span class="token punctuation">.</span><span class="token function">foo3</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// window</span>
person1<span class="token punctuation">.</span><span class="token function">foo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">// person2</span>

person1<span class="token punctuation">.</span><span class="token function">foo4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// person1</span>
person1<span class="token punctuation">.</span><span class="token function">foo4</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// person2</span>
person1<span class="token punctuation">.</span><span class="token function">foo4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">// person1</span>




<span class="token comment">// 综合示例3：构造函数中的各种场景</span>
<span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'window'</span>
<span class="token keyword">function</span> <span class="token function">Person</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">foo1</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">foo2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">foo3</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">foo4</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'person1'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'person2'</span><span class="token punctuation">)</span>

person1<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// person1</span>
person1<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">// person2</span>

person1<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// person1</span>
person1<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">// person1</span>

person1<span class="token punctuation">.</span><span class="token function">foo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// window</span>
person1<span class="token punctuation">.</span><span class="token function">foo3</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// window</span>
person1<span class="token punctuation">.</span><span class="token function">foo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">// person2</span>

person1<span class="token punctuation">.</span><span class="token function">foo4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// person1</span>
person1<span class="token punctuation">.</span><span class="token function">foo4</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// person2</span>
person1<span class="token punctuation">.</span><span class="token function">foo4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">// person1</span>




<span class="token comment">// 综合示例4:</span>
<span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'window'</span>
<span class="token keyword">function</span> <span class="token function">Person</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token keyword">this</span><span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'obj'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">foo1</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">foo2</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'person1'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">'person2'</span><span class="token punctuation">)</span>

person1<span class="token punctuation">.</span>obj<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// window</span>
person1<span class="token punctuation">.</span>obj<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// window</span>
person1<span class="token punctuation">.</span>obj<span class="token punctuation">.</span><span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">// person2</span>

person1<span class="token punctuation">.</span>obj<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// obj</span>
person1<span class="token punctuation">.</span>obj<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// person2</span>
person1<span class="token punctuation">.</span>obj<span class="token punctuation">.</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">// obj</span>




<span class="token comment">// 综合示例5</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="二、eventloop"><a href="#二、eventloop" class="header-anchor">#</a> 二、EventLoop</h2> <p>大体就是，JS引擎通过将一个一个执行上下文放入执行栈依次执行，若遇到微任务则将其放入当前的微任务队列中，若遇到宏任务则将其交由事件触发线程管理的宏任务队列中；当栈内所有内容执行完毕，则将微任务队列中的内容放入执行栈执行；当这个也执行完毕，则进行 UI 渲染(实际上发生的内容还有很多，见下方)，然后从事件触发线程处获取下一个宏任务，存入栈并执行；循环往复；</p> <ul><li>首先，当执行完微任务后，会判断 <code>document</code> 是否需要更新，因为浏览器是 60Hz 的刷新率，每 16.6ms 才会更新一次；</li> <li>然后，判断是否有 <code>resize</code> 或 <code>scroll</code> 事件，有则触发，故两事件也是至少 16ms 才会触发一次，且自带节流功能；</li> <li>然后，判断是否触发了 media query；</li> <li>然后，更新动画并且发送事件；</li> <li>然后，判断是否有全屏操作事件；</li> <li>然后，执行 <code>requestAnimationFrame</code> 回调(主线程之外)；</li> <li>然后，执行 <code>IntersectionObserver</code> 回调，该方法用于判断元素是否可见，可用于懒加载，但兼容性不好；</li> <li>最后，更新界面(宏任务)；</li> <li>注意：以上是一帧中可能会做的事情；若在一帧中有空闲时间，就会去执行 <code>requestIdleCallback</code> 回调；<a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model" target="_blank" rel="noopener noreferrer">详看<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="_2-1、eventloop"><a href="#_2-1、eventloop" class="header-anchor">#</a> 2-1、EventLoop</h3> <p>浏览器包含诸多线程：Browser进程(浏览器的主进程)、三方插件进程、GPU进程等，其中 GPU 进程包含以下线程：</p> <ul><li><strong>JS引擎线程</strong> <ul><li>注意：GUI渲染线程、JS引擎线程互斥，为防止DOM渲染不一致性，其中一线程执行时另一线程会被挂起，脚本置底</li></ul></li> <li><strong>GUI渲染线程</strong> <ul><li>负责 UI 渲染；</li></ul></li> <li><strong>事件触发线程</strong> <ul><li>与 EventLoop 密切相关；</li></ul></li> <li><strong>定时触发器线程</strong></li> <li><strong>异步HTTP请求线程</strong> <ul><li>配合 Browser 主线程与跨域拦截相关；</li></ul></li></ul> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123824.png" align="" style="zoom:40%;"> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123825.png" align="" style="zoom:40%;"> <p><strong><u><em>浏览器页面初次渲染完毕后，JS引擎线程结合事件触发线程的工作流程如下(事件循环机制)：</em></u></strong></p> <ul><li>首先，JS 引擎线程执行 JS 代码，将整段脚本作为首个 <strong>宏任务</strong> 执行；即将执行上下文推入执行栈依次执行</li> <li>然后，代码直接执行过程中，若发现<strong>新的宏任务</strong> 交由事件触发线程管理(推入宏任务队列)，<strong>微任务</strong> 则推入事件触发线程的微任务队列；</li> <li>然后，当前宏任务执行完全，执行栈为空，检查微任务队列，若有则依次执行，直到微任务队列为空；若此时遇到新的宏任务，则将其再次移交事件触发线程管理，<strong><u>若遇到新的微任务，则将其推入事件触发线程的新的微任务队列中，并在执行栈内容执行为空后再去执行；</u></strong></li> <li>然后，执行浏览器 UI 线程的渲染工作；</li> <li>然后，检查是否有 Webworker 任务，有则执行；</li> <li>最后，从事件触发线程获取队首新的宏任务并执行，回到第二步，依此循环，直到宏任务和微任务队列都为空；</li> <li>注意：垃圾回收通过增量标记发生在上述过程的间隙中；</li> <li>所以：浏览器 EventLoop 按：宏-微-其他(UI/WebWorker/rAF/Else)-宏-微…次序执行；</li></ul> <p><strong><u><em>宏任务(macrotask—task)、微任务(microtask—jobs) 由来：</em></u></strong></p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200913140611.png" alt="截屏2020-09-13 下午2.06.08" style="zoom:50%;"> <p><strong><u><em>宏任务(macrotask—task)、微任务(microtask—jobs) 分类：</em></u></strong></p> <ul><li><strong>宏任务</strong>：script (主代码块)、<code>setTimeout</code> 、<code>setInterval</code> 、<code>setImmediate</code> 、I/O 、UI rendering、WebWorker；
<ul><li>注意：并非所有均为异步；</li></ul></li> <li><strong>微任务</strong>：process.nextTick、Promises.then/reject-catch-finally、Object.observe、MutationObserver、以 Promise 为基础开发的其他技术(比如 fetch API)、<u>V8 的垃圾回收过程</u>等；
<ul><li>注意：宏微任务由来：</li></ul></li></ul> <p><strong><u><em>宏任务(macrotask—task)、微任务(microtask—jobs) 区别：</em></u></strong></p> <ul><li>宏任务：由事件触发线程来维护，执行栈中首次执行或从事件触发线程的事件队列中获取的任务；
<ul><li>浏览器为使 JS引擎线程与GUI渲染线程有序切换，会在当前宏任务结束后，下一宏任务执行开始前，对页面进行重新渲染；</li> <li>当前宏任务执行后，会将在它执行期间产生的所有微任务都执行一遍，但嵌套更深的微任务不予处理；</li></ul></li> <li>微任务：同由事件触发线程维护；当前宏任务执行结束后立即执行的任务，在 UI渲染前执行；</li></ul> <h3 id="_2-2、eventlooop-示例"><a href="#_2-2、eventlooop-示例" class="header-anchor">#</a> 2-2、EventLooop 示例</h3> <ul><li>代码考察的话不考虑 UI 等内容，而只按照：宏-微-宏-微次序执行，但若有 rAF，则须考虑回调的执行；</li> <li>await 处理关键：将 await 同行代码化为 new Promise 内容(同步)，将 await 后行内容化为 promise.then 内容即可</li> <li>new Promise 相当于同步任务，会立即执行；</li> <li>内里 return new Promise 处理：相当于回归链式调用，由上往下执行；</li> <li>嵌套 promise 处理关键：厘清微任务，执行顺序还是宏微宏微，若无宏任务，则连续执行微任务，<strong><u>但执行顺序是按加入微任务队列的先后执行的</u></strong>；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Ex1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1t1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1t2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'se'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ss se p1t1 p1t2 setTimeout</span>
<span class="token comment">// 宏 script -&gt; 微 promise1 2，-&gt; 宏 setTimeout</span>



<span class="token comment">// Ex2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1t1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1t2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p2t1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p2t2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'se'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ss se p1t1 p2t1 p1t2 p2t2 setTimeout</span>
<span class="token comment">// 注意: 链式调用并非链式添加微任务，每当添加完后就离开执行外面内容，而非一直链式添加微任务队列</span>



<span class="token comment">// Ex3</span>
<span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 16</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">// 执行时发现微任务 3-p1t1，塞入微任务队列1</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 3</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1t1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行时发现微任务 5-p1t2，塞入微任务队列2</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 5</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1t2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行时发现微任务 7-p1t3，塞入微任务队列3</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 7</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1t3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行时发现微任务 10-p1t3-t1，塞入微任务队列4</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 10</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1t3-t1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行时发现微任务 12-p1t3-t1-t1，塞入微任务队列5</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 12</span>
    	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1t3-t1-t1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 执行时发现微任务 13-p1t3-t2，塞入微任务队列5</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 13</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1t3-t2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 执行时发现微任务 4-p2t1，塞入微任务队列1</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 4</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p2t1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行时发现微任务 6-p2t2，塞入微任务队列2</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 6</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p2t2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行时发现微任务 8-p2t2-t1，塞入微任务队列3</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 8</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p2t2-t1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行时发现微任务 11-p2t2-t2，塞入微任务队列4</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 11</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p2t2-t2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行时发现微任务 14-p2t2-t2-t1，塞入微任务队列5</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 14</span>
    	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p2t2-t2-t1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 执行时发现微任务 15-p2t2-t2-t1-t1，塞入微任务队列6</span>
      Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 15</span>
    		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p2t2-t2-t1-t1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  		<span class="token punctuation">}</span><span class="token punctuation">)</span>
  	<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 执行时发现微任务 9-p2t3，塞入微任务队列3</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 9</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p2t3'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'se'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ss</span>
<span class="token comment">// se</span>
<span class="token comment">// p1t1</span>
<span class="token comment">// p2t1</span>
<span class="token comment">// p1t2</span>
<span class="token comment">// p2t2</span>
<span class="token comment">// p1t3</span>
<span class="token comment">// p2t2-t1</span>
<span class="token comment">// p2t3</span>
<span class="token comment">// p1t3-t1</span>
<span class="token comment">// p2t2-t2</span>
<span class="token comment">// p1t3-t1-t1</span>
<span class="token comment">// p1t3-t2</span>
<span class="token comment">// p2t2-t2-t1</span>
<span class="token comment">// p2t2-t2-t1-t1</span>
<span class="token comment">// setTimeout</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123847.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 先宏任务124 -&gt; 再微任务then-53 -&gt; 再宏任务6</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123848.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1 8(宏) 3 4 5 7(微) 2(宏) 6(宏)</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123849.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// click(宏) promise(微) mutate(微) click(宏) promise(微) mutate(微) timeout(宏) timeout(宏)</span>
<span class="token comment">// 相当于两个 onClick 事件函数展开，mutationOb 是微任务</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123850.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1 3 5(宏) 4(微) 2(宏)</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123851.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// &quot;马上..、代码...&quot;(宏) &quot;then&quot;(微) &quot;定时器&quot;(宏)</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123852.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 2 3 5(宏) 4(微) 1(宏)</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123853.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1 10(宏) 5 8 7 9(微-注意顺序) 2(宏) 3 4(微) 6(宏) </span>
<span class="token comment">// 执行微任务遇到微任务，先塞入队列，注意顺序</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123834.png" align="" style="zoom:50%;"> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123835.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async111</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">async2222</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2222</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2 end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">async111</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise'</span><span class="token punctuation">)</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span>
<span class="token comment">// script start =&gt; async2 end =&gt; Promise =&gt; script end =&gt; async1 end =&gt; promise1 =&gt; promise2 =&gt; setTimeout</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123836.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// scriptStart =&gt; async1Start =&gt; async2 =&gt; promise1 =&gt; scriptEnd =&gt; async1End =&gt; promise2 =&gt; setTimeout</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123837.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// scriptStart =&gt; async1Start =&gt; promise1 =&gt; promise3 =&gt; scriptEnd =&gt; promise2 =&gt; async1End(注意顺序) =&gt; promise4 =&gt; setTimeout</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123838.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// scriptStart =&gt; async1Start =&gt; promise1 =&gt; scriptEnd =&gt; promise2 =&gt; setTimeout3 =&gt; setTimeout2 =&gt; setTimeout1</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123839.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// scriptStart =&gt; a1Start =&gt; a2 =&gt; promise2 =&gt; scriptEnd =&gt; promise1 =&gt; a1End =&gt; promise2Then =&gt; promise3 =&gt; setTimeout</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123840.png" align="" style="zoom:50%;"> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123841.png" align="" style="zoom:50%;"> <p>比如：上图一轮：promise1 后只有 then 微任务，遂进入 then 执行，输出 then11 和 promise2，随后发现 2 个微任务：一个是里面的 then，一个是外面的 then，然后执行…</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123842.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// promise1 =&gt; then11 =&gt; promise2 =&gt; then21 =&gt; then12 =&gt; then23</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123843.png" align="" style="zoom:50%;"> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123844.png" align="" style="zoom:50%;"> <div class="language- extra-class"><pre class="language-text"><code>// promise1 =&gt; promise3 =&gt; then11 =&gt; promise2 =&gt; then31 =&gt; then21 =&gt; then12 =&gt; then23
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123845.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1 2 3 4 5 6 7 8 9</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123846.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// promise1 =&gt; then11 =&gt; promise2 =&gt; then21 =&gt; then23 =&gt; then12</span>
</code></pre></div><h3 id="_2-3、nodeevloop"><a href="#_2-3、nodeevloop" class="header-anchor">#</a> 2-3、NodeEvLoop</h3> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123826.png" align="" style="zoom:50%;"> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123827.png" style="zoom:50%;"> <p><strong><u><em>一、宏任务 macrotask 执行情况(繁琐)：</em></u></strong></p> <p><strong><u>1、timer 阶段</u></strong>：检查定时器诸如 setTimeout、setInterval，若到时间，就执行回调；</p> <ul><li><strong><u>注意，此阶段由 poll 阶段控制；</u></strong></li></ul> <p><strong><u>2、I/O 异常回调阶段</u></strong>：处理上一轮循环中的 <u>少数未执行</u> 的 I/O 回调，比如 TCP 连接遇到 ECONNREFUSED，就会在此时执行回调；</p> <p><strong><u>3、空闲、预备状态</u></strong>：第 2 阶段结束，poll 阶段未触发之前；</p> <p><strong><u>4、poll 阶段</u></strong>：此阶段会做两件事：</p> <ul><li>4-1、回到 timer 阶段执行回调；</li> <li>4-2、执行 I/O 回调；具体做法是：
<ul><li>若存在定时器，且 poll callback 函数队列为空，且有定时器到达时间，EvLoop 回到  <strong><u>timer 阶段</u></strong>(拿出到时定时器回调执行)；</li> <li>若不存在定时器, 则查看 poll callback 函数队列；
<ul><li>若队列不为空，便遍历 poll callback 队列并同步执行，直到队列为空或者达到系统限制；
<ul><li><strong><u>关键：当 Node 代码异步操作(比如 文件I/O、网络I/O等)执行完成后，就会通过 <code>data</code>、 <code>connect</code> 等事件通知，使得 Ev Loop 到达  <code>poll</code> 阶段;</u></strong></li></ul></li> <li>若队列为空，则检查是否有 setImmdiate 回调；
<ul><li>若有则前往 <strong><u>check 阶段</u></strong>；</li> <li>若无则继续等待，相当于阻塞了一段时间，等待 callback 被加入到队列中并立即执行，达到超时时间后则自动进入 <strong><u>check 阶段</u></strong>；</li></ul></li></ul></li></ul></li></ul> <p><strong><u>5、check 阶段</u></strong>：相对简单的阶段，直接执行 setImmdiate 的回调；</p> <p><strong><u>6、关闭事件的回调阶段</u></strong>：若一个 socket 或句柄 (handle) 被突然关闭，比如 socket.destroy()， <code>close</code> 事件回调就会在此阶段执行；</p> <p><strong><u><em>一、宏任务 macrotask 执行情况(精简-适合记忆)：</em></u></strong></p> <p><strong><u>1、timer 阶段</u></strong>：检查定时器诸如 setTimeout、setInterval，若到时间，就执行回调；</p> <p><strong><u>2、poll 阶段</u></strong>：Node 代码的异步操作，比如 文件I/O、网络I/O等执行完成后，就会通过 <code>data</code>、 <code>connect</code> 等事件，使得事件循环到达  <code>poll</code> 阶段，以通知 JS 主线程，到达了这个阶段后：</p> <ul><li>若当前已存在定时器，且有定时器到达时间，便拿出执行，EventLoop 将回到  <strong><u>timer 阶段</u></strong>；</li> <li>若无定时器, 便会查看回调函数队列；
<ul><li>若队列不为空，便遍历 callback 队列并同步执行，直到队列为空或者达到系统限制；</li> <li>若队列为空，则检查是否有 <code>setImmdiate</code> 回调；
<ul><li>若有则前往 <strong><u>check 阶段</u></strong>；</li> <li>若无则继续等待，相当于阻塞了一段时间，等待 callback 被加入到队列中并立即执行，达到超时时间后则自动进入 <strong><u>check 阶段</u></strong>；</li></ul></li></ul></li></ul> <p><strong><u>3、check 阶段</u></strong>：相对简单的阶段，直接执行 <code>setImmdiate</code> 的回调；</p> <p>**<u><em>二、微任务 microtask 执行情况：</em></u>**在以上每个阶段完成前 清空  microtask 队列，下图中的 Tick 就代表了 microtask</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123828.png" align="" style="zoom:50%;"> <p><strong><u><em>与EvLoop 区别：浏览器中的微任务是在 每个相应的宏任务 间执行的，而 Node  中的微任务是在 不同阶段间 执行；浏览器执行流程是：宏-微-其他(UI/WebWorker/rAF/Else)-宏-微…次序，而 Node 则还分版本：</em></u></strong></p> <ul><li><p>node 版本 &gt;= 11：与浏览器表现一致，定时器运行完立即运行相应的微任务；</p></li> <li><p>node 版本 &lt; 11：若第一个定时器任务出队并执行完，发现队首任务仍是一个定时器，则将微任务暂时保存，直接去执行新的定时器任务，当新的定时器任务执行完后，再一一执行中途产生的微任务；<strong><u><em>宏任务-微-timer阶段(定时器)-微-Poll阶段(或跳转 timer 阶段，或check阶段，或IO回调等待执行超时则进入 check 阶段)-微-check阶段(setImmdiate 回调)-微-…</em></u></strong></p></li> <li><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timer1'</span><span class="token punctuation">)</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timer2'</span><span class="token punctuation">)</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">// node 版本 &gt;= 11</span>
timer1
promise1
time2
promise2
<span class="token comment">// node 版本 &lt; 11</span>
timer1
timer2
promise1
promise2
</code></pre></div></li></ul> <h3 id="_2-4、nodeevloop-示例"><a href="#_2-4、nodeevloop-示例" class="header-anchor">#</a> 2-4、NodeEvLoop 示例</h3> <ul><li>process.nextTick 是独立于 Node EvLoop 的任务队列；当每个 NodeEvLoop 阶段完成后，若存在 nextTick 队列，就会 <strong><u>清空队列中的所有回调函数</u></strong>，且**<u>优先于其他微任务</u>** 执行；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timer1'</span><span class="token punctuation">)</span>

 Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span>
 process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span>
   process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span>
     process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 以上代码，无论如何，永远都是先把 nextTick 全部打印出来</span>


<span class="token comment">// Ex2</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick 1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise 1'</span><span class="token punctuation">)</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise 2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise Resolve'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick 2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Node环境(10.3.0版本)中打印的顺序： Promise 1 &gt; Promise 2 &gt; nextTick 1 &gt; nextTick 2 &gt; Promise Resolve &gt; timeout</span>
<span class="token comment">// Node.js的v10.x版本中对于 process.nextTick 的说明如下：</span>
The process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> method adds the callback to the <span class="token string">&quot;next tick queue&quot;</span><span class="token punctuation">.</span> Once the current turn <span class="token keyword">of</span> the event loop turn runs to completion<span class="token punctuation">,</span> all callbacks currently <span class="token keyword">in</span> the next tick queue will be called<span class="token punctuation">.</span>
This is not a simple alias to <span class="token function">setTimeout</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span> It is much more efficient<span class="token punctuation">.</span> It runs before any additional <span class="token constant">I</span><span class="token operator">/</span><span class="token constant">O</span> <span class="token function">events</span> <span class="token punctuation">(</span>including timers<span class="token punctuation">)</span> fire <span class="token keyword">in</span> subsequent ticks <span class="token keyword">of</span> the event loop<span class="token punctuation">.</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123829.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Node 环境下:</span>
<span class="token comment">// 1 7(主阶段) 6(process.nextTick在阶段间、微任务前执行) 8(微任务) 2 4 9 11(poll 执行 timer 回调) 3 10(阶段间、微任务前) 5 12(微任务)</span>

<span class="token comment">// 浏览器下: 可用 Promise.resolve().then(()=&gt;{ 替换 process.nextTick；</span>
<span class="token comment">//  1 7 6 8 2 4 3 5 9 11 10 12</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123830.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1 10(宏) 8 9(nextTick) 5 7(微) 2 6(timer) 3(微) 4(nextTick)</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123831.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1 7(宏) 6(nextTick) 8(微) 2 4 9 11(timer) 3 10(nextTick) 5 12(微)</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123832.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1 7 6 8 2 4 3 5 9 11 10 12</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123833.png" align="" style="zoom:50%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1 7 6 8 9 11 10 12 2 4 3 5</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123854.png" align="" style="zoom:40%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// start end(宏) promise3(微) timer1 timer2(timer阶段) promise1 promise2(微)</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123855.png" align="" style="zoom:60%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// scriptStart async1Start async2 promise1 scriptEnd(宏，其中 async 同行等同 new promise, 而行后内容可视为 promise.then) process(nextTick) async1End promise2(微) setTimeout(timer阶段) setImmediate(check阶段)</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200909123856.png" align="" style="zoom:60%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// scriptStart async1Start async2 promise1 scriptEnd(宏) async1End promise2(微) setTimeout(timer 阶段)</span>
</code></pre></div><h2 id="三、垃圾回收"><a href="#三、垃圾回收" class="header-anchor">#</a> 三、垃圾回收</h2> <p>数据分基本数据类型与引用数据类型，前者存储在栈内存中，随 ESP 切换而销毁，后者存储在堆内存中，堆内存使用新生代老生代两种垃圾回收方式，新生代采用 Scavenge 算法，其采用复制方式，将新生代内存空间一分为二FromTo，前者存放分配后的对象，当 From 快被写满时，为对象们增添标记，进入清理阶段，若为存活对象，则迁移到 To，否则销毁，随后FromTo角色翻转；上述过程循环；若某对象多次复制还存活，或迁移过程中，某对象刚好超过 To 空间的 ¼，则将其晋升到老生代；老生代则采用标记清除、标记整理算法，前者在标记阶段标记堆中所有对象，随后取消环境中使用中的变量或存在强引用的对象的标记，随后清理掉还附有标记的的对象；然后进入标记整理，将存活对象全部往一端靠拢(类似磁盘碎片整理)，此过程耗时长，容易造成卡顿；注意：这些垃圾回收算法均会导致应用逻辑的暂停，即全停顿；新生代与老生代的标记清除过程短暂影响不大，标记整理耗时过长；后续 V8 进行优化，引入增量标记，将标记过程分为一个个的子标记过程，同时让垃圾回收标记和 JS 应用逻辑交替进行，直到标记阶段完成，才进入内存碎片的整理；使用增量标记算法，可将一完整的垃圾回收任务拆分为很多小的任务，而小任务执行时间较短，可穿插在其他的 JS 任务中间执行，如此当执行某些动画效果时，就不会让用户因为垃圾回收任务而感受到页面的卡顿；使得垃圾回收过程对 JS 应用的阻塞时间减少为原来的 1 / 6；</p> <p>内存泄露：即不再用到的内存也无及时释放，一般而言，JS 内存泄露基本是人为导致，常见于闭包、为正确关闭的定时器、未正确销毁的 DOM 引用、不规范声明变量导致的全局变量溢出等；应加强规范，或使用各类 lint 加以约束开发者行为；</p></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">最后更新: </span> <span class="time">10/12/2020, 5:14:41 PM</span></div></footer> <!----> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.58d463af.js" defer></script><script src="/assets/js/3.5b6bd7ce.js" defer></script><script src="/assets/js/1.53e5735b.js" defer></script><script src="/assets/js/173.4fa13f79.js" defer></script>
  </body>
</html>
