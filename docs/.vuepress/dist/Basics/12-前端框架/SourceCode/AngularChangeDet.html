<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一、变更检测机制 | Leibnize 个人学习笔记</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="素材整理自网络，仅供个人学习记录之用">
    <link rel="preload" href="/assets/css/0.styles.4c1fe16c.css" as="style"><link rel="preload" href="/assets/js/app.58d463af.js" as="script"><link rel="preload" href="/assets/js/3.5b6bd7ce.js" as="script"><link rel="preload" href="/assets/js/1.53e5735b.js" as="script"><link rel="preload" href="/assets/js/148.fccbb459.js" as="script"><link rel="prefetch" href="/assets/js/10.47a34be1.js"><link rel="prefetch" href="/assets/js/100.2f7c82fb.js"><link rel="prefetch" href="/assets/js/101.57a81617.js"><link rel="prefetch" href="/assets/js/102.8befc7fd.js"><link rel="prefetch" href="/assets/js/103.c690f409.js"><link rel="prefetch" href="/assets/js/104.c8b86b63.js"><link rel="prefetch" href="/assets/js/105.9bac0b69.js"><link rel="prefetch" href="/assets/js/106.77dcd9f8.js"><link rel="prefetch" href="/assets/js/107.305a0cd6.js"><link rel="prefetch" href="/assets/js/108.197f379c.js"><link rel="prefetch" href="/assets/js/109.ed1f6dd8.js"><link rel="prefetch" href="/assets/js/11.d67029e2.js"><link rel="prefetch" href="/assets/js/110.b10adffc.js"><link rel="prefetch" href="/assets/js/111.27cb5e44.js"><link rel="prefetch" href="/assets/js/112.598f5429.js"><link rel="prefetch" href="/assets/js/113.b7f9fe99.js"><link rel="prefetch" href="/assets/js/114.cb9df12d.js"><link rel="prefetch" href="/assets/js/115.4d812f2c.js"><link rel="prefetch" href="/assets/js/116.3a4f5195.js"><link rel="prefetch" href="/assets/js/117.be29161e.js"><link rel="prefetch" href="/assets/js/118.eb6b99b9.js"><link rel="prefetch" href="/assets/js/119.b3f342d7.js"><link rel="prefetch" href="/assets/js/12.f13f81de.js"><link rel="prefetch" href="/assets/js/120.f343ff14.js"><link rel="prefetch" href="/assets/js/121.5983ebbd.js"><link rel="prefetch" href="/assets/js/122.8dd46465.js"><link rel="prefetch" href="/assets/js/123.71ffc4a2.js"><link rel="prefetch" href="/assets/js/124.4e568dbe.js"><link rel="prefetch" href="/assets/js/125.43b22375.js"><link rel="prefetch" href="/assets/js/126.6522a7eb.js"><link rel="prefetch" href="/assets/js/127.8308b909.js"><link rel="prefetch" href="/assets/js/128.1fd06c87.js"><link rel="prefetch" href="/assets/js/129.91e28eff.js"><link rel="prefetch" href="/assets/js/13.ac76083d.js"><link rel="prefetch" href="/assets/js/130.5027f9f0.js"><link rel="prefetch" href="/assets/js/131.4554c2f2.js"><link rel="prefetch" href="/assets/js/132.c643aed4.js"><link rel="prefetch" href="/assets/js/133.5e499634.js"><link rel="prefetch" href="/assets/js/134.59b1b330.js"><link rel="prefetch" href="/assets/js/135.da46fa8a.js"><link rel="prefetch" href="/assets/js/136.3a67d738.js"><link rel="prefetch" href="/assets/js/137.4d5f5f5e.js"><link rel="prefetch" href="/assets/js/138.1fe93dba.js"><link rel="prefetch" href="/assets/js/139.d7f54242.js"><link rel="prefetch" href="/assets/js/14.8e5c3120.js"><link rel="prefetch" href="/assets/js/140.82be0f82.js"><link rel="prefetch" href="/assets/js/141.979c5a91.js"><link rel="prefetch" href="/assets/js/142.658ae82d.js"><link rel="prefetch" href="/assets/js/143.17532399.js"><link rel="prefetch" href="/assets/js/144.dc947607.js"><link rel="prefetch" href="/assets/js/145.fc89bd8c.js"><link rel="prefetch" href="/assets/js/146.a5e1b7eb.js"><link rel="prefetch" href="/assets/js/147.0f8384fc.js"><link rel="prefetch" href="/assets/js/149.d2d32bbc.js"><link rel="prefetch" href="/assets/js/15.e17af96c.js"><link rel="prefetch" href="/assets/js/150.73f88a17.js"><link rel="prefetch" href="/assets/js/151.dd85d521.js"><link rel="prefetch" href="/assets/js/152.ca632725.js"><link rel="prefetch" href="/assets/js/153.02b859a6.js"><link rel="prefetch" href="/assets/js/154.268e5dd0.js"><link rel="prefetch" href="/assets/js/155.0df9a80c.js"><link rel="prefetch" href="/assets/js/156.0e786e96.js"><link rel="prefetch" href="/assets/js/157.79cdcd86.js"><link rel="prefetch" href="/assets/js/158.8a131380.js"><link rel="prefetch" href="/assets/js/159.7aed0b17.js"><link rel="prefetch" href="/assets/js/16.472bfca7.js"><link rel="prefetch" href="/assets/js/160.31daa77a.js"><link rel="prefetch" href="/assets/js/161.a44e6bf4.js"><link rel="prefetch" href="/assets/js/162.86180287.js"><link rel="prefetch" href="/assets/js/163.c9fd632a.js"><link rel="prefetch" href="/assets/js/164.15e04e68.js"><link rel="prefetch" href="/assets/js/165.69bcb02b.js"><link rel="prefetch" href="/assets/js/166.084ab8e2.js"><link rel="prefetch" href="/assets/js/167.0f42977a.js"><link rel="prefetch" href="/assets/js/168.a4474b7b.js"><link rel="prefetch" href="/assets/js/169.3d05b3ba.js"><link rel="prefetch" href="/assets/js/17.f9d21c6e.js"><link rel="prefetch" href="/assets/js/170.484ffe30.js"><link rel="prefetch" href="/assets/js/171.01628965.js"><link rel="prefetch" href="/assets/js/172.2dc6c763.js"><link rel="prefetch" href="/assets/js/173.4fa13f79.js"><link rel="prefetch" href="/assets/js/174.5da03623.js"><link rel="prefetch" href="/assets/js/175.7c3cae2a.js"><link rel="prefetch" href="/assets/js/176.3df0d63b.js"><link rel="prefetch" href="/assets/js/177.3aa8d705.js"><link rel="prefetch" href="/assets/js/178.5b48450e.js"><link rel="prefetch" href="/assets/js/179.3a963dce.js"><link rel="prefetch" href="/assets/js/18.8314222e.js"><link rel="prefetch" href="/assets/js/180.d67c14c9.js"><link rel="prefetch" href="/assets/js/181.c7bf4046.js"><link rel="prefetch" href="/assets/js/182.4a4705fd.js"><link rel="prefetch" href="/assets/js/183.9183a7da.js"><link rel="prefetch" href="/assets/js/184.290760c3.js"><link rel="prefetch" href="/assets/js/185.64cd4609.js"><link rel="prefetch" href="/assets/js/186.2940410e.js"><link rel="prefetch" href="/assets/js/187.12b14c61.js"><link rel="prefetch" href="/assets/js/188.1fea2b8b.js"><link rel="prefetch" href="/assets/js/189.04b7d343.js"><link rel="prefetch" href="/assets/js/19.ed77427b.js"><link rel="prefetch" href="/assets/js/190.a7d6ec94.js"><link rel="prefetch" href="/assets/js/191.8ad7d925.js"><link rel="prefetch" href="/assets/js/192.2fd0c8f8.js"><link rel="prefetch" href="/assets/js/193.4f8a87cd.js"><link rel="prefetch" href="/assets/js/194.9e2e73ca.js"><link rel="prefetch" href="/assets/js/195.c6292340.js"><link rel="prefetch" href="/assets/js/196.b7ff135e.js"><link rel="prefetch" href="/assets/js/197.83a7d260.js"><link rel="prefetch" href="/assets/js/198.530f7c9c.js"><link rel="prefetch" href="/assets/js/199.c5048869.js"><link rel="prefetch" href="/assets/js/20.09503993.js"><link rel="prefetch" href="/assets/js/200.3435c341.js"><link rel="prefetch" href="/assets/js/201.1e492eea.js"><link rel="prefetch" href="/assets/js/202.f7b55746.js"><link rel="prefetch" href="/assets/js/203.08e404b6.js"><link rel="prefetch" href="/assets/js/204.1bc4bdd8.js"><link rel="prefetch" href="/assets/js/21.38c15b75.js"><link rel="prefetch" href="/assets/js/22.ae59de53.js"><link rel="prefetch" href="/assets/js/23.1c6d3160.js"><link rel="prefetch" href="/assets/js/24.28c7c43e.js"><link rel="prefetch" href="/assets/js/25.e53d1234.js"><link rel="prefetch" href="/assets/js/26.6fe14a49.js"><link rel="prefetch" href="/assets/js/27.910bdd9c.js"><link rel="prefetch" href="/assets/js/28.9d9cd019.js"><link rel="prefetch" href="/assets/js/29.525906aa.js"><link rel="prefetch" href="/assets/js/30.8a1a47c0.js"><link rel="prefetch" href="/assets/js/31.750a297b.js"><link rel="prefetch" href="/assets/js/32.290c8619.js"><link rel="prefetch" href="/assets/js/33.885855c1.js"><link rel="prefetch" href="/assets/js/34.fb5b3f84.js"><link rel="prefetch" href="/assets/js/35.22021291.js"><link rel="prefetch" href="/assets/js/36.6736dcbf.js"><link rel="prefetch" href="/assets/js/37.50fc071e.js"><link rel="prefetch" href="/assets/js/38.a6f00886.js"><link rel="prefetch" href="/assets/js/39.e5f0c600.js"><link rel="prefetch" href="/assets/js/4.4c62e10b.js"><link rel="prefetch" href="/assets/js/40.7eaf6de1.js"><link rel="prefetch" href="/assets/js/41.c55fd828.js"><link rel="prefetch" href="/assets/js/42.2c5aaafc.js"><link rel="prefetch" href="/assets/js/43.6c939d74.js"><link rel="prefetch" href="/assets/js/44.22ccc866.js"><link rel="prefetch" href="/assets/js/45.56a056b8.js"><link rel="prefetch" href="/assets/js/46.6901927f.js"><link rel="prefetch" href="/assets/js/47.78460423.js"><link rel="prefetch" href="/assets/js/48.12fddaae.js"><link rel="prefetch" href="/assets/js/49.55f5515e.js"><link rel="prefetch" href="/assets/js/5.97a7c0dc.js"><link rel="prefetch" href="/assets/js/50.5c665644.js"><link rel="prefetch" href="/assets/js/51.9fbd3941.js"><link rel="prefetch" href="/assets/js/52.f3a93332.js"><link rel="prefetch" href="/assets/js/53.f7c91d71.js"><link rel="prefetch" href="/assets/js/54.035bd227.js"><link rel="prefetch" href="/assets/js/55.9d4300de.js"><link rel="prefetch" href="/assets/js/56.1fa21a7d.js"><link rel="prefetch" href="/assets/js/57.c6af5e20.js"><link rel="prefetch" href="/assets/js/58.8c0baaa7.js"><link rel="prefetch" href="/assets/js/59.63f1befc.js"><link rel="prefetch" href="/assets/js/6.8e992509.js"><link rel="prefetch" href="/assets/js/60.35539f20.js"><link rel="prefetch" href="/assets/js/61.0872b63b.js"><link rel="prefetch" href="/assets/js/62.6749d184.js"><link rel="prefetch" href="/assets/js/63.0a8a07d3.js"><link rel="prefetch" href="/assets/js/64.a2eeb6f7.js"><link rel="prefetch" href="/assets/js/65.d78ecb46.js"><link rel="prefetch" href="/assets/js/66.1e1a87a2.js"><link rel="prefetch" href="/assets/js/67.b550d647.js"><link rel="prefetch" href="/assets/js/68.68258f2e.js"><link rel="prefetch" href="/assets/js/69.9f502a69.js"><link rel="prefetch" href="/assets/js/7.159745e4.js"><link rel="prefetch" href="/assets/js/70.c9b2fe76.js"><link rel="prefetch" href="/assets/js/71.b7b04483.js"><link rel="prefetch" href="/assets/js/72.edb7dfe5.js"><link rel="prefetch" href="/assets/js/73.869de1e4.js"><link rel="prefetch" href="/assets/js/74.7816f275.js"><link rel="prefetch" href="/assets/js/75.0457b07c.js"><link rel="prefetch" href="/assets/js/76.79a2eaee.js"><link rel="prefetch" href="/assets/js/77.66cfa995.js"><link rel="prefetch" href="/assets/js/78.9dd75caf.js"><link rel="prefetch" href="/assets/js/79.f6111e69.js"><link rel="prefetch" href="/assets/js/8.b79c23ae.js"><link rel="prefetch" href="/assets/js/80.fff0a469.js"><link rel="prefetch" href="/assets/js/81.42c5ebec.js"><link rel="prefetch" href="/assets/js/82.ca2f7f18.js"><link rel="prefetch" href="/assets/js/83.ed547319.js"><link rel="prefetch" href="/assets/js/84.377155d9.js"><link rel="prefetch" href="/assets/js/85.e5aab871.js"><link rel="prefetch" href="/assets/js/86.14705636.js"><link rel="prefetch" href="/assets/js/87.502cb8e9.js"><link rel="prefetch" href="/assets/js/88.d8f271ec.js"><link rel="prefetch" href="/assets/js/89.3e9deca1.js"><link rel="prefetch" href="/assets/js/9.23c0899b.js"><link rel="prefetch" href="/assets/js/90.4de4929c.js"><link rel="prefetch" href="/assets/js/91.307ce9fd.js"><link rel="prefetch" href="/assets/js/92.47e69683.js"><link rel="prefetch" href="/assets/js/93.34abda4c.js"><link rel="prefetch" href="/assets/js/94.00078270.js"><link rel="prefetch" href="/assets/js/95.4c9ca2ce.js"><link rel="prefetch" href="/assets/js/96.9121392c.js"><link rel="prefetch" href="/assets/js/97.41f6bdb8.js"><link rel="prefetch" href="/assets/js/98.4524a102.js"><link rel="prefetch" href="/assets/js/99.7d313788.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4c1fe16c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-dad8a512><div data-v-dad8a512><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-dad8a512 data-v-dad8a512><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-dad8a512 data-v-dad8a512><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>Leibnize 个人学习笔记</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Leibnize 个人学习笔记</span>
            
          <!---->
          2020
        </a></span></div></div> <div class="hide" data-v-dad8a512><header class="navbar" data-v-dad8a512><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Leibnize 个人学习笔记</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Basics/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  基本
</a></div><div class="nav-item"><a href="/NetWork/" class="nav-link"><i class="iconfont undefined"></i>
  网络
</a></div><div class="nav-item"><a href="https://github.com/rjwx60" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-dad8a512></div> <aside class="sidebar" data-v-dad8a512><div class="personal-info-wrapper" data-v-ca798c94 data-v-dad8a512><!----> <h3 class="name" data-v-ca798c94>
    Leibnize 个人学习笔记
  </h3> <div class="num" data-v-ca798c94><div data-v-ca798c94><h3 data-v-ca798c94>0</h3> <h6 data-v-ca798c94>Article</h6></div> <div data-v-ca798c94><h3 data-v-ca798c94>0</h3> <h6 data-v-ca798c94>Tag</h6></div></div> <hr data-v-ca798c94></div> <nav class="nav-links"><div class="nav-item"><a href="/Basics/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  基本
</a></div><div class="nav-item"><a href="/NetWork/" class="nav-link"><i class="iconfont undefined"></i>
  网络
</a></div><div class="nav-item"><a href="https://github.com/rjwx60" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端专题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/01-前端基础" class="sidebar-heading clickable open"><span>01-前端基本</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Basics/01-前端基础/HTML.html" class="sidebar-link">一、HTML</a></li><li><a href="/Basics/01-前端基础/CSS.html" class="sidebar-link">二、CSS</a></li><li><a href="/Basics/01-前端基础/DOMBOM.html" class="sidebar-link">三、DOMBOM</a></li><li><a href="/Basics/01-前端基础/Summary.html" class="sidebar-link">四、Summary</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/02-前端性能" class="sidebar-heading clickable"><span>02-前端性能</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/03-前端工程" class="sidebar-heading clickable"><span>03-前端工程</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/04-前端异步" class="sidebar-heading clickable"><span>04-前端异步</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/05-前端设计" class="sidebar-heading clickable"><span>05-前端设计</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/06-前端数据" class="sidebar-heading clickable"><span>06-前端数据</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/07-前端安全" class="sidebar-heading clickable"><span>07-前端安全</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/08-前端概念" class="sidebar-heading clickable"><span>08-前端概念</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/09-前端实现" class="sidebar-heading clickable"><span>09-前端实现</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/10-前端新标" class="sidebar-heading clickable"><span>10-前端新标</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/11-前端会话" class="sidebar-heading clickable"><span>11-前端会话</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/12-前端框架" class="sidebar-heading clickable"><span>12-前端框架</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/14-浏览器相关" class="sidebar-heading clickable"><span>14-浏览器相关</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/15-前端核心" class="sidebar-heading clickable"><span>15-前端核心</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/16-前端Node" class="sidebar-heading clickable"><span>16-前端Node</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-dad8a512><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e></h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Leibnize 个人学习笔记</span>
            
          <!---->
          2020
        </a></span></div></div> <div data-v-dad8a512><main class="page"><div class="page-title" style="display:none;"><h1>一、变更检测机制</h1> <div data-v-3b7f5bdf><i class="iconfont reco-account" data-v-3b7f5bdf><span data-v-3b7f5bdf>Leibnize 个人学习笔记</span></i> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default" style="display:none;"><h1 id="一、变更检测机制"><a href="#一、变更检测机制" class="header-anchor">#</a> 一、变更检测机制</h1> <p><strong><u><em>Angular 的变更检测</em></u></strong>  要从一个错误说起 <strong><u><em>ExpressionChangedAfterItHasBeenCheckedError</em></u></strong>，一个按钮应用，当发生变化检测时将时间渲染到屏幕上。时间戳的精度是毫秒。点击按钮触发变化监测；组件类中有个名为<code>time</code>的getter，返回当前的时间戳；<a href="https://stackblitz.com/edit/angular-hqbenm?file=src/app/app.component.ts" target="_blank" rel="noopener noreferrer">地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        &lt;h3&gt;Change detection is triggered at: &lt;span [textContent]=&quot;time | date:'hh:mm:ss:SSS'&quot;&gt;&lt;/span&gt;&lt;/h3&gt;
				&lt;!-- Angular 不允许空的表达式，所以在 click 回调中放了一个 0 --&gt;
        &lt;button (click)=&quot;0&quot;&gt;Trigger Change Detection&lt;/button&gt;
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>果然，报错 ExpressionChangedAfterItHasBeenCheckedError
原因：表达式在被 Angular 检查后发生了变化：之前的值：&quot;textContent: 1542375826274&quot;，而现在的值：&quot;textContent: 1542375826275&quot;；
所以，可发现 Angular 对表达式进行了两次计算，并将两次计算结果进行了比较，发现结果不一致，遂报错；</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124132.png" align="" style="zoom:50%;"> <p><strong><u><em>Angular 的变更检测中有两个主要的构成元素：</em></u></strong></p> <ul><li>一个组件的视图</li> <li>相关的数据绑定</li></ul> <p>Angular 中的每个组件都有一个由 HTML 元素构成的模板；</p> <p>Angular 创建了 DOM 节点以便将模板中的内容渲染到屏幕上，它需要有一个地方存储这些 DOM 节点的引用；为此，在 Angular 内部有一个称为 <strong><u><em>视图</em></u></strong> 的数据结构。<u><em>视图也被用来存储组件实例的引用，以及绑定表达式之前的值</em></u>。组件和视图之间是一对一的关系：</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124133.png" align="" style="zoom:50%;"> <p>首先，当编译器在分析模板时，它会<u>识别</u>可能需要在变化检测期间被更新的DOM元素的属性；</p> <p>然后，编译器会为每个这样的属性<u>创建</u>一个 <strong><u><em>绑定</em></u></strong>；数据绑定定义了：<u><em>需要更新的属性名称</em></u>、<u><em>Angular 用于获取新值的表达式</em></u>；</p> <ul><li>比如：此例中，<code>time</code> 属性被用在 <code>textContent</code> 属性的表达式中；所以 Angular 创建了绑定，并将它关联到 <code>span</code> 元素；</li></ul> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124134.png" align="" style="zoom:50%;"> <ul><li>注意：实际实现中，<u><em>绑定不是一个有着所有必须信息的单独的对象</em></u>；
<ul><li><code>viewDfinition</code> 为模板元素和需要更新的属性定义了绑定；</li> <li>而用于绑定的表达式则被置于 <code>updateRenderer</code> 函数中；</li></ul></li></ul> <p>**<u><em>Angular 变更检测流程：</em></u>**Angular中，每个组件都会执行变更检测；而组件在 Angular 内部会被表达为视图，所以可以说每个视图都会执行变更检测；</p> <ul><li>首先，当 Angular 检查一个视图时，它只会运行所有的编译器为视图生成的绑定，对表达式求值并将它们的结果，存储在视图的 <code>oldValues</code> 数组中；此亦脏检查的由来；</li> <li>然后，如果后续过程中，Angular 检测到了变化(Zone)，它就会更新与绑定相关的 DOM 属性，并将这个新的值放入视图的 <code>oldValues</code> 数组中；</li> <li>然后，(进行渲染)，用户就得到了一个更新过的 UI (组件层级)；</li> <li>最后，一旦 Angular 完成了当前组件的检测，它会递归地去检查子组件；
<ul><li>比如：在本次示例中只有一个绑定：连接到 <code>App</code> 组件中的 <code>span</code> 元素的 <code>textContent</code> 属性；</li> <li>所以：在变化检测期间，Angular 读取了组件类的 <code>time</code> 属性的值，并将其应用到 <code>date</code> 管道上，然后将返回值与储存在视图中的旧值相比较；如果它检测到不同(也即表示发生值变更)，Angular 就会更新 <code>span</code> 的 <code>textContent</code> 属性和 <code>oldValues</code> 数组；</li></ul></li></ul> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124135.png" align="" style="zoom:50%;"> <ul><li><p>注意：<u><em>在开发模式下，每一次变更检测循环后(同步任务)，Angular 会同步地运行另一次检查(同步任务)，以确保表达式生成的值，与先前在变更检测中的值相同</em></u>；这次检查并非是原始变更监测循环的一部分，它在整个组件树的变化检查结束后执行完全相同的步骤；但是在次次检查中，当 Angular 检测到了变更是不会更新DOM的；相反会抛出<code>ExpressionChangedAfterItHasBeenCheckedError</code> 错误；即：开发模式与生产模式不同，前者进行了两次检查，后者进行了一次；前者检查后若值不同则报错，后者值不同则更新UI；</p></li> <li><p><u>原因：Ng 做此次检查的原因：确保表达式生成的值与先前在变更检测中的值相同，在开发模式中排查错误，以免在生产模式下，陷入变更检测循环；</u></p> <ul><li>比如：组件类中的某些属性在变化检测运行期间就已被更新，造成的结果是：表达式产生了与渲染到 UI 中的值不一致的新值；此时的 Angular 当然可以再运行一次变化检测以同步应用状态与UI；但如果在此过程中，某些属性再次被更新了呢？那么 Angular 就有可能会在无限的变化检测循环中崩溃；</li></ul></li> <li><p>所以，为避免这种情况，Angular 强制实行了被称为 <strong><u><em>单项数据流</em></u></strong> 的模式，并且在变化检测后运行的检查和由此产生错误<code>ExpressionChangedAfterItHasBeenCheckedError</code> 是强制的机制；一旦 Angular 处理完当前组件的绑定，就不能再更新绑定表达式中使用的属性；</p></li> <li><p>解决：明白了变更检测原理，即可修复此错误，确保表达式在变化检测期间与随后的检查中返回的值是相同的：</p> <ul><li><p>思路1：确保值始终不变；</p></li> <li><p>思路2：变更检测与二次检查均为同步任务(产生错误的检查在变化检测循环后立即同步运行)，遂可利用 EventLoop 机制，将值的变更操作封装在异步或微任务中执行，等检查后再去更新值，以避免错误发生；注意避免使用 setInterval 等异步操作，因为</p></li> <li><p>思路3：利用 zones 提供 API，在变更检测之外执行，见下方；</p></li> <li><div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        &lt;h3&gt;Change detection is triggered at: &lt;span [textContent]=&quot;time | date:'hh:mm:ss:SSS'&quot;&gt;&lt;/span&gt;&lt;/h3&gt;
				&lt;!-- Angular 不允许空的表达式，所以在 click 回调中放了一个 0 --&gt;
        &lt;button (click)=&quot;0&quot;&gt;Trigger Change Detection&lt;/button&gt;
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  	<span class="token comment">// ExpressionChangedAfterItHasBeenCheckedError</span>
  	<span class="token comment">// 两次检查，所得的值均不同，报错</span>
    <span class="token keyword">get</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
  	<span class="token comment">// fix - 思路1</span>
  	<span class="token comment">// 将值写死，time 返回值始终不变，不管如何前后两次检测的值均等，无报错，但没有实现需求，</span>
    _time<span class="token punctuation">;</span>
    <span class="token keyword">get</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_time<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// fix - 思路2</span>
    _time<span class="token punctuation">;</span>
    <span class="token keyword">get</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_time<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 不断更新 _time 值，因为二次检查是同步任务，所以可利用 EventLoop 机制，用异步任务封装更新操作，等检查后再去更新；</span>
      	<span class="token comment">// 异步操作被 Angular 做了劫持，都会触发新一轮的变更检测，若使用 setInterval 更是会无限次触发；</span>
        <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ul> <p><strong><u><em>Angular 变更检测之变更通知 Zone：</em></u></strong></p> <p>与 React 相反，Angular 中的变更检测可完全自动地由浏览器中的任何一个异步事件触发；Angular 通过使用 <code>zone.js</code> 库，以实现变更监测流程的触发( zone.js 检测到异步事件，事件通知 Angular，进入变更检测流程)；</p> <p>此外 Angular 同时还引入了 zones 概念，注意 zones 并非 Angular 变更检测机制的一部分，而是独立于 Angular 之外的仅仅提供了一种拦截异步事件的方法的库，比如 <code>setInterval</code>，并通知 Angular 发生了异步事件，Angular 基于此通知来运行变更检测；一个网页应用可包含许多不同的 zones；其中一个是 <code>NgZone</code>，它在 Angular 启动时被创建；Angular 整一应用就运行在这个 zone 当中；只有在 zone 中发生的异步事件才会通知 Angular；</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124136.png" align="" style="zoom:50%;"> <p>但是，<code>zone.js</code>也提供了一个API：<code>NgZone</code> 服务实现的 <code>runOutsideAngular</code>，以便在 Angular zone 之外的 zone 中运行某些代码；而在其他 zone 中发生异步事件时，Angular 并不会收到通知；没有通知就意味着没有变更检测；所以在本次示例中，可解决不断触发变更检测的问题：</p> <p><strong><u>注意：使用 NgZone 来在 Angular 之外运行某些代码以避免触发变化检测是一种常用的优化技巧；</u></strong></p> <div class="language-ts extra-class"><pre class="language-ts"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        &lt;h3&gt;Change detection is triggered at: &lt;span [textContent]=&quot;time | date:'hh:mm:ss:SSS'&quot;&gt;&lt;/span&gt;&lt;/h3&gt;
				&lt;!-- Angular 不允许空的表达式，所以在 click 回调中放了一个 0 --&gt;
        &lt;button (click)=&quot;0&quot;&gt;Trigger Change Detection&lt;/button&gt;
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  	<span class="token comment">// ExpressionChangedAfterItHasBeenCheckedError</span>
  	<span class="token comment">// 两次检查，所得的值均不同，报错</span>
    <span class="token keyword">get</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
  	<span class="token comment">// fix - 思路1</span>
  	<span class="token comment">// 将值写死，time 返回值始终不变，不管如何前后两次检测的值均等，无报错，但没有实现需求，</span>
    _time<span class="token punctuation">;</span>
    <span class="token keyword">get</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_time<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// fix - 思路2</span>
    _time<span class="token punctuation">;</span>
    <span class="token keyword">get</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_time<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 不断更新 _time 值，因为二次检查是同步任务，所以可利用 EventLoop 机制，用异步任务封装更新操作，等检查后再去更新；</span>
      	<span class="token comment">// 异步操作被 Angular 做了劫持，都会触发新一轮的变更检测，若使用 setInterval 更是会无限次触发；</span>
        <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
  	<span class="token comment">// fix - 思路3</span>
    _time<span class="token punctuation">;</span>
    <span class="token keyword">get</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_time<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span>zone<span class="token operator">:</span> NgZone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// 不断更新 _time 值，因为二次检查是同步任务，所以可利用 EventLoop 机制，用异步任务封装更新操作，等检查后再去更新；</span>
      	<span class="token comment">// 异步操作被 Angular 做了劫持，都会触发新一轮的变更检测，若使用 setInterval 更是会无限次触发；</span>
      	<span class="token comment">// 所以引入 NgZone 服务，使得异步任务在 NgZone 执行，绕开 NgZone 的变更检测，避免无限触发，又能确保检查后再更新值</span>
      	<span class="token comment">// 1、异步 -&gt; EventLoop 机制，异步绕开同步，避免值在检查前变化，保证检查后再变化，避免错误</span>
      	<span class="token comment">// 2、Zone -&gt; NgZone 原理，避免异步多次重复触发变更检测，避免死循环</span>
        zone<span class="token punctuation">.</span><span class="token function">runOutsideAngular</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>_time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong><u><em>Angular 变更检测之生命周期钩子的执行顺序：</em></u></strong></p> <p>由于单项数据流的限制，在组件被检查后，不能在变化检测期间改变组件的某些属性；但绝大多数时候，当 Angular 对子组件进行变更检测时，数据的更新通过共享服务或同步事件进行广播、或直接将父组件注入到子组件中，然后通过生命周期钩子更新父组件的状态：<a href="https://stackblitz.com/edit/angular-zntusy" target="_blank" rel="noopener noreferrer">地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 父组件</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        &lt;div [textContent]=&quot;text&quot;&gt;&lt;/div&gt;
        &lt;child-comp&gt;&lt;/child-comp&gt;
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
    text <span class="token operator">=</span> <span class="token string">'Original text in parent component'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// 子组件</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'child-comp'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;span&gt;I am child component&lt;/span&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ChildComponent</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 获取到父组件</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> parent<span class="token operator">:</span> AppComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token comment">// 通过父组件直接更新数据</span>
    <span class="token function">ngAfterViewChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">'Updated text in parent component'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 结果：ExpressionChangedAfterItHasBeenCheckedError</span>
<span class="token comment">// 原因：当 Angular 在子组件中调用 ngAfterViewChecked 生命周期钩子时，父级 App 组件视图的数据绑定已被检查过，但这里在检查后更新了父组件中的 text 属性，导致前后两次绑定表达式的产生结果不一致，报错；</span>
<span class="token comment">// 但是：若将 ngAfterViewChecked 改为 ngOnInit 等其他钩子函数(不含 AfterViewInit、AfterViewChecked)则不会报错</span>
<span class="token comment">// 原因：Angular 在变更检测期间执行的操作顺序</span>
</code></pre></div><p>在获悉 Angular 在变更检测期间执行的操作顺序前，需要搞明白 Angular 中的视图和绑定；在 <code>@angular/core</code> 模块中有一个名为 <code>checkAndUpdateView</code>的函数，它遍历组件树中的视图(组件)，并对每个视图执行检测；可通过 <a href="https://angular-eobrrh.stackblitz.io/" target="_blank" rel="noopener noreferrer">此演示<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 去进行调试：打开控制台，找到函数并打上断点，点击按钮触发变化监测，审查<code>view</code>变量</p> <p><video src="/Image/Frame/Angular/10.mov" align="" style="zoom:50%;"></video></p> <p>结果：第一个 view 会成为宿主视图，其是 Angular 创建的一个根组件，用来托管 app 组件，继续执行，以获得它的子视图，此亦 AppComponent 的视图；</p> <ul><li>component 属性存放了 App 组件的实例；</li> <li>node 属性存放了 DOM 节点的引用，这些 DOM 节点是为 App 组件的模板中的元素创建的；</li> <li>oldValues 数组存储了绑定表达式的结果；</li></ul> <p>关键：<code>checkAndUpdateView</code> 函数(<strong><u><em>先别管上面的调试过程与结果，只须知道此函数即可</em></u></strong>)，可以发现，Angular 会在变化检测期间触发生命周期钩子：当 Angular 处理绑定时，一些钩子在渲染前被调用，一些钩子则在渲染后才被调用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">checkAndUpdateView</span><span class="token punctuation">(</span><span class="token parameter">view<span class="token punctuation">,</span> <span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>       
    <span class="token comment">// 更新子视图(组件)和指令中的绑定,</span>
    <span class="token comment">// 如果有需要的话，调用 NgOnInit, NgDoCheck and ngOnChanges 钩子</span>
    Services<span class="token punctuation">.</span><span class="token function">updateDirectives</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> CheckType<span class="token punctuation">.</span>CheckAndUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// DOM 更新，为当前视图(组件)执行渲染</span>
    Services<span class="token punctuation">.</span><span class="token function">updateRenderer</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> CheckType<span class="token punctuation">.</span>CheckAndUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 在子视图(组件)中执行变更检测</span>
    <span class="token function">execComponentViewsAction</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> ViewAction<span class="token punctuation">.</span>CheckAndUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 调用 AfterViewChecked 和 AfterViewInit 钩子</span>
    <span class="token function">callLifecycleHooksChildrenFirst</span><span class="token punctuation">(</span>…<span class="token punctuation">,</span> NodeFlags<span class="token punctuation">.</span>AfterViewChecked…<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124137.png" align="" style="zoom:50%;"> <ul><li><p>首先，Angular 为子组件更新输入绑定；</p></li> <li><p>然后，Angular 调用了子组件上的 <code>OnInit</code>、<code>DoCheck</code>、<code>Onchanges</code> 钩子；</p> <ul><li>意义：因子组件刚更新了输入绑定，所以 Angular 需要通知子组件输入绑定已被初始化；</li></ul></li> <li><p>然后，Angular 为子组件执行渲染；</p></li> <li><p>此后，<strong><u><em>Angular 为子组件运行变更检测 Run change detection，即意味着它会在子视图中重复这些操作；</em></u></strong></p></li> <li><p>最后，Angular 调用了子组件上的 <code>AfterViewChecked</code>、<code>AfterViewInit</code> 钩子让子组件知道已被检查；</p> <ul><li>注意：Angular 在处理了父组件的绑定后，才调用子组件的 <code>AfterViewChecked</code> 生命周期钩子；</li> <li>注意：<code>OnInit</code> 钩子在绑定被处理前调用，故即使在 <code>OnInit</code> 中改变 <code>text</code> 值，在随后检查中它仍然是相同的，就解释了在 <code>ngOnInit</code>中不报错的行为；</li></ul></li> <li><p>再说流程：一个运行的 Angular 程序其实一个组件树，在变更检测期间，Angular 会按照以下顺序检查每一个组件：</p> <ul><li><strong><a href="https://link.zhihu.com/?target=https%3A//hackernoon.com/the-mechanics-of-property-bindings-update-in-angular-39c0812bc4ce" target="_blank" rel="noopener noreferrer">更新所有子组件/指令的绑定属性<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></strong>；</li> <li>调用所有子组件/指令的三个生命周期钩子：<code>ngOnInit</code>，<code>OnChanges</code>，<code>ngDoCheck</code>；</li> <li><strong><a href="https://link.zhihu.com/?target=https%3A//hackernoon.com/the-mechanics-of-dom-updates-in-angular-3b2970d5c03d" target="_blank" rel="noopener noreferrer">更新当前组件的 DOM<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></strong>；</li> <li>为子组件执行变更检测 (译者注：在子组件上重复上面三个步骤，依次递归下去)；</li> <li>为所有子组件/指令调用当前组件的 <code>ngAfterViewInit</code> 生命周期钩子；</li></ul></li></ul> <h1 id="二、变更检测机制总结"><a href="#二、变更检测机制总结" class="header-anchor">#</a> 二、变更检测机制总结</h1> <p>Angular 中的所有组件，在内部均被表示为一种叫视图的数据结构；</p> <p>Angular 的编译器解析模板并创建绑定，而每一绑定定义了：一个要更新的DOM元素的属性 &amp; 用于求值的表达式；</p> <p>视图中的 <code>oldValues</code>属性存储了在变更检测中被用于比较的旧值；</p> <p>在变更检测期间，Angular 遍历所有绑定，并对表达式求值，将所得的结果与旧值比较，若有必要则更新DOM；</p> <p>每个变更检测循环后，Angular 运行一次检查以确保组建的状态与用户界面同步；这次检查为同步运行并可能会报错<code>ExpressionChangedAfterItWasChecked</code>；<a href="https://blog.angularindepth.com/a-gentle-introduction-into-change-detection-in-angular-33f9ffff6f10" target="_blank" rel="noopener noreferrer">引用自此<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h1 id="三、变更检测触发器-zone"><a href="#三、变更检测触发器-zone" class="header-anchor">#</a> 三、变更检测触发器 Zone</h1> <h2 id="_3-1、变化源于异步操作"><a href="#_3-1、变化源于异步操作" class="header-anchor">#</a> 3-1、变化源于异步操作</h2> <p><strong><u><em>组件初始化后的 一切 数据变化均是由某个异步事件产生</em></u></strong>；因为：初始化是一个同步过程，在 Angular 框架中，组件初始化对应的就是组件的构造方法被调用，此构造过程是一个同步的过程；而在构造过程后只有异步事件才会令组件中的数据发生变化，比如：点击，Ajax 请求，Promise，setTimeout 或 Websocket 等；</p> <h2 id="_3-2、zone-js"><a href="#_3-2、zone-js" class="header-anchor">#</a> 3-2、Zone.js</h2> <p>为能在上述异步事件发生时及时检查变化，在 Angular 应用启动时会通过 Zone.js 库，为许多浏览器提供的 API 打补丁(可理解为劫持或封装处理)，使用代理方法来代理浏览器 API 的调用，代理方法不仅会调用监听事件时提供的回调函数，还会执行变更检查以及刷新界面；</p> <p>Zone.js 是 Angular 团队在开发 Angular2 时实现的一个独立的库；Angular2 框架直接依赖 Zone.js 来实现变更检查；而 <a href="https://www.cnblogs.com/whitewolf/p/zone-js.html" target="_blank" rel="noopener noreferrer">Zone.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 实际上是一个异步操作的执行上下文，它为一组异步操作提供了一个统一的运行环境，并为这组异步过程的生命周期提供钩子方法，以方便在异步事件进行的不同阶段执行一些任务；</p> <p>Zone.js 对浏览器中的 setTimeout、setInterval、setImmediate、以及事件、promise、地理信息geolocation都做了特殊处理；</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124138.png" align="" style="zoom:50%;"> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124139.png" align="" style="zoom:50%;"> <p>首先，zone会将浏览器的原生方法保存在 setNative 中以便将会重用；</p> <p>然后，zone 就开始其暴力行为，覆盖 window[setName] 和 window[clearName]；</p> <p>然后，将对 setName 的调用转到自身的 zone[setName] 的调用(如此暴力的对浏览器原生对象实现了拦截转移)；</p> <p>然后，zone 会在 Task 执行的前后调用自身的 addRepeatingTask、addTask 以及 wtf 事件来应用注册上的所有钩子函数；</p> <p>补丁示例如下：addEventListener(Zone.js v0.6.0 版本)：是浏览器提供的用于监听事件的 API，在 Angular 启动的时候将它替换成了一个新的版本：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">patchEventTargetMethods</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> addFnName<span class="token punctuation">,</span> removeFnName<span class="token punctuation">,</span> metaCreator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>addFnName <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> addFnName <span class="token operator">=</span> <span class="token constant">ADD_EVENT_LISTENER</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>removeFnName <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> removeFnName <span class="token operator">=</span> <span class="token constant">REMOVE_EVENT_LISTENER</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>metaCreator <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> metaCreator <span class="token operator">=</span> defaultListenerMetaCreator<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">[</span>addFnName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将 addEventListener 和 removeEventListener 分别替换为 makeZoneAwareAddListener 和 makeZoneAwareRemoveListener</span>
        <span class="token function">patchMethod</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> addFnName<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">makeZoneAwareAddListener</span><span class="token punctuation">(</span>addFnName<span class="token punctuation">,</span> removeFnName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> metaCreator<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">patchMethod</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> removeFnName<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">makeZoneAwareRemoveListener</span><span class="token punctuation">(</span>removeFnName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> metaCreator<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 实施替换的方法</span>
<span class="token keyword">function</span> <span class="token function">patchMethod</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> name<span class="token punctuation">,</span> patchFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> proto <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 获取带前缀的方法名</span>
    <span class="token keyword">var</span> delegateName <span class="token operator">=</span> <span class="token function">zoneSymbol</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> delegate<span class="token punctuation">;</span>
    <span class="token comment">// 检查是否已经 patch 过</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>proto <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>delegate <span class="token operator">=</span> proto<span class="token punctuation">[</span>delegateName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        delegate <span class="token operator">=</span> proto<span class="token punctuation">[</span>delegateName<span class="token punctuation">]</span> <span class="token operator">=</span> proto<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取代理方法</span>
        <span class="token keyword">var</span> patchDelegate_1 <span class="token operator">=</span> <span class="token function">patchFn</span><span class="token punctuation">(</span>delegate<span class="token punctuation">,</span> delegateName<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将代理方法赋给对象的 addEventListener 属性</span>
        proto<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">patchDelegate_1</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// 将原来的方法实现作为属性添加到 proto[name] 上面</span>
        <span class="token function">attachOriginToPatched</span><span class="token punctuation">(</span>proto<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> delegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回原方法</span>
    <span class="token keyword">return</span> delegate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 替换后的 &quot;addEventListener&quot;</span>
<span class="token keyword">function</span> <span class="token function">makeZoneAwareAddListener</span><span class="token punctuation">(</span><span class="token parameter">addFnName<span class="token punctuation">,</span> removeFnName<span class="token punctuation">,</span> useCapturingParam<span class="token punctuation">,</span> allowDuplicates<span class="token punctuation">,</span> isPrepend<span class="token punctuation">,</span> metaCreator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 调度事件的方法</span>
    <span class="token keyword">function</span> <span class="token function">scheduleEventListener</span><span class="token punctuation">(</span><span class="token parameter">eventTask</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> meta <span class="token operator">=</span> eventTask<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token function">attachRegisteredEvent</span><span class="token punctuation">(</span>meta<span class="token punctuation">.</span>target<span class="token punctuation">,</span> eventTask<span class="token punctuation">,</span> isPrepend<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> meta<span class="token punctuation">.</span><span class="token function">invokeAddFunc</span><span class="token punctuation">(</span>addFnSymbol<span class="token punctuation">,</span> eventTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 取消事件监听的方法</span>
    <span class="token keyword">function</span> <span class="token function">cancelEventListener</span><span class="token punctuation">(</span><span class="token parameter">eventTask</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> meta <span class="token operator">=</span> eventTask<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token function">findExistingRegisteredTask</span><span class="token punctuation">(</span>meta<span class="token punctuation">.</span>target<span class="token punctuation">,</span> eventTask<span class="token punctuation">.</span>invoke<span class="token punctuation">,</span> meta<span class="token punctuation">.</span>eventName<span class="token punctuation">,</span> meta<span class="token punctuation">.</span>useCapturing<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> meta<span class="token punctuation">.</span><span class="token function">invokeRemoveFunc</span><span class="token punctuation">(</span>removeFnSymbol<span class="token punctuation">,</span> eventTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// self 是被监听的对象， args 是监听的事件，包括事件名称和 callback</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">zoneAwareAddListener</span><span class="token punctuation">(</span><span class="token parameter">self<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根据事件的名称和回调方法创建封装 ZoneTask 的 data 对象</span>
        <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token function">metaCreator</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// 获取当前的 Zone</span>
        <span class="token keyword">var</span> zone <span class="token operator">=</span> Zone<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
        <span class="token keyword">var</span> source <span class="token operator">=</span> data<span class="token punctuation">.</span>target<span class="token punctuation">.</span>constructor<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> addFnName <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>eventName<span class="token punctuation">;</span>
        <span class="token comment">// 创建 ZoneTask 并开始调度这个 Task</span>
        zone<span class="token punctuation">.</span><span class="token function">scheduleEventTask</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> delegate<span class="token punctuation">,</span> data<span class="token punctuation">,</span> scheduleEventListener<span class="token punctuation">,</span> cancelEventListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 注意: 上述方法中又调用了 invokeAddFunc 方法，方法中有如下的语句:</span>
      	<span class="token comment">// this.target[addFnSymbol](this.eventName, delegate.invoke, this.useCapturing);</span>
      	<span class="token comment">// target 是被监听的对象</span>
      	<span class="token comment">// target[addFnSymbol] 是浏览器提供的原始的 addEventListener 方法</span>
      
      	<span class="token comment">// 这里，Zone.js 才真正地将 Task 的 invoke 方法与事件绑定在一起</span>
      	<span class="token comment">// 当事件被触发时，便会调用 Task.invoke 在 invoke 中响应事件执行操作;</span>
      	<span class="token comment">// 当事件发生时，便直接调用 invoke 方法来执行用户提供的 callback 以及其他的操作;</span>
      	<span class="token comment">// 至此也就完成了给 addEventListener 打补丁的工作</span>
      	<span class="token comment">// 总结: 层层封装，层层套娃</span>

    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124140.png" align="" style="zoom:50%;"> <p>总结：Zone 为异步事件的处理提供了代理方法，在所有的异步事件被触发的时，都会先经过 Zone 的代理方法，此后，凡是在 Zone 内执行的异步事件的执行过程都在 Zone 的掌控之下，Zone 也就能知道这组异步事件在什么时候执行完成；而又因数据的变化是且仅可能是由于异步事件而产生，所以 Angular 也就可以通过监听 Zone 的生命周期事件，来得知什么时候应该进行变更检查；</p> <h2 id="_3-3、zone-js-的-ng-应用"><a href="#_3-3、zone-js-的-ng-应用" class="header-anchor">#</a> 3-3、Zone.js 的 NG 应用</h2> <p>Zone.js 向外暴露了一个 Zone 对象，下面是其生命周期中各阶段的钩子方法，这些方法都会在 Zone 的各个生命周期钩子中被调用；</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// NgZone</span>
<span class="token class-name">NgZone</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">onEnter</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_nesting<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isStable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_isStable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_onUnstable<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">NgZone</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">onLeave</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_nesting<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkStable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">NgZone</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setHasMicrotask</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">hasMicrotasks</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_hasPendingMicrotasks <span class="token operator">=</span> hasMicrotasks<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkStable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">NgZone</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setHasMacrotask</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">hasMacrotasks</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_hasPendingMacrotasks <span class="token operator">=</span> hasMacrotasks<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">NgZone</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">triggerError</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_onErrorEvents<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>当 NgZone run 之后，Angular 便会实例化一个叫做 <code>ApplicationRef</code> 的类，其中的 onMicrotaskEmpty 监听到后就会触发变更检测；</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ...  </span>
<span class="token keyword">class</span> <span class="token class-name">ApplicationRef</span> <span class="token punctuation">{</span>
    _views<span class="token operator">:</span>Array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> zone<span class="token operator">:</span> NgZone</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">// onMicrotaskEmpty 事件会在当前 Zone 中的异步过程都已完成时触发</span>
      	<span class="token comment">// 当监听到此事件后就去遍历 View 并且调用每个 view 的 detectChanges 方法来进行变更检查</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>zone<span class="token punctuation">.</span>onMicrotaskEmpty<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zone<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_runningTick <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_views<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">view</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>  view<span class="token punctuation">.</span>ref<span class="token punctuation">.</span><span class="token function">detectChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意：并非所有异步操作都有必要触发变更检查；比如某次异步操作，却没有数据发生变化，则应不必触发；而由于 Angular 应用运行在 NgZone 之中，所有在 NgZone 之中的异步操作都会通知框架进行变更检查；为此，NgZone 提供了一个 <code>runOutsideAngular</code> 方法，可供方法在 NgZone 之外运行，而不会触发 Angular 的变更检查，示例见前文，<a href="http://plnkr.co/edit/j9W2op4lGezi8eexwHg6?p=preview" target="_blank" rel="noopener noreferrer">或看此<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h1 id="四、再述变更检测"><a href="#四、再述变更检测" class="header-anchor">#</a> 四、再述变更检测</h1> <p>以下内容<u>基于 Angular2.4.9</u>，补充 JIT 与 AOT 机制：</p> <ul><li>JIT：吞吐量高，有运行时性能加成，可跑得更快，并可做到动态生成代码等，但相对启动速度较慢，并需一定时间和调用频率才能触发 JIT 的分层机制证；</li> <li>AOT：内存占用低启动速度快，无需 runtime 运行，直接将 runtime 静态链接至最终程序中，但无运行时性能加成，不能根据程序运行情况做进一步优化；</li></ul> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124141.png" align="" style="zoom:50%;"> <p>非 AOT 模式下 Angular 将在运行时利用 JIT 机制，创建组件的包装类，框架将会为每个组件生成相应的包装类，也即对于每一个组件来讲，Angular 会为其生成至少两个类型 <code>View_ClassName_App</code> 和 <code>Wrapper_ClassName_App</code>，根组件还会生成一个 <code>View_ClassNameApp_Host</code>，来作为应用组件的入口，变更检查也是从这个地方开始；<code>Wrapper_ClassName_App</code> 类主要是提供了组件的生命周期钩子，<code>View_ClassName_App</code> 类主要做了下面5件事：</p> <ul><li>注入依赖；</li> <li>创建组件中的 DOM 元素渲染页面；</li> <li>响应绑定的事件；</li> <li>利用类型为 <code>changeDetectorRef</code> 的变更检查器执行变更检查；</li> <li>提供 debug 信息；</li></ul> <p>Angular 应用是由组件组成的树，每个组件又有自己的变更检查器，于是变更检查器们也组成了一颗变更检查器树；</p> <p>无论哪一个组件的变更检查被触发时 Angular 都会采用 <strong><u><em>深度优先遍历</em></u></strong> 方式从根节点遍历整个变更检查器树；在 JIT 模式下，这些变更检查器会被编译成为 <code>View_ClassName_App</code> 中的<code>detectChangesInternal</code> 方法，在这个方法中组件会对自己内部的数据绑定进行检查，调用自己的 <code>ngOnChanges</code> 生命周期方法，若有子组件则还会调用子组件 <code>internalDetectChanges</code> 方法，如此不断，将检查沿着树枝的方向进行下去，如下图；此树也可描述 Angular 中组件的数据流是从上往下流动(原因是变更检查也是从上到下)；</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124142.png" align="" style="zoom:50%;"> <p><strong><u><em>比如</em></u></strong>：在文本框中输入文字时，就会马上触发组件的变更检查，此时调用了 <code>View_InventoryApp0.detectChangesInternal</code> 方法：</p> <p><strong><u><em>首先</em></u></strong>，仔细留意末行，调用了 <code>jit_checkBinding25</code> 方法，其会比较新旧两个值是否相同，此方法是框架编译生成的方法，在运行时找到实际上调用的是 <code>view_utils.checkBinding</code> 方法，若<code>throwOnChange</code> 的值为 false，则使用 <code>looseIdentical</code> 来进行新旧值的比较，方法存在于 lang.js：</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124143.png" align="" style="zoom:50%;"> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124144.png" align="" style="zoom:70%;"> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">looseIdentical</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">===</span> b <span class="token operator">||</span> <span class="token keyword">typeof</span> a <span class="token operator">===</span> <span class="token string">'number'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> b <span class="token operator">===</span> <span class="token string">'number'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNaN</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNaN</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 注意: 只是简单比较了引用或者值是否相同，并无做深度比较；所以数组或者对象等集合类型内部的值发生变化，Angular 并不能检查到</span>
</code></pre></div><p><strong><u><em>然后</em></u></strong>，Angular 在检查变更之后立即更新了视图：</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124145.png" align="" style="zoom:80%;"> <div class="language- extra-class"><pre class="language-text"><code>if (jit_checkBinding24(throwOnChange,self._expr_32,currVal_32)) {
    self.renderer.setText(self._text_5,currVal_32);
    self._expr_32 = currVal_32;
}
</code></pre></div><p>当前组件所有的变更检查执行完成后，开始检查子组件的变更，然后变更检查器会按照深度优先的规则遍历整个组件树，直到所有节点的变更检查都完成为止；</p> <p>由于单向数据流的原因，变更检查只需要执行一遍就可稳定下来，若在首次检查中产生副作用使得已检查过的节点发生了变化，Angular 会抛出异常(在开发模式开启二次检查机制，以避免上线发生此种情况)；抛出前面提到错误 ExpressionChangedAfterItHasBeenCheckedError；</p> <p><strong><u><em>优化：OnPush 策略</em></u></strong></p> <p>默认情况下，Angular使用<code>ChangeDetectionStrategy.Default</code>策略来进行变更检测；而在此 Default 模式下，每一组异步操作结束后(用户事件、记时器、XHR、promise等事件使应用中的数据将发生了改变时)，都会触发对整个组件树的变更检查；</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 子组件</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h1&gt;Hello {{name}}!&lt;/h1&gt;
    {{runChangeDetection}}
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HelloComponent</span> <span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> name<span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token keyword">get</span> <span class="token function">runChangeDetection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Checking the view'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 根组件</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;hello&gt;&lt;/hello&gt;
    &lt;button (click)=&quot;onClick()&quot;&gt;Trigger change detection&lt;/button&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span>  <span class="token punctuation">{</span>
  <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 执行以上代码后，每当我们点击按钮时。Angular 将会执行一遍变更检测循环，此时还会输出 &quot;Checking the view&quot;</span>
<span class="token comment">// 这种技术被称作脏检查。为了知道视图是否需要更新，Angular 需要访问新值并和旧值比较来判断是否需要更新视图;</span>
<span class="token comment">// 注意: 如果有一个有成千上万个表达式的大应用，Angular 去检查每一个表达式，我们可能会遇到性能上的问题;</span>
</code></pre></div><p>但在某些场景下，某些组件是不需要每次都被检查，此时可启用 OnPush 模式，与 Angular 约定强制使用不可变对象，Angular 将跳过对该组件的全部变化监测(含子组件)，直到有属性的引用发生变化为止，来避免不必要的变更检查以提升应用性能；</p> <ul><li>补充：不可变对象：保证对象不会改变，即当其内部属性发生变化时，将会用新对象来替代旧对象；不可变对象仅仅依赖初始化时的属性，也即初始化时候属性没有改变，没有改变就不会产生一份新的引用；</li></ul> <p>若需要在 Angular 中使用不可变对象，则需要设置 <code>changeDetection: ChangeDetectionStrategy.OnPush</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 开启 OnPush 策略</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>OnPush
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">InventoryApp</span> <span class="token punctuation">{</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这将告诉Angular该组件仅仅依赖于它的<code>@inputs()</code>，只有在以下几种情况才需要检查：</p> <p><strong><u><em>1、Input 引用发生改变</em></u></strong></p> <p>在变更检测的上下文中使用不可变对象好处是：Angular 可通过检查引用是否发生了改变来判断视图是否需要检查；这比深度检查要容易很多：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 子组件</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'tooltip'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h1&gt;{{config.position}}&lt;/h1&gt;
    {{runChangeDetection}}
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token comment">// 开启 OnPush</span>
  changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>OnPush
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TooltipComponent</span>  <span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> config<span class="token punctuation">;</span>
  <span class="token keyword">get</span> <span class="token function">runChangeDetection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Checking the view'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 父组件</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;tooltip [config]=&quot;config&quot;&gt;&lt;/tooltip&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span>  <span class="token punctuation">{</span>
  config <span class="token operator">=</span> <span class="token punctuation">{</span>
    position<span class="token operator">:</span> <span class="token string">'top'</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">// config 引用地址未改变，子组件将不会进行变更检测，不会进行新旧值比较 if( oldValue !== newValue ) {  runChangeDetection(); }，视图未刷新</span>
  <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">'bottom'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// config 引用地址改变后，视图被检查，新值被展示</span>
  <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> <span class="token punctuation">{</span>
      position<span class="token operator">:</span> <span class="token string">'bottom'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//  注意: 此时点击按钮时看不到任何日志，因为 Angular 将旧值和新值的引用进行比较，上述变量的引用地址未被改变，故未被触发</span>
</code></pre></div><p><strong><u><em>2、源于该组件或其子组件的事件</em></u></strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 当在一个组件或者其子组件中触发了某一个事件时，这个组件的内部状态会更新</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;button (click)=&quot;add()&quot;&gt;Add&lt;/button&gt;
    {{count}}
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token comment">// 开启 OnPush</span>
  changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>OnPush
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterComponent</span> <span class="token punctuation">{</span>
  count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 注意：此规则只适用于 DOM 事件，API 并不会触发变更检测</span>
<span class="token comment">// 下列情况中，count 属性发生改变但视图未更改，只有点击时才会更改，但视图会显示 x+1，而非显示 0+1 的 1</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token comment">// 开启 OnPush</span>
  changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>OnPush
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterComponent</span> <span class="token punctuation">{</span>
  count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'https://count.com'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong><u><em>3、显式的去执行变更检测</em></u></strong></p> <p>Angular给我们提供了3种方法来触发变更检测：</p> <ul><li><code>detectChanges()</code>：告诉 Angular 在该组件和它的子组件中去执行变更检测；</li> <li><code>ApplicationRef.tick()</code>：告诉 Angular 来对整个应用程序执行变更检测；</li> <li><code>markForCheck()</code>：它不会触发变更检测；相反，它会将所有设置了onPush 的祖先标记，在当前或下一次变更检测循环中检测；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// detectChanges </span>
<span class="token comment">// 告诉 Angular 在该组件和它的子组件中去执行变更检测</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'counter'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{{count}}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>OnPush
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterComponent</span> <span class="token punctuation">{</span> 
  count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> cdr<span class="token operator">:</span> ChangeDetectorRef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>cdr<span class="token punctuation">.</span><span class="token function">detectChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// tick</span>
<span class="token comment">// 告诉 Angular 来对整个应用程序执行变更检测；</span>
<span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_views<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">view</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> view<span class="token punctuation">.</span><span class="token function">detectChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// markForCheck</span>
<span class="token comment">// 它不会触发变更检测；相反，它会将所有设置了onPush 的祖先标记，在当前或下一次变更检测循环中检测；</span>
<span class="token function">markForCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> 
  <span class="token function">markParentViewsForCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_view<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">markParentViewsForCheck</span><span class="token punctuation">(</span><span class="token parameter">view<span class="token operator">:</span> ViewData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> currView<span class="token operator">:</span> ViewData<span class="token operator">|</span><span class="token keyword">null</span> <span class="token operator">=</span> view<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>currView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currView<span class="token punctuation">.</span>def<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ViewFlags<span class="token punctuation">.</span>OnPush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currView<span class="token punctuation">.</span>state <span class="token operator">|=</span> ViewState<span class="token punctuation">.</span>ChecksEnabled<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    currView <span class="token operator">=</span> currView<span class="token punctuation">.</span>viewContainerParent <span class="token operator">||</span> currView<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong><u><em>4、Angular Async Pipe</em></u></strong></p> <p><code>async</code> pipe会订阅一个 Observable 或 Promise，并返回它发出的最近一个值；</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 一个 input() 是 observable 的 OnPush 组件</span>
<span class="token comment">// 点击按钮并不能看到视图更新，因为上述提到的几种情况均未发生，所以 Angular 在当前变更检测循环并不会检查该组件</span>
<span class="token comment">// App 组件</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;button (click)=&quot;add()&quot;&gt;Add&lt;/button&gt;
    &lt;app-list [items$]=&quot;items$&quot;&gt;&lt;/app-list&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  items$ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BehaviorSubject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> title<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>items$<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// List 组件</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
     &lt;div *ngFor=&quot;let item of _items ; &quot;&gt;{{item.title}}&lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>OnPush
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ListComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> items<span class="token operator">:</span> Observable<span class="token operator">&lt;</span>Item<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  _items<span class="token operator">:</span> Item<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Observable </span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">items</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_items <span class="token operator">=</span> items<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Use Async Pipe</span>
<span class="token comment">// 当点击按钮时，视图也更新了，原因是当新的值被发射出来时，async pipe 将该组件标记为发生了更改需要检查</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div *ngFor=&quot;let item of items | async&quot;&gt;{{item.title}}&lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>OnPush
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ListComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> items<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// async pipe 内部原理实际还是利用 markForCheck</span>
<span class="token comment">// 所以上述情况中，Angular 为其调用 markForCheck()，所以能看到视图更新了即使 input 引用没有发生改变</span>
<span class="token keyword">private</span> <span class="token function">_updateLatestValue</span><span class="token punctuation">(</span>async<span class="token operator">:</span> any<span class="token punctuation">,</span> value<span class="token operator">:</span> Object<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>async <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_latestValue <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_ref<span class="token punctuation">.</span><span class="token function">markForCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 懵：如果一个组件仅仅依赖于它的input属性，并且input属性是observable，那么这个组件只有在它的input属性发射一个事件的时候才会发生改变</span>
</code></pre></div><p><strong><u><em>OnPush 与视图检查：</em></u></strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 父组件 Tabs</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-tabs'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;ng-content&gt;&lt;/ng-content&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TabsComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取 tab 子组件</span>
  @<span class="token function">ContentChild</span><span class="token punctuation">(</span>TabComponent<span class="token punctuation">)</span> tab<span class="token operator">:</span> TabComponent<span class="token punctuation">;</span>
  <span class="token function">ngAfterContentInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tab<span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token string">'Content'</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 子组件 Tab</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-tab'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{{content}}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token comment">// 开启 OnPush</span>
  changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>OnPush
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TabComponent</span> <span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> content<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span>app<span class="token operator">-</span>tabs<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>app<span class="token operator">-</span>tab<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>app<span class="token operator">-</span>tab<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>app<span class="token operator">-</span>tabs<span class="token operator">&gt;</span>
<span class="token comment">// 注意，上述 Angular 不知道正在更新 tab 组件的 input 属性</span>
<span class="token comment">// 在模板中定义 input()是让 Angular 知道应在变更检测循环中检查此属性的唯一途径;</span>
<span class="token comment">// 在模板中定义 input()是让 Angular 知道应在变更检测循环中检查此属性的唯一途径;</span>
<span class="token comment">// 在模板中定义 input()是让 Angular 知道应在变更检测循环中检查此属性的唯一途径;</span>

<span class="token comment">// 比如</span>
<span class="token comment">// 若明确的在模板中定义了 input()，Angular 会创建一个叫 updateRenderer() 方法，它会在每个变更检测循环中都对 content 的值进行追踪。</span>
<span class="token comment">// &lt;app-tabs&gt;</span>
<span class="token comment">//   &lt;app-tab [content]=&quot;content&quot;&gt;&lt;/app-tab&gt;</span>
<span class="token comment">// &lt;/app-tabs&gt;</span>

<span class="token comment">// 在这种情况下, 即未添加 input，简单的解决办法使用setter然后调用markForCheck()。</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-tab'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    {{_content}}
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>OnPush
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TabComponent</span> <span class="token punctuation">{</span>
  _content<span class="token punctuation">;</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">set</span> <span class="token function">content</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_content <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cdr<span class="token punctuation">.</span><span class="token function">markForCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> cdr<span class="token operator">:</span> ChangeDetectorRef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong><u><em>OnPush++</em></u></strong></p> <p>onPush组件越多，Angular需要执行的检查就越少</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1、原版</span>
<span class="token comment">// 一个 todos 组件，它有一个 todos 作为 input()。</span>
<span class="token comment">// todos 组件</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-todos'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
     &lt;div *ngFor=&quot;let todo of todos&quot;&gt;
       {{todo.title}} - {{runChangeDetection}}
     &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>OnPush
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TodosComponent</span> <span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> todos<span class="token punctuation">;</span>
  <span class="token keyword">get</span> <span class="token function">runChangeDetection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'TodosComponent - Checking the view'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// App 组件</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;button (click)=&quot;add()&quot;&gt;Add&lt;/button&gt;
    &lt;app-todos [todos]=&quot;todos&quot;&gt;&lt;/app-todos&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  todos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'One'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'Two'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>todos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>todos<span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'Three'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 缺点: 当单击添加按钮时，即使之前的数据没有任何更改，Angular 也需要检查每个 todo。因此第一次单击后，控制台中将显示三个日志。</span>
<span class="token comment">// 但在上面的示例中，只有一个表达式需要检查，但是想象一下如果是一个有多个绑定（ngIf，ngClass，表达式等）的真实组件，这将会非常耗性能, 且白白的执行变更检测</span>



<span class="token comment">// 2、优化版</span>
<span class="token comment">// 创建一个 todo 组件并将其变更检测策略定义为 onPush</span>
<span class="token comment">// todo 组件</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-todo'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{{todo.title}} {{runChangeDetection}}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>OnPush
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TodoComponent</span> <span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> todo<span class="token punctuation">;</span>
  <span class="token keyword">get</span> <span class="token function">runChangeDetection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'TodoComponent - Checking the view'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// todos 组件</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-todos'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;app-todo [todo]=&quot;todo&quot; *ngFor=&quot;let todo of todos&quot;&gt;&lt;/app-todo&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>OnPush
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TodosComponent</span> <span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> todos<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// App 组件</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;button (click)=&quot;add()&quot;&gt;Add&lt;/button&gt;
    &lt;app-todos [todos]=&quot;todos&quot;&gt;&lt;/app-todos&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  todos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'One'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'Two'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>todos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>todos<span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'Three'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 现在，当我们单击添加按钮时，控制台中只会看到一个日志，因为其他的 todo 组件的 input 均未更改，因此不会去检查其视图</span>
<span class="token comment">// 并且，通过创建更小粒度的组件，我们的代码变得更具可读性和可重用性</span>
</code></pre></div><p><strong><u><em>OnPush示例</em></u></strong>：</p> <p><a href="https://plnkr.co/edit/zGNlvnYsPSKbQPv7HxX3?p=preview&amp;preview" target="_blank" rel="noopener noreferrer">示例地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>；黄色部分是父组件，灰色的部分是子组件，子组件开启了 OnPush 模式；</p> <p>当点击黄色部分时，虽改变了 <code>this.person.name</code> 值，但是此变化并不能被框架检测到，也即反映在视图上；因为开启了 OnPush 模式的组件，它的变更检查器将会被关闭，它与它的子节点都无法再检查到父组件带来的变更；但注意：由节点内部产生的变化依然会触发变更检查；</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124146.png" align="" style="zoom:50%;"> <p>点击灰色部分，也即被设置为 OnPush 模式的子组件，此时触发了子组件中的 onclick 方法，改变了 <code>this.person.name</code> 的值，由于此变更是由子组件内部事件导致，这时将会触发变更检查，视图上的文字也会被更新；</p> <h1 id="五、变更检测机制再总结"><a href="#五、变更检测机制再总结" class="header-anchor">#</a> 五、变更检测机制再总结</h1> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200923124147.png" align="" style="zoom:50%;"> <ol><li>Zone.js 为浏览器 API 打补丁</li> <li>NgZone 初始化，监听当前 Zone 中的异步事件执行是否完成</li> <li>异步事件执行结束后出发 tick 方法开始变更检查</li> <li>变更检查由根组件开始按照深度优先遍历变更检查器树</li> <li>在每个数据绑定的检查结束之后，立即更新视图</li> <li>在继续检查子组件直到所有组件检查完成</li></ol></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">最后更新: </span> <span class="time">10/6/2020, 11:28:03 AM</span></div></footer> <!----> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.58d463af.js" defer></script><script src="/assets/js/3.5b6bd7ce.js" defer></script><script src="/assets/js/1.53e5735b.js" defer></script><script src="/assets/js/148.fccbb459.js" defer></script>
  </body>
</html>
