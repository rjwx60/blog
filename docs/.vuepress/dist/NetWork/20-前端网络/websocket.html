<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一、发展 | Leibnize 个人学习笔记</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="整理自网络">
    <link rel="preload" href="/assets/css/0.styles.a3549ad8.css" as="style"><link rel="preload" href="/assets/js/app.f95d0077.js" as="script"><link rel="preload" href="/assets/js/3.49babee5.js" as="script"><link rel="preload" href="/assets/js/1.269e4bda.js" as="script"><link rel="preload" href="/assets/js/163.00e98ea9.js" as="script"><link rel="prefetch" href="/assets/js/10.6aa86c9d.js"><link rel="prefetch" href="/assets/js/100.2d552503.js"><link rel="prefetch" href="/assets/js/101.380eba67.js"><link rel="prefetch" href="/assets/js/102.4bd44e2f.js"><link rel="prefetch" href="/assets/js/103.c3ba7b95.js"><link rel="prefetch" href="/assets/js/104.93048938.js"><link rel="prefetch" href="/assets/js/105.640b5e1a.js"><link rel="prefetch" href="/assets/js/106.703adc14.js"><link rel="prefetch" href="/assets/js/107.991cb147.js"><link rel="prefetch" href="/assets/js/108.f2bd0aec.js"><link rel="prefetch" href="/assets/js/109.1d937267.js"><link rel="prefetch" href="/assets/js/11.a1d51055.js"><link rel="prefetch" href="/assets/js/110.332390f4.js"><link rel="prefetch" href="/assets/js/111.71635c45.js"><link rel="prefetch" href="/assets/js/112.2ac200df.js"><link rel="prefetch" href="/assets/js/113.46405151.js"><link rel="prefetch" href="/assets/js/114.58fa21b5.js"><link rel="prefetch" href="/assets/js/115.fa6a329a.js"><link rel="prefetch" href="/assets/js/116.37141fb0.js"><link rel="prefetch" href="/assets/js/117.d001fc73.js"><link rel="prefetch" href="/assets/js/118.217b3c9e.js"><link rel="prefetch" href="/assets/js/119.c8e2d03c.js"><link rel="prefetch" href="/assets/js/12.a5c78b74.js"><link rel="prefetch" href="/assets/js/120.f21f9f6d.js"><link rel="prefetch" href="/assets/js/121.610858f8.js"><link rel="prefetch" href="/assets/js/122.5e106cb5.js"><link rel="prefetch" href="/assets/js/123.83e9e543.js"><link rel="prefetch" href="/assets/js/124.fe964328.js"><link rel="prefetch" href="/assets/js/125.48103cb8.js"><link rel="prefetch" href="/assets/js/126.9f3a9a43.js"><link rel="prefetch" href="/assets/js/127.53393403.js"><link rel="prefetch" href="/assets/js/128.718bab74.js"><link rel="prefetch" href="/assets/js/129.94bb906d.js"><link rel="prefetch" href="/assets/js/13.6b06e1eb.js"><link rel="prefetch" href="/assets/js/130.f3cb1be6.js"><link rel="prefetch" href="/assets/js/131.b4e741b6.js"><link rel="prefetch" href="/assets/js/132.dbf75e28.js"><link rel="prefetch" href="/assets/js/133.0f2404ed.js"><link rel="prefetch" href="/assets/js/134.d17dc9c2.js"><link rel="prefetch" href="/assets/js/135.a7c3e822.js"><link rel="prefetch" href="/assets/js/136.2401894d.js"><link rel="prefetch" href="/assets/js/137.6b5d51b3.js"><link rel="prefetch" href="/assets/js/138.46e98d9d.js"><link rel="prefetch" href="/assets/js/139.080c5130.js"><link rel="prefetch" href="/assets/js/14.1f5e418e.js"><link rel="prefetch" href="/assets/js/140.d7deb0d2.js"><link rel="prefetch" href="/assets/js/141.21a0a960.js"><link rel="prefetch" href="/assets/js/142.fe31183f.js"><link rel="prefetch" href="/assets/js/143.8adbd910.js"><link rel="prefetch" href="/assets/js/144.2ad689e4.js"><link rel="prefetch" href="/assets/js/145.95a4a1d7.js"><link rel="prefetch" href="/assets/js/146.45bec800.js"><link rel="prefetch" href="/assets/js/147.93101868.js"><link rel="prefetch" href="/assets/js/148.b534d0a2.js"><link rel="prefetch" href="/assets/js/149.b1d993db.js"><link rel="prefetch" href="/assets/js/15.f2f6dc7a.js"><link rel="prefetch" href="/assets/js/150.e7147d10.js"><link rel="prefetch" href="/assets/js/151.4ef25d94.js"><link rel="prefetch" href="/assets/js/152.e5d9d094.js"><link rel="prefetch" href="/assets/js/153.6b6e0642.js"><link rel="prefetch" href="/assets/js/154.25250e56.js"><link rel="prefetch" href="/assets/js/155.34ae60ca.js"><link rel="prefetch" href="/assets/js/156.26b776db.js"><link rel="prefetch" href="/assets/js/157.ac214951.js"><link rel="prefetch" href="/assets/js/158.8160576b.js"><link rel="prefetch" href="/assets/js/159.87970e93.js"><link rel="prefetch" href="/assets/js/16.f38d5aa1.js"><link rel="prefetch" href="/assets/js/160.cb31f27b.js"><link rel="prefetch" href="/assets/js/161.63da7c1d.js"><link rel="prefetch" href="/assets/js/162.d6265c5a.js"><link rel="prefetch" href="/assets/js/164.489d3ece.js"><link rel="prefetch" href="/assets/js/165.14a0ac69.js"><link rel="prefetch" href="/assets/js/17.47f92d25.js"><link rel="prefetch" href="/assets/js/18.939679b9.js"><link rel="prefetch" href="/assets/js/19.4b5e11ca.js"><link rel="prefetch" href="/assets/js/20.e4c5a5c1.js"><link rel="prefetch" href="/assets/js/21.886994a9.js"><link rel="prefetch" href="/assets/js/22.6848ca70.js"><link rel="prefetch" href="/assets/js/23.6685f31e.js"><link rel="prefetch" href="/assets/js/24.6ffcbee7.js"><link rel="prefetch" href="/assets/js/25.b468ab2a.js"><link rel="prefetch" href="/assets/js/26.ae4ec095.js"><link rel="prefetch" href="/assets/js/27.d68ba8c4.js"><link rel="prefetch" href="/assets/js/28.77526965.js"><link rel="prefetch" href="/assets/js/29.b51bc369.js"><link rel="prefetch" href="/assets/js/30.f34ad8ea.js"><link rel="prefetch" href="/assets/js/31.ea5d0968.js"><link rel="prefetch" href="/assets/js/32.266fe651.js"><link rel="prefetch" href="/assets/js/33.9f3a4b59.js"><link rel="prefetch" href="/assets/js/34.92302c41.js"><link rel="prefetch" href="/assets/js/35.258e2870.js"><link rel="prefetch" href="/assets/js/36.7b3f62cb.js"><link rel="prefetch" href="/assets/js/37.91e68fdc.js"><link rel="prefetch" href="/assets/js/38.35c7427c.js"><link rel="prefetch" href="/assets/js/39.565f94d6.js"><link rel="prefetch" href="/assets/js/4.ea3b0bd5.js"><link rel="prefetch" href="/assets/js/40.1df5e2f3.js"><link rel="prefetch" href="/assets/js/41.5b364c9b.js"><link rel="prefetch" href="/assets/js/42.bc29f49d.js"><link rel="prefetch" href="/assets/js/43.2c830543.js"><link rel="prefetch" href="/assets/js/44.db617450.js"><link rel="prefetch" href="/assets/js/45.6d82cbe7.js"><link rel="prefetch" href="/assets/js/46.f36ad277.js"><link rel="prefetch" href="/assets/js/47.11cd07e6.js"><link rel="prefetch" href="/assets/js/48.e03a4e77.js"><link rel="prefetch" href="/assets/js/49.b08b0835.js"><link rel="prefetch" href="/assets/js/5.97a7c0dc.js"><link rel="prefetch" href="/assets/js/50.c4648d27.js"><link rel="prefetch" href="/assets/js/51.e983cd13.js"><link rel="prefetch" href="/assets/js/52.16e738d5.js"><link rel="prefetch" href="/assets/js/53.bd8c1968.js"><link rel="prefetch" href="/assets/js/54.3e19ee76.js"><link rel="prefetch" href="/assets/js/55.b8ad26cd.js"><link rel="prefetch" href="/assets/js/56.311bfbe6.js"><link rel="prefetch" href="/assets/js/57.0f045ba5.js"><link rel="prefetch" href="/assets/js/58.239e8404.js"><link rel="prefetch" href="/assets/js/59.7b687abb.js"><link rel="prefetch" href="/assets/js/6.8e992509.js"><link rel="prefetch" href="/assets/js/60.4e343674.js"><link rel="prefetch" href="/assets/js/61.db6e32e6.js"><link rel="prefetch" href="/assets/js/62.fc3fc01f.js"><link rel="prefetch" href="/assets/js/63.fa9e1bd1.js"><link rel="prefetch" href="/assets/js/64.994d7527.js"><link rel="prefetch" href="/assets/js/65.267b048d.js"><link rel="prefetch" href="/assets/js/66.8c5f0b3d.js"><link rel="prefetch" href="/assets/js/67.74a9ded5.js"><link rel="prefetch" href="/assets/js/68.dd40f558.js"><link rel="prefetch" href="/assets/js/69.00fccbea.js"><link rel="prefetch" href="/assets/js/7.159745e4.js"><link rel="prefetch" href="/assets/js/70.ef8c338c.js"><link rel="prefetch" href="/assets/js/71.25a9bd58.js"><link rel="prefetch" href="/assets/js/72.0959ee8f.js"><link rel="prefetch" href="/assets/js/73.e154307b.js"><link rel="prefetch" href="/assets/js/74.76863de9.js"><link rel="prefetch" href="/assets/js/75.6978bd97.js"><link rel="prefetch" href="/assets/js/76.4a2f4182.js"><link rel="prefetch" href="/assets/js/77.0f06f3c0.js"><link rel="prefetch" href="/assets/js/78.66c253a1.js"><link rel="prefetch" href="/assets/js/79.6c37b127.js"><link rel="prefetch" href="/assets/js/8.eaef2fb9.js"><link rel="prefetch" href="/assets/js/80.2dda282c.js"><link rel="prefetch" href="/assets/js/81.cd9437e7.js"><link rel="prefetch" href="/assets/js/82.c5a84712.js"><link rel="prefetch" href="/assets/js/83.b8a2f734.js"><link rel="prefetch" href="/assets/js/84.ede1cd7a.js"><link rel="prefetch" href="/assets/js/85.e649a4e5.js"><link rel="prefetch" href="/assets/js/86.38274fa9.js"><link rel="prefetch" href="/assets/js/87.472635cc.js"><link rel="prefetch" href="/assets/js/88.cf02af57.js"><link rel="prefetch" href="/assets/js/89.03ef81d7.js"><link rel="prefetch" href="/assets/js/9.ee3f327d.js"><link rel="prefetch" href="/assets/js/90.4a497f88.js"><link rel="prefetch" href="/assets/js/91.7271b82b.js"><link rel="prefetch" href="/assets/js/92.cd04960f.js"><link rel="prefetch" href="/assets/js/93.342921b6.js"><link rel="prefetch" href="/assets/js/94.f5d3d498.js"><link rel="prefetch" href="/assets/js/95.940fefe6.js"><link rel="prefetch" href="/assets/js/96.fdbcc350.js"><link rel="prefetch" href="/assets/js/97.73aba549.js"><link rel="prefetch" href="/assets/js/98.937f6a6d.js"><link rel="prefetch" href="/assets/js/99.bcd70353.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a3549ad8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-dad8a512><div data-v-dad8a512><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-dad8a512 data-v-dad8a512><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-dad8a512 data-v-dad8a512><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>Leibnize 个人学习笔记</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Leibnize 个人学习笔记</span>
            
          <!---->
          2020
        </a></span></div></div> <div class="hide" data-v-dad8a512><header class="navbar" data-v-dad8a512><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Leibnize 个人学习笔记</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/rjwx60" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-dad8a512></div> <aside class="sidebar" data-v-dad8a512><div class="personal-info-wrapper" data-v-ca798c94 data-v-dad8a512><!----> <h3 class="name" data-v-ca798c94>
    Leibnize 个人学习笔记
  </h3> <div class="num" data-v-ca798c94><div data-v-ca798c94><h3 data-v-ca798c94>0</h3> <h6 data-v-ca798c94>Article</h6></div> <div data-v-ca798c94><h3 data-v-ca798c94>0</h3> <h6 data-v-ca798c94>Tag</h6></div></div> <hr data-v-ca798c94></div> <nav class="nav-links"><div class="nav-item"><a href="https://github.com/rjwx60" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/Basics/" class="sidebar-heading clickable open"><span>前端专题</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/01-前端基础" class="sidebar-heading clickable open"><span>01-前端基本</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Basics/01-前端基础/HTML.html" class="sidebar-link">一、HTML</a></li><li><a href="/Basics/01-前端基础/CSS.html" class="sidebar-link">二、CSS</a></li><li><a href="/Basics/01-前端基础/DOMBOM.html" class="sidebar-link">三、DOMBOM</a></li><li><a href="/Basics/01-前端基础/Summary.html" class="sidebar-link">四、Summary</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/02-前端性能" class="sidebar-heading clickable"><span>02-前端性能</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/03-前端工程" class="sidebar-heading clickable"><span>03-前端工程</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/04-前端异步" class="sidebar-heading clickable"><span>04-前端异步</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/05-前端设计" class="sidebar-heading clickable"><span>05-前端设计</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/06-前端数据" class="sidebar-heading clickable"><span>06-前端数据</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/07-前端安全" class="sidebar-heading clickable"><span>07-前端安全</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/08-前端概念" class="sidebar-heading clickable"><span>08-前端概念</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/09-前端实现" class="sidebar-heading clickable"><span>09-前端实现</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/10-前端新标" class="sidebar-heading clickable"><span>10-前端新标</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/11-前端会话" class="sidebar-heading clickable"><span>11-前端会话</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/12-前端框架" class="sidebar-heading clickable"><span>12-前端框架</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/14-浏览器相关" class="sidebar-heading clickable"><span>14-浏览器相关</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/15-前端核心" class="sidebar-heading clickable"><span>15-前端核心</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Basics/16-前端Node" class="sidebar-heading clickable"><span>16-前端Node</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/NetWork/" class="sidebar-heading clickable router-link-active"><span>网络专题</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/NetWork/20-前端网络" class="sidebar-heading clickable open"><span>20-前端网络</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/NetWork/20-前端网络/base.html" class="sidebar-link">一、基本</a></li><li><a href="/NetWork/20-前端网络/ip.html" class="sidebar-link">二、IP</a></li><li><a href="/NetWork/20-前端网络/tcp.html" class="sidebar-link">三、TCP</a></li><li><a href="/NetWork/20-前端网络/dns.html" class="sidebar-link">四、DNS</a></li><li><a href="/NetWork/20-前端网络/http.html" class="sidebar-link">五、HTTP</a></li><li><a href="/NetWork/20-前端网络/websocket.html" class="active sidebar-link">六、Websocket</a></li><li><a href="/NetWork/20-前端网络/Summary.html" class="sidebar-link">七、Summary</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/Algorithm/" class="sidebar-heading clickable"><span>算法专题</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Algorithm/30-前端算法" class="sidebar-heading clickable open"><span>30-前端算法</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Algorithm/30-前端算法/排序.html" class="sidebar-link">X、排序</a></li><li><a href="/Algorithm/30-前端算法/Summary.html" class="sidebar-link">X、Summary</a></li></ul></section></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-dad8a512><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e></h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Leibnize 个人学习笔记</span>
            
          <!---->
          2020
        </a></span></div></div> <div data-v-dad8a512><main class="page"><div class="page-title" style="display:none;"><h1>一、发展</h1> <div data-v-3b7f5bdf><i class="iconfont reco-account" data-v-3b7f5bdf><span data-v-3b7f5bdf>Leibnize 个人学习笔记</span></i> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default" style="display:none;"><h1 id="一、发展"><a href="#一、发展" class="header-anchor">#</a> 一、发展</h1> <h2 id="_1-1、问题"><a href="#_1-1、问题" class="header-anchor">#</a> 1-1、问题</h2> <p>传统 HTTP 先天不支持持久连接(HTTP2支持—通过数据帧)，而 HTTP1并发能力是依赖同时发起多个 TCP 连接访问服务器实现(但并发数受限于浏览器允许的最大并发连接数)，且还有 TCP 慢启动特性(新连接速度提升需要时间)，及连接本身握手损耗等问题；</p> <p>虽可通过下列方式建立长连接，但这些长连接是伪的，因为<u>通讯双方需携带几百上千字节的大量重复 header(甚至数据部分还没有头部部分大)</u>(无状态协议，须头部以鉴别)，信息交换效率低下，但实现简单，无需作架构升级即可使用：</p> <ul><li>keep-alive：HTTP1.1引入，即在一个 TCP 连接中完成多个 HTTP 请求，但每次请求仍需单独发送 Header；</li> <li>polling：指客户端不断向服务器发送 HTTP 请求，查询是否有新数据；</li></ul> <p>此种背景下，若客户端想要及时获取最新信息(即时通讯技术)，一般基于 4(+2)种形式：</p> <p><u>轮询-polling</u>：客户端和服务器间会一直进行连接，每隔一段时间就询问一次；前端通常采取setInterval 或 setTimeout 去不断的请求服务器数据；</p> <ul><li>优点：实现简单，适合处理的异步查询业务；</li> <li>缺点：轮询时间通常固定，过长不实时过短增加服务端负担；而请求大部分无意义，浪费服务端资源；且要求服务端有较快处理速度与相应资源；</li></ul> <p><u>长轮询-long polling</u>：即轮询+阻塞模型；客户端发送请求到服务端，若服务端没有新的数据，就保持住这个连接直到有数据。一旦服务端有了数据(消息)给客户端，它就使用这个连接发送数据给客户端；接着连接关闭；随后客户端再次发起同样连接，循环往复；</p> <ul><li>优点：对比轮询做了优化，有较好的时效性；</li> <li>缺点：占较多的内存资源与请求数；<u>服务端仍无法主动联系客户端，且需要有高并发处理能力</u>；</li></ul> <p><u>iframe流</u>：即在浏览器中动态载入一个 iframe，并让其地址指向请求的服务器地址(即向服务器发送了一个http请求)，然后在浏览器端创建一个处理数据的函数，在服务端通过 iframe 与浏览器的长连接定时输出数据给客户端，iframe 页面接收到此数据就会将其解析成代码并传给父页面从而实现即时通讯目的；</p> <ul><li>优点：对比轮询做了优化，有较好的时效性；</li> <li>缺点：兼容性与用户体验不好。服务器维护一个长连接会增加开销。一些浏览器的的地址栏图标会一直转菊花。</li></ul> <p><u>Server-sent Events(SSE)</u>：与长轮询机制类似，区别是每个连接不只发送一个消息；客户端发送一个请求，服务端保持这个连接直到有新消息发送回客户端，仍然保持着连接，如此连接就可以实现消息的再次发送，由服务器单向发送给客户端；</p> <ul><li>优点：HTML5 标准；实现较为简单；一个连接可以发送多个数据；</li> <li>缺点：兼容性不好(IE，Edge不支持)；服务器只能单向推送数据到客户端；</li></ul> <p><u>WebSocket</u>：HTML5 WebSocket 规范定义了一种 API，使 Web 页面能够使用 WebSocket 协议与远程主机进行双向通信；其属于应用层协议；基于 TCP 传输协议，并复用 HTTP 握手通道；但并非基于 HTTP 协议，其只是在建立连接前须借助 HTTP(在首次握手时升级协议为 ws 或 wss)；其允许在一条 ws 连接上同时并发多个请求，即在 A 请求发出后 A 响应还未到达，就可继续发出 B 请求；</p> <ul><li>优点：与轮询和长轮询相比，巨大减少了不必要的网络流量和等待时间；开销小，双向通讯，支持二进制传输；</li> <li>缺点：开发成本高，需要额外做重连保活；</li></ul> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200924231830.png" alt="截屏2020-09-24 下午11.18.20" style="zoom:67%;"> <p><u>基于 UDP 的 WebRTC：</u></p> <p><u>MQTT：</u></p> <h2 id="_1-2、解决"><a href="#_1-2、解决" class="header-anchor">#</a> 1-2、解决</h2> <p>引入 Websocket，WebSocket 是一种基于 TCP 的轻量级网络通信协议，是 HTML5 新出的持久化协议(相对于非持久协议 HTTP)，可看作是 HTTP 协议补充，其旨在实现通讯双方长连接(真)，是解决 HTTP 本身无法解决的问题而做出的一个改良设计；</p> <ul><li>注意：与 HTTP/2 一样，均为解决 HTTP 某些方面的缺陷而诞生；但解决方式略不同，HTTP/2 针对  <u>队头阻塞</u>，WebSocket 针对 <u>请求-应答</u> 的通信模式；</li> <li>注意：HTTP 请求应答模式，即半双工的通信模式，不具备服务器推送能力；故限制了 HTTP 在实时通信领域的发展；</li> <li>HTTP的生命周期通过 Request 来界定，即 One Request One Response；
<ul><li>HTTP1.0 中，完成上述 One 即结束；</li> <li>HTTP1.1中，进行改进：Keep-alive，使得一次 HTTP 连接中，可发送多个Request，接收多个 Response；但终究还是 Request = Response——One Request One Response；且此 response 也是被动，不能主动发起；WebSocket 由此应运而生；</li> <li>WebSocket 是一个全双工通信协议，具备服务端主动推送的能力；本质上是对 TCP 做的一层包装，让它可运行在浏览器环境中；</li> <li>Websocket 基于 HTTP 协议，但更准确地说是借用 HTTP 协议来完成一部分握手；</li></ul></li></ul> <p>Websocket 通过首个 HTTP Request 建立 TCP 连接后(通讯双方须进行协议升级-后文提到)，后续进行数据交换时便不用再发 HTTP header、双方可同时收发信息(双通道)，由被动发送变为主动发送，减轻了服务端的负担，且拥有 multiplexing 功能(不用 URI 复用同一 Websocket 连接)、且能维持连接状态(通讯双方能发送 Ping/Pong Frame 监控中间节点的异常情况的发生)；</p> <h1 id="二、优劣"><a href="#二、优劣" class="header-anchor">#</a> 二、优劣</h1> <h2 id="_2-1、优点"><a href="#_2-1、优点" class="header-anchor">#</a> 2-1、优点</h2> <p>可概括为与 HTTP 区别：</p> <ul><li>支持双向通信，双方均可主动发送，同时收发，实时性更强；</li> <li>可发送文本(HTTP1)，也可发送二进制文件(HTTP2)；</li> <li>协议标识符是 ws，加密后是 wss ；支持扩展；ws 协议定义了扩展，用户可扩展协议，或实现自定义的子协议(比如支持自定义压缩算法等)；</li> <li>较少的控制开销；连接创建后，ws客户端、服务端进行数据交换时，协议控制的数据包头部较小；提高信息交换效率、减轻服务端负担；
<ul><li>不包含头部情况下，服务端到用户包头只有 2~10 字节，相反则需要加上额外 4字节掩码；而 HTTP 每次通信都需携带完整头部；</li></ul></li> <li>无跨域问题；实现简单，服务端库如 <code>socket.io</code>、<code>ws</code> ，而客户端也只需要参照 api 实现即可；</li> <li>Websocket 只需一次HTTP握手，整个通讯过程是建立在一次连接/状态中，避免了HTTP的非状态性；</li></ul> <p>那么websocket的缺点也很明显，它对开发者要求高了许多。对前端开发者，往往要具备数据驱动使用javascript的能力，且需要维持住ws连接（否则消息无法推送）；对后端开发者而言，难度增大了很多，一是长连接需要后端处理业务的代码更稳定（不要随便把进程和框架都crash掉），二是推送消息相对复杂一些，三是成熟的http生态下有大量的组件可以复用，websocket则太新了一点。</p> <h2 id="_2-2、缺点"><a href="#_2-2、缺点" class="header-anchor">#</a> 2-2、缺点</h2> <p>兼容问题(对旧式等不支持 websocket 的浏览器须作系列兼容处理)、宽带与耗电问题(ping/pong机制-已有相应优化)、可伸缩性较差、操作复杂：</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001127.png" align="" style="zoom:33%;"> <p>​	如上图所示：普通连接实现较websocket简单，websocket则较复杂，上述图中的消息分发系统可能是 Kafaka、Redis、RMQ；</p> <h1 id="三、协议格式"><a href="#三、协议格式" class="header-anchor">#</a> 三、协议格式</h1> <p>http 基于流，websocket 基于帧，其中帧格式如下图1所示、其中红色部分2字节8位内容一定存在，但后面内容并非一定存在、其中RSV(1/2/3)为保留位、opcode 用于定义帧类型如图2所示：</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001128.png" style="zoom:50%;"> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001129.png" style="zoom:40%;"> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001130.png" style="zoom:40%;"> <h2 id="_3-1、传递消息时的编码格式"><a href="#_3-1、传递消息时的编码格式" class="header-anchor">#</a> 3-1、传递消息时的编码格式</h2> <p>3-1-1、消息与帧的区别：</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001131.png" align="" style="zoom:50%;"> <p>​	消息由一或多个数据帧组成时的字段区别：</p> <ul><li>示例1：一个消息由一或多个数据帧组成；
<ul><li>op为1或2，非持续帧，FIN为0，未结束；</li> <li>op为0，持续帧(持续帧类型取决于前一个帧类型)，FIN为0，未结束；</li> <li>op为A，控制帧，FIN=1，可插入，标志不能再插入其他数据帧；</li> <li>op为0，非控制帧，FIN=1，已结束，程序此后会将上述3个拼装为同1消息；</li></ul></li> <li>示例2：一个消息由一个数据帧组成；
<ul><li>op大于0，FIN=1；</li></ul></li></ul> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001132.png" align="" style="zoom:50%;"> <p>3-1-3、消息内容长度-Payload len</p> <p>​	消息内容长度，描述应用消息和扩展数据的总长度，因历史原因，不得大于127字节，且会根据消息内容长度的不同采用不同的格式，若小于125字节，则只使用 payloadLen，其他情况则相应处理，如下图所示：</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001133.png" align="" style="zoom:50%;"> <h2 id="_3-2、abnf-描述的帧格式"><a href="#_3-2、abnf-描述的帧格式" class="header-anchor">#</a> 3-2、ABNF 描述的帧格式</h2> <p>​	较上面一种更为完整和标准：</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001134.png" align="" style="zoom:50%;"> <h1 id="四、实现"><a href="#四、实现" class="header-anchor">#</a> 四、实现</h1> <h2 id="_4-1、新建连接"><a href="#_4-1、新建连接" class="header-anchor">#</a> 4-1、新建连接</h2> <h3 id="_4-1-1、完成握手"><a href="#_4-1-1、完成握手" class="header-anchor">#</a> 4-1-1、完成握手</h3> <p>会话建立第一步：完成 websocket 握手，<strong><u>而握手本质是由借由 HTTP1.1 实现(传送含有特定字段的报文请求升级)</u></strong>，握手 URI 格式如下图所示：</p> <ul><li>注意：除子协议、扩展协议、CORS跨域三字段外均为必选项：</li></ul> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001135.png" align="" style="zoom:40%;"> <h3 id="_4-1-2、建立连接"><a href="#_4-1-2、建立连接" class="header-anchor">#</a> 4-1-2、建立连接</h3> <p>建立 websocket 连接时候所需消息有如下内容 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism" target="_blank" rel="noopener noreferrer">upgrade_mechanism 规范<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：</p> <ul><li><p>首先，客户端利用 HTTP 发送报文，报文含构建 websocket 连接客户所需告知服务端的消息</p> <ul><li><div class="language-http extra-class"><pre class="language-http"><code><span class="token header-name keyword">Upgrade:</span> websocket
<span class="token header-name keyword">Connection:</span> Upgrade
<span class="token header-name keyword">Sec-WebSocket-Key:</span> x3JJHMbDL1EzLkh9GBhXDw==
<span class="token header-name keyword">Sec-WebSocket-Protocol:</span> chat, superchat
<span class="token header-name keyword">Sec-WebSocket-Version:</span> 13
// ...
</code></pre></div></li> <li><p><u>Connection 设置 Upgrade，告知服务端，该 request 类型需要进行升级为 websocket；</u></p></li> <li><p>Sec-WebSocket-Key：通过规范中定义算法计算得出，用以验证对方 websocket 服务真伪(不安全，但可阻止websocket 请求误操作)；</p></li> <li><p>Sec-WebSocket-Protocol：指定有限使用的 Websocket协议，可以是一个协议列表(list)；服务端在 response 中返回列表中支持的第一个值；</p></li> <li><p>Sec-WebSocket-Version：指定通信时使用的Websocket协议版本。最新版本:13，<a href="https://www.iana.org/assignments/websocket/websocket.xml#version-number" target="_blank" rel="noopener noreferrer">历史版本<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p>Sec-WebSocket-Extensions 客户端向服务端发起请求扩展列表(list)，供服务端选择并在响应中返回；</p></li></ul></li> <li><p>然后，服务端响应，消息响应完成后，即可认为 websocket 建立成功；</p> <ul><li><div class="language-http extra-class"><pre class="language-http"><code><span class="token header-name keyword">Upgrade:</span> websocket
<span class="token header-name keyword">Connection:</span> Upgrade
<span class="token header-name keyword">Sec-WebSocket-Accept:</span> HSmrc0sMlYUkAGmm5OPpG2HaGWk=
<span class="token header-name keyword">Sec-WebSocket-Protocol:</span> chat
// ...
</code></pre></div></li> <li><p>Sec-WebSocket-Accept：经过服务器确认，并且加密过后的 Sec-WebSocket-Key，用以证明服务器自身身份；</p></li></ul></li> <li><p>其中：按等级分如下，一类红色信息；二类绿色信息；三类蓝色信息；四类黑色信息；</p> <ul><li>红色：须基于HTTP/1.1、须为GET方法、须为Host头部、须为版本13、Connection 须传 Upgrade 表示升级、须传 Upgrade 字段且值为 websocket（HTTP/1.1）</li> <li>绿色：须传随机数，而服务端须根据此随机数按照一定规则(见下文)生成新的Base64 随机数</li> <li>蓝色：跨域信息(非必须)</li> <li>黑色：扩展信息(非必须)</li></ul></li> <li><p>其中：服务端根据客户端所给随机数生成新随机数规则 (客户端以返回值判断握手是否为服务端所接受)：</p> <ul><li>首先，客户端 SWK 与 GUID(标准文档，值固定) 拼接；</li> <li>然后，SHA1加密；</li> <li>最后，进行 Base64混淆；</li></ul></li></ul> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001136.png" align="" style="zoom:50%;"> <h3 id="_4-1-3、示例"><a href="#_4-1-3、示例" class="header-anchor">#</a> 4-1-3、示例</h3> <p>使用 HTTP 建立 websocket 握手示例：</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001137.png" align="" style="zoom:50%;"> <h3 id="_4-1-x、实现"><a href="#_4-1-x、实现" class="header-anchor">#</a> 4-1-X、实现</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 客户端</span>
<span class="token keyword">const</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://localhost:8080&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;onmessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;onerror&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;onclose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 客户端心跳检测</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>heartTimer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatLoss <span class="token operator">&lt;</span> <span class="token constant">MAXLOSSTIMES</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    events<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;network&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sendHeart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatLoss <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>phoneLoss <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    events<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;network&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;offline&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>phoneLoss <span class="token operator">&gt;</span> <span class="token constant">MAXLOSSTIMES</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>PhoneLive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    events<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;network&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;phoneDisconnect&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 服务端</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Server <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;ws&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> wsServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span> port<span class="token operator">:</span> <span class="token number">8080</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
wsServer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;connection&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ws</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;234&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;onmessage&quot;</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  ws<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;onerror&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  ws<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;onclose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;监听OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;监听失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 自定义通讯协议</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Socket<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span> 
<span class="token keyword">const</span> tcp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 保持底层 tcp 链接不断，长连接</span>
tcp<span class="token punctuation">.</span><span class="token function">setKeepAlive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
tcp<span class="token punctuation">.</span><span class="token function">setNoDelay</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 指定对应域名端口号链接</span>
tcp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">166.166</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">)</span>

<span class="token comment">// 建立连接后根据后端传送的数据类型 使用对应不同的解析</span>
<span class="token comment">// readUInt8 readUInt16LE readUInt32LE readIntLE 等处理后得到 myBuf </span>
<span class="token comment">// 从对应的指针开始的位置截取 buffer</span>
<span class="token keyword">const</span> myBuf <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 截取对应的头部 buffer</span>
<span class="token keyword">const</span> header <span class="token operator">=</span> myBuf<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>headstart<span class="token punctuation">,</span>headend<span class="token punctuation">)</span>
<span class="token comment">// 精确截取数据体的 buffer, 并且转化成 js 对象</span>
<span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>myBuf<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>headend<span class="token operator">-</span>headstart<span class="token punctuation">,</span>bodylength<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tostring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// https://segmentfault.com/a/1190000019891825</span>
</code></pre></div><h2 id="_4-2、保持心跳"><a href="#_4-2、保持心跳" class="header-anchor">#</a> 4-2、保持心跳</h2> <p>心跳帧间隔**<u>可通过应用端 websocket 库的 heartbeat 设置</u>**，但除非涉及业务一般不做处理(监听、劫持)，心跳帧含有服务健康检查的功能，心跳帧可双向进行；</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001138.png" align="" style="zoom:50%;"> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001139.png" align="" style="zoom:50%;"> <h2 id="_4-3、关闭连接"><a href="#_4-3、关闭连接" class="header-anchor">#</a> 4-3、关闭连接</h2> <p>websocket 为双向传输协议，关闭时需双向关闭，且因其承载在 TCP 协议之上，故需在 TCP 关闭前，先关闭 websocket 会话，可基于关闭帧关闭(也是双向的)，关闭会话的方式有2种：</p> <ul><li>控制帧中的关闭帧，在 TCP 连接之上的双向关闭；
<ul><li>发送关闭帧后，不能再发送任何数据；</li> <li>接收到关闭帧后，不再接收任何到达的数据；</li></ul></li> <li>TCP 连接意外中断；</li></ul> <p>关闭帧格式与错误码及示例</p> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001140.png" align="" style="zoom:80%;"> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001141.png" align="" style="zoom:80%;"> <img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001142.png" align="" style="zoom:50%;"> <h1 id="五、安全"><a href="#五、安全" class="header-anchor">#</a> 五、安全</h1> <h2 id="_5-1、代理污染攻击与掩码防御"><a href="#_5-1、代理污染攻击与掩码防御" class="header-anchor">#</a> 5-1、代理污染攻击与掩码防御</h2> <p>问题：</p> <ul><li>首先，存在实现不当的代理服务器 (无法识别 websocket 协议)</li> <li>然后，黑客构建恶意服务器与恶意页面，并试图建立与上述服务器的 websocket 连接</li> <li>然后，恶意页面与恶意服务器建立 websocket 连接(实际通过 http1.1长连接实现)，此时恶意页面伪造 GET 请求，此请求改变 host 为被攻击的服务器，恶意服务器伪造被攻击服务器的响应，期间代理服务器缓存了虚假的结果；</li> <li>最后，当正常用户访问被攻击服务器时，则实际返回的是缓存中的内容；</li> <li><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001143.png" align="" style="zoom:50%;"></li></ul> <p>本质：代理服务器问题(无法识别 websocket 协议会将握手请求识别为 HTTP1.1请求，并将当前连接识别为 HTTP1.1长连接)、浏览器问题；</p> <p>解决：浏览器须对客户端发送内容均做掩码 (frame-masking-key) 处理，使其无法伪造，强制合法；以减少针对代理服务器的缓存处理攻击风险；</p> <ul><li><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001144.png" align="" style="zoom:70%;"></li> <li><img src="https://leibnize-picbed.oss-cn-shenzhen.aliyuncs.com/img/20200908001145.png" align="" style="zoom:70%;"></li></ul> <p>总结：虽代理无法识别 websocket 而会建立长连接，但目的是建立长连接后伪造 HTTP GET 请求，伪造请求后恶意服务器伪造响应，迷惑代理服务器并使其缓存结果，从而让用户无法访问正确服务器；</p> <p>补充：</p> <ul><li>虽可模仿浏览器绕开浏览器自动强制生成掩码这一安全机制实施攻击，但模仿成本高(还需大范围铺开供用户使用)，故攻击成本高，情况罕见；</li> <li>代理缓存污染攻击成本低(只需铺开恶意页面即可)，而之所以加掩码即可防御，是因为 JS 无法获取掩码内容，确保了唯一性；</li> <li>浏览器强制执行加密、自动生成掩码是 websocket 特性；</li></ul> <h1 id="六、使用"><a href="#六、使用" class="header-anchor">#</a> 六、使用</h1> <h2 id="_6-1、基本封装"><a href="#_6-1、基本封装" class="header-anchor">#</a> 6-1、基本封装</h2> <p>涉及基础搭建、消息收发(ID控制执行回调)；</p> <p>涉及鉴权机制(须自实现—比如通过验证 token)：</p> <ul><li>socket 连接建立时，检查连接的 HTTP 请求头信息(比如cookies中关于用户的身份信息、登录信息(加密))；</li> <li>socket 建立连接后，客户端必须携带授权内容，如此服务端在接收到消息时，检查连接是否已授权过，及授权是否过期；</li> <li>以上两点，只要答案为否，则服务端主动关闭 socket 连接</li></ul> <p>涉及房间分配：主要通过 Node 服务端存储和管理房间，用户进退房间时，服务端鉴权后，根据返回房间信息(ID)，向房间内所有成员进行 broadcast：</p> <p><a href="https://stackoverflow.com/questions/4445883/node-websocket-server-possible-to-have-multiple-separate-broadcasts-for-a-si" target="_blank" rel="noopener noreferrer">详看文章1<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://github.com/gw19/join-and-chat-in-multiple-rooms-with-socket-io/blob/master/server/server.js" target="_blank" rel="noopener noreferrer">详看文章2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> io <span class="token keyword">from</span> <span class="token string">'socket.io-client'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> EventEmitter <span class="token keyword">from</span> <span class="token string">'EventEmitter'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Ws</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">init</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> socket  <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>link <span class="token operator">=</span> <span class="token function">io</span><span class="token punctuation">(</span><span class="token string">'wss://x.x.x.x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onConnect</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'disconnect'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onDisconnect<span class="token punctuation">.</span>bind<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'someEvent'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onSomeEvent</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token parameter">packet</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseData</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
  	<span class="token comment">// 发送消息</span>
  	<span class="token comment">// 需要使用唯一标识来处理消息回调</span>
  	seq <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    cmdTasksMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token function">sendCmd</span><span class="token punctuation">(</span><span class="token parameter">cmd<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>cmdTasksMap<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>seq<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                resolve<span class="token punctuation">,</span>
                reject
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">genPacket</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>seq<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>link<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		<span class="token comment">// 接收消息</span>
    <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token parameter">packet</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">parsePacket</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>seq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> cmdTask <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cmdTasksMap<span class="token punctuation">[</span>data<span class="token punctuation">.</span>seq<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cmdTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>body<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    cmdTask<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    cmdTask<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cmdTasksMap<span class="token punctuation">[</span>data<span class="token punctuation">.</span>seq<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_6-2、实际优化"><a href="#_6-2、实际优化" class="header-anchor">#</a> 6-2、实际优化</h2> <ul><li>连接保持：超时处理、心跳包(检查长链接存活的关键)、重连退避机制；
<ul><li>心跳包：在客户端和服务器间定时通知对方自身状态的自定义的命令字端，按一定时间间隔发送，类似于心跳；</li> <li>应用中加入心跳检测可检测是否正常可响应，TCP KeepAlive 只是连接保活，无法完全确保无异常(服务器死锁仍可收到)</li> <li>通常使用空内容的心跳包，并设定合适发送频率与超时时间来作为连接保持的判断；</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 超时处理</span>
<span class="token keyword">class</span> <span class="token class-name">Ws</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token function">sendCmd</span><span class="token punctuation">(</span><span class="token parameter">cmd<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>cmdTasksMap<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>seq<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                resolve<span class="token punctuation">,</span>
                reject
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment">// 加个定时器</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>timeMap<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>seq<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">newTimeoutError</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>err <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">CMDTIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">genPacket</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>seq<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>link<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token parameter">packet</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">parsePacket</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>seq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> cmdTask <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cmdTasksMap<span class="token punctuation">[</span>data<span class="token punctuation">.</span>seq<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cmdTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeMap<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>seq<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>timeMap<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>seq<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>body<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    cmdTask<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    cmdTask<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cmdTasksMap<span class="token punctuation">[</span>data<span class="token punctuation">.</span>seq<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 心跳重连</span>
<span class="token comment">// 若服务端只认心跳包作为连接存在判断，那就在连接建立后定时发心跳就行</span>
<span class="token comment">// 若以收到包为判断存活，那就在每次收到消息重置并起个定时器发送心跳包</span>
<span class="token keyword">class</span> <span class="token class-name">Ws</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
     <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token parameter">packet</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">parsePacket</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>seq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> cmdTask <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cmdTasksMap<span class="token punctuation">[</span>data<span class="token punctuation">.</span>seq<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cmdTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeMap<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>seq<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>body<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    cmdTask<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    cmdTask<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cmdTasksMap<span class="token punctuation">[</span>data<span class="token punctuation">.</span>seq<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startHeartBeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">startHeartBeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>heartBeatTimer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>heartBeatTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>heartBeatTimer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>heartBeatTimer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 在 sendCmd 中指定 heartbeat 类型 seq 为 0，让业务包连续编号</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendCmd</span><span class="token punctuation">(</span><span class="token string">'heartbeat'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 发送成功了就不管</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">heartBeatError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">HEARTBEATINTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>流量优化：持久化存储；
<ul><li>使用 H5 的大容量存储方案：indexedDB，配合使用成熟的  <a href="https://link.zhihu.com/?target=https%3A//github.com/dfahlander/Dexie.js" target="_blank" rel="noopener noreferrer">Dexie.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，<a href="https://link.zhihu.com/?target=https%3A//github.com/aaronpowell/db.js" target="_blank" rel="noopener noreferrer">db.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 二次封装库；</li> <li>并用时间戳进行增量同步，优先从存储获取；</li> <li>消息的通知则通过缓存队列维护保证入库时序(顺序)；</li></ul></li> <li>流量优化：减少连接数；
<ul><li>WebWorker 线程可执行任务而不干扰用户界面；且可将消息发送到创建它 JS 代码, 通过将消息发布到该代码指定的事件处理程序(反之亦然)；</li> <li>WebWorker 能够使用：WebSocket、XHR，等通讯 API，能操作本地存储；</li> <li>遂可通过 SharedWorker API 创建一个执行指定脚本来共享 web worker 来实现多个 tab 间的通讯复用，来达到减少连接数目的；</li></ul></li></ul> <h2 id="_6-3、一般示例"><a href="#_6-3、一般示例" class="header-anchor">#</a> 6-3、一般示例</h2> <h3 id="_6-3-1、心跳检测重连"><a href="#_6-3-1、心跳检测重连" class="header-anchor">#</a> 6-3-1、心跳检测重连</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> ws<span class="token punctuation">,</span> tt<span class="token punctuation">;</span>
<span class="token comment">// 避免重复连接</span>
<span class="token keyword">let</span> lockReconnect <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> wsUrl <span class="token operator">=</span> <span class="token string">&quot;wss://echo.websocket.org&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">createWebSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>wsUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log('失败重连');</span>
    <span class="token function">reconnect</span><span class="token punctuation">(</span>wsUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 事件初始化</span>
<span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ws<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log('连接关闭');</span>
    <span class="token function">reconnect</span><span class="token punctuation">(</span>wsUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  ws<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log('发生异常了');</span>
    <span class="token function">reconnect</span><span class="token punctuation">(</span>wsUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 心跳检测重置</span>
    heartCheck<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log('接收到消息');</span>
    heartCheck<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>lockReconnect<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token comment">// 避免瞬时多次触发重连</span>
  lockReconnect <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// 没连接上会一直重连，设置延迟避免请求过多</span>
  tt <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>tt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  tt <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">createWebSocket</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    lockReconnect <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 间隔 4s 尝试重连</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 心跳检测 - 实现1</span>
<span class="token keyword">var</span> heartCheck <span class="token operator">=</span> <span class="token punctuation">{</span>
  timeout<span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
  timeoutObj<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  serverTimeoutObj<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token function-variable function">start</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// console.log('start');</span>
    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timeoutObj <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeoutObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>serverTimeoutObj <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverTimeoutObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timeoutObj <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 发送心跳，后端收到后，返回一个心跳消息，</span>
      ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;123456789&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      self<span class="token punctuation">.</span>serverTimeoutObj <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// console.log(ws);</span>
        ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// createWebSocket();</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">createWebSocket</span><span class="token punctuation">(</span>wsUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 详看:</span>
<span class="token comment">// https://blog.csdn.net/Toleranty/article/details/80911093</span>


<span class="token comment">// 心跳检测 - 实现2</span>
<span class="token keyword">var</span> heartCheck <span class="token operator">=</span> <span class="token punctuation">{</span>
    timeout<span class="token operator">:</span> <span class="token number">60000</span><span class="token punctuation">,</span><span class="token comment">//60ms</span>
    timeoutObj<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    serverTimeoutObj<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token function-variable function">reset</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeoutObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverTimeoutObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
　　　　 <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">start</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>timeoutObj <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;HeartBeat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            self<span class="token punctuation">.</span>serverTimeoutObj <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              	<span class="token comment">// 若直接执行 reconnect 会触发 onclose 导致重连2次</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   heartCheck<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    heartCheck<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
ws<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 详看: </span>
<span class="token comment">// https://www.cnblogs.com/rsapaper/p/12585070.html</span>
</code></pre></div><h1 id="x、其他"><a href="#x、其他" class="header-anchor">#</a> X、其他</h1> <h2 id="x-1、ngsocketio"><a href="#x-1、ngsocketio" class="header-anchor">#</a> X-1、ngSocketIo</h2> <p><a href="https://github.com/bougarfaoui/ng-socket-io" target="_blank" rel="noopener noreferrer">ng-socket-io<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>  是 socket.io-client 的 angular 版本，其内部只是对 socket.io-client 的 <a href="https://github.com/bougarfaoui/ng-socket-io/blob/master/socket-io.service.ts" target="_blank" rel="noopener noreferrer">angular 化<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 封装(并利用 Observable 封装了一个 socket.on 事件—更友好地使用 angular 化的 socket)；关键：<code>this.ioSocket = io(url, options);</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> EventEmitter<span class="token punctuation">,</span> Inject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/Observable'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'rxjs/add/operator/share'</span><span class="token punctuation">;</span> 

<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> io <span class="token keyword">from</span> <span class="token string">'socket.io-client'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> SocketIoConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./socketIoConfig'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">SOCKET_CONFIG_TOKEN</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./socket-io.module'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">WrappedSocket</span> <span class="token punctuation">{</span>
    subscribersCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    ioSocket<span class="token operator">:</span> any<span class="token punctuation">;</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Inject</span><span class="token punctuation">(</span><span class="token constant">SOCKET_CONFIG_TOKEN</span><span class="token punctuation">)</span> config<span class="token operator">:</span> SocketIoConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> url<span class="token operator">:</span> string <span class="token operator">=</span> config<span class="token punctuation">.</span>url <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> options<span class="token operator">:</span> any <span class="token operator">=</span> config<span class="token punctuation">.</span>options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      	<span class="token comment">// 关键对象</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ioSocket <span class="token operator">=</span> <span class="token function">io</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token operator">:</span> string<span class="token punctuation">,</span> callback<span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ioSocket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">once</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token operator">:</span> string<span class="token punctuation">,</span> callback<span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ioSocket<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ioSocket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token parameter">close<span class="token operator">?</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ioSocket<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ioSocket<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token operator">:</span> string<span class="token punctuation">,</span> data<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">,</span> callback<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ioSocket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ioSocket<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token operator">:</span> string<span class="token punctuation">,</span> callback<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ioSocket<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ioSocket<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">removeAllListeners</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token operator">?</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ioSocket<span class="token punctuation">.</span><span class="token function">removeAllListeners</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ioSocket<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** create an Observable from an event */</span>
    fromEvent<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>eventName<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subscribersCounter<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Observable<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token parameter">observer<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span>ioSocket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token operator">:</span> <span class="token constant">T</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                 observer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subscribersCounter <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>ioSocket<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">share</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   
    <span class="token comment">/* Creates a Promise for a one-time event */</span>
    fromEventOnce<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>eventName<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="x-2、socket-io-client"><a href="#x-2、socket-io-client" class="header-anchor">#</a> X-2、socket.io-client</h2> <p><a href="https://socket.io/docs/client-api/" target="_blank" rel="noopener noreferrer">socketClient 文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://github.com/socketio/socket.io-client" target="_blank" rel="noopener noreferrer">socketClientGithub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>socket 核心对象 io 由 Manager 类负责创建；</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// https://github.com/socketio/socket.io-client/blob/master/lib/index.js</span>
<span class="token keyword">var</span> parsed <span class="token operator">=</span> <span class="token function">url</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> source <span class="token operator">=</span> parsed<span class="token punctuation">.</span>source<span class="token punctuation">;</span>
  <span class="token keyword">var</span> id <span class="token operator">=</span> parsed<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
  <span class="token keyword">var</span> path <span class="token operator">=</span> parsed<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
  <span class="token keyword">var</span> sameNamespace <span class="token operator">=</span> cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> path <span class="token keyword">in</span> cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>nsps<span class="token punctuation">;</span>
  <span class="token keyword">var</span> newConnection <span class="token operator">=</span> opts<span class="token punctuation">.</span>forceNew <span class="token operator">||</span> opts<span class="token punctuation">[</span><span class="token string">'force new connection'</span><span class="token punctuation">]</span> <span class="token operator">||</span>
                      <span class="token boolean">false</span> <span class="token operator">===</span> opts<span class="token punctuation">.</span>multiplex <span class="token operator">||</span> sameNamespace<span class="token punctuation">;</span>

  <span class="token keyword">var</span> io<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>newConnection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'ignoring socket cache for %s'</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    io <span class="token operator">=</span> <span class="token function">Manager</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'new io instance for %s'</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
      cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Manager</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    io <span class="token operator">=</span> cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed<span class="token punctuation">.</span>query <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>opts<span class="token punctuation">.</span>query<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    opts<span class="token punctuation">.</span>query <span class="token operator">=</span> parsed<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> io<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span>parsed<span class="token punctuation">.</span>path<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Manager 类负责连接的核心操作通过 <a href="https://github.com/socketio/engine.io-client" target="_blank" rel="noopener noreferrer">engine.io-client<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 实现，而事件发布特性则由 Emitter = require('component-emitter'); 实现</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// https://github.com/socketio/socket.io-client/blob/master/lib/manager.js</span>
<span class="token keyword">var</span> eio <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'engine.io-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> Socket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./socket'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> Emitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'component-emitter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Manager<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Manager</span> <span class="token punctuation">(</span><span class="token parameter">uri<span class="token punctuation">,</span> opts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 单例</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Manager</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Manager</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>uri <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token string">'object'</span> <span class="token operator">===</span> <span class="token keyword">typeof</span> uri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    opts <span class="token operator">=</span> uri<span class="token punctuation">;</span>
    uri <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  opts <span class="token operator">=</span> opts <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  opts<span class="token punctuation">.</span>path <span class="token operator">=</span> opts<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">'/socket.io'</span><span class="token punctuation">;</span>
	<span class="token comment">// 一些初始化配置</span>
<span class="token punctuation">}</span>

<span class="token comment">// ... </span>

<span class="token class-name">Manager</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>open <span class="token operator">=</span> <span class="token class-name">Manager</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">connect</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> opts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 单例</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">~</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// 核心</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>engine <span class="token operator">=</span> <span class="token function">eio</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>uri<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> socket <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>engine<span class="token punctuation">;</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">=</span> <span class="token string">'opening'</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>skipReconnect <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">// emit `open`</span>
  <span class="token keyword">var</span> openSub <span class="token operator">=</span> <span class="token function">on</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span><span class="token function">onopen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fn <span class="token operator">&amp;&amp;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// emit `connect_error`</span>
  <span class="token keyword">var</span> errorSub <span class="token operator">=</span> <span class="token function">on</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    self<span class="token punctuation">.</span>readyState <span class="token operator">=</span> <span class="token string">'closed'</span><span class="token punctuation">;</span>
    self<span class="token punctuation">.</span><span class="token function">emitAll</span><span class="token punctuation">(</span><span class="token string">'connect_error'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Connection error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      err<span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Only do this if there is no fn to handle the error</span>
      self<span class="token punctuation">.</span><span class="token function">maybeReconnectOnOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// emit `connect_timeout`</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> timeout <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_timeout<span class="token punctuation">;</span>

    <span class="token comment">// set timer</span>
    <span class="token keyword">var</span> timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      openSub<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token string">'timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      self<span class="token punctuation">.</span><span class="token function">emitAll</span><span class="token punctuation">(</span><span class="token string">'connect_timeout'</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function-variable function">destroy</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>openSub<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>errorSub<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="x-3、engine-io"><a href="#x-3、engine-io" class="header-anchor">#</a> X-3、engine.io</h2> <p>先不说它基本内容，先从这个库的示例文件出发，观察知：</p> <ul><li>通过 const io = require('engine.io').attach(server); 构建 socket 服务端并开始监听；</li> <li>通过 const socket = new eio.Socket(); 建立客户端并开始监听；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1、engine.io 示例工程 socket Server</span>
<span class="token comment">// 通过 const io = require('engine.io').attach(server); 构建服务器</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> enchilada <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'enchilada'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> io <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'engine.io'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">enchilada</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  src<span class="token operator">:</span> __dirname <span class="token operator">+</span> <span class="token string">'/public'</span><span class="token punctuation">,</span>
  debug<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 静态服务路由</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/index.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/engine.io.min.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'engine.io-client/dist/engine.io.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

io<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'pong'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">;</span>

<span class="token comment">// 监听</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\x1B[96mlistening on localhost:'</span> <span class="token operator">+</span> port <span class="token operator">+</span> <span class="token string">' \x1B[39m'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 2、engine.io 示例工程 socket Client</span>
<span class="token comment">// 切换路由，获取 engine.io-client/dist/engine.io.min.js 并建立客户端: const socket = new eio.Socket(); 开始监听</span>
<span class="token keyword">function</span> <span class="token function">$</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">let</span> smoothie<span class="token punctuation">;</span>
<span class="token keyword">let</span> time<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">render</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// socket</span>
<span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">eio<span class="token punctuation">.</span>Socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> last<span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">send</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  last <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ping'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'transport'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> socket<span class="token punctuation">.</span>transport<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'chart'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>onresize <span class="token operator">=</span> render<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>smoothie<span class="token punctuation">)</span> smoothie<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'transport'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'(disconnected)'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> latency <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> last<span class="token punctuation">;</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'latency'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> latency <span class="token operator">+</span> <span class="token string">'ms'</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>time<span class="token punctuation">)</span> time<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span>send<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>通过 const io = require('engine.io').attach(server); 构建 socket 服务端并开始监听；</li> <li>通过 const socket = new eio.Socket(); 建立客户端并开始监听；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 观察 socket Server 构建</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> io <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'engine.io'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// ...</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">// engine.io.js</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
<span class="token keyword">function</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">port<span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;function&quot;</span> <span class="token operator">===</span> <span class="token keyword">typeof</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fn <span class="token operator">=</span> options<span class="token punctuation">;</span>
    options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">501</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;Not Implemented&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// create engine server</span>
  <span class="token keyword">const</span> engine <span class="token operator">=</span> exports<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  engine<span class="token punctuation">.</span>httpServer <span class="token operator">=</span> server<span class="token punctuation">;</span>
  server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> engine<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token parameter">server<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> engine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  engine<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> engine<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
<span class="token comment">// 发现知调用了 Server 实例的 attach 方法, 若有传入 httpServer 则利用，否则通过 listen 调用时自构造 httpServer</span>



<span class="token comment">// server.js</span>
<span class="token comment">// ...</span>
  <span class="token function">attach</span><span class="token punctuation">(</span><span class="token parameter">server<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">&quot;/engine.io&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\/$/</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> destroyUpgradeTimeout <span class="token operator">=</span> options<span class="token punctuation">.</span>destroyUpgradeTimeout <span class="token operator">||</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token comment">// normalize path</span>
    path <span class="token operator">+=</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> path <span class="token operator">===</span> req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// cache and clean up listeners</span>
    <span class="token keyword">const</span> listeners <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">listeners</span><span class="token punctuation">(</span><span class="token string">&quot;request&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span><span class="token function">removeAllListeners</span><span class="token punctuation">(</span><span class="token string">&quot;request&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;listening&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// add request handler</span>
    <span class="token comment">// 注意到若没有后续的 if 与普通的 httpServer 无太大区别，监听 request，然后通知</span>
    server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;request&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">check</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'intercepting request for path &quot;%s&quot;'</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> l <span class="token operator">=</span> listeners<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 若模式是 websocket </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">~</span>self<span class="token punctuation">.</span>opts<span class="token punctuation">.</span>transports<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;websocket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 监听 upgrade 事件,并通过 handleUpgrade 进行 socket 协议升级</span>
      server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;upgrade&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> head</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">check</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          self<span class="token punctuation">.</span><span class="token function">handleUpgrade</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">!==</span> options<span class="token punctuation">.</span>destroyUpgrade<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// default node behavior is to disconnect when no handlers</span>
          <span class="token comment">// but by adding a handler, we prevent that</span>
          <span class="token comment">// and if no eio thing handles the upgrade</span>
          <span class="token comment">// then the socket needs to die!</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>socket<span class="token punctuation">.</span>writable <span class="token operator">&amp;&amp;</span> socket<span class="token punctuation">.</span>bytesWritten <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> socket<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> destroyUpgradeTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 先是进行某些认证，然后 Buffer 处理协议升级所需请求头，最后通过 self.ws.handleUpgrade(req, socket, head, function(conn) 升级</span>
<span class="token function">handleUpgrade</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> upgradeHead</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> success</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">abortConnection</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> head <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>upgradeHead<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line node/no-deprecated-api</span>
    upgradeHead <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// delegate to ws</span>
    self<span class="token punctuation">.</span>ws<span class="token punctuation">.</span><span class="token function">handleUpgrade</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> head<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">conn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span><span class="token function">onWebSocket</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// self.ws.handleUpgrade 即 this.ws.handleUpgrade, 而 this.ws 由 this.ws = new wsModule.Server({ 创建</span>
<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">~</span><span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>transports<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;websocket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ws<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// add explicit require for bundlers like webpack</span>
  <span class="token keyword">const</span> wsModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>wsEngine <span class="token operator">===</span> <span class="token string">&quot;ws&quot;</span> <span class="token operator">?</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;ws&quot;</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>wsEngine<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">wsModule<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    noServer<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    clientTracking<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    perMessageDeflate<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>perMessageDeflate<span class="token punctuation">,</span>
    maxPayload<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>maxHttpBufferSize
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 溯源成功，由 ws 库实现…</span>
<span class="token comment">// 溯源成功，由 ws 库实现…</span>
<span class="token comment">// 溯源成功，由 ws 库实现…</span>
</code></pre></div><p>观察服务端 socket 生成可知，engine.io 本质还是由 ws 库实现(即其为 websocket 的又一层封装)，但做了向下兼容处理，如果环境不支持则使用 Polling 方式替代(XHR、JSONP)；(长轮询：客户端发送一次 request，当服务端有消息推送时会 push 一条 response 给客户端；客户端收到 response 后，会再次发送 request，重复上述过程，直到其中一端主动断开连接为止)</p> <p>Socket.io 基于 engine.io 这个库，engine.io 使用  Websocket 和 XHR 方式封装了一套 socket 协议； 为其提供跨浏览器/跨设备的双向通信功能；而因低版本浏览器不支持 Websocket，则会使用长轮询(polling)替代兼容；<a href="https://github.com/socketio/engine.io/tree/master/lib" target="_blank" rel="noopener noreferrer">目录结构<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、https://blog.csdn.net/u013243347/article/details/86661778、中文乱码问题—maybe 字节流截断：https://cnodejs.org/topic/55fcd7ed152fdd025f0f4eb7</p> <ul><li>transports file</li> <li>engine.io.js</li> <li>server.js</li> <li>socket.js</li> <li>transports.js</li></ul> <p>engine.io 原理、其他即时方案补充、科普文、长连接实现原理、Node Socket实现(自定义)、Chrome实现、Socket与WebSocket、大文件传输、优缺点及使用；</p></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">9/29/2020, 4:19:55 PM</span></div></footer> <!----> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.f95d0077.js" defer></script><script src="/assets/js/3.49babee5.js" defer></script><script src="/assets/js/1.269e4bda.js" defer></script><script src="/assets/js/163.00e98ea9.js" defer></script>
  </body>
</html>
