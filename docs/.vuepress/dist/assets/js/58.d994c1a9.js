(window.webpackJsonp=window.webpackJsonp||[]).push([[58],{383:function(t,s,a){"use strict";a.r(s);var n=a(42),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h3",{attrs:{id:"一、基本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、基本"}},[t._v("#")]),t._v(" 一、基本")]),t._v(" "),a("h3",{attrs:{id:"二、浏览器缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、浏览器缓存"}},[t._v("#")]),t._v(" 二、浏览器缓存")]),t._v(" "),a("p",[t._v("浏览器中的缓存作用分为 2 种情况，一种是需要发送 HTTP 请求(强缓)，另一种则不用(协缓)；首次缓存、非首次缓存、用户行为与缓存如下：")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/711.png",align:"left"}}),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/712.png",align:"left"}}),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/713.png",align:"left"}}),t._v(" "),a("h4",{attrs:{id:"_2-1、强缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1、强缓存"}},[t._v("#")]),t._v(" 2-1、强缓存")]),t._v(" "),a("p",[t._v("首先检查强缓存，通过检查字段来实现；但注意 HTTP/1.0 和 HTTP/1.1 所检查的字段不一样：")]),t._v(" "),a("h5",{attrs:{id:"_2-1-1、expires-http-1-0时期"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-1、expires-http-1-0时期"}},[t._v("#")]),t._v(" 2-1-1、Expires—HTTP/1.0时期")]),t._v(" "),a("p",[t._v("Expires 即过期时间，告知浏览器在此日期前可直接从缓存中获取数据，而无需再次请求；")]),t._v(" "),a("p",[a("strong",[a("u",[t._v("缺点")])]),t._v("："),a("strong",[t._v("服务器时间与浏览器本地时间可能不一致(修改时间会使缓存失效)")]),t._v("，即时间计算基准不同就会有问题 (已在 HTTP/1.1版本抛弃)")]),t._v(" "),a("div",{staticClass:"language-http extra-class"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[t._v("// 位于服务端返回的响应头\n// 表示资源在 2020 年 07 月 21 号 8 点 41 分过期，若过期就得向服务端请求重新获取资源\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Expires:")]),t._v(" Tue, 21 July 2020 08:41:00 GMT\n")])])]),a("h5",{attrs:{id:"_2-1-2、cache-control-http-1-1时期"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-2、cache-control-http-1-1时期"}},[t._v("#")]),t._v(" 2-1-2、Cache-Control—HTTP/1.1时期")]),t._v(" "),a("p",[t._v("采用字段 Cache-Control 控制缓存，并用属性 "),a("strong",[t._v("max-age")]),t._v(" 表示缓存过期时间(与 Expires 不同，采用时间段而非具体时间点)；")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("// 位于服务端返回的响应头\n// 表示从收到此响应开始计算，往后的 3600 秒内，均可直接使用缓存\nCache-Control:max-age=3600\n")])])]),a("p",[t._v("Cache-Control 还有诸多属性值来对缓存作更细粒度的操作：")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("public")]),t._v("：客户端、中间代理服务器均允许缓存资源；")]),t._v(" "),a("li",[a("strong",[t._v("private")]),t._v("：只有客户端能缓存，中间代理服务器不能缓存；")]),t._v(" "),a("li",[a("strong",[t._v("no-cache")]),t._v("：跳过当前强缓存检查阶段，直接发送 HTTP 请求，即直接进入协商缓存阶段；")]),t._v(" "),a("li",[a("strong",[t._v("no-store")]),t._v("：不进行任何形式的缓存；")]),t._v(" "),a("li",[a("strong",[t._v("s-max-age")]),t._v("：作用同 max-age，但针对对象是代理服务器；")]),t._v(" "),a("li",[t._v("注意：若 "),a("strong",[t._v("Expires")]),t._v(" 和 "),a("strong",[t._v("Cache-Control")]),t._v(" 同时存在，则优先考虑 "),a("strong",[t._v("Cache-Control")]),t._v("；")])]),t._v(" "),a("h4",{attrs:{id:"_2-2、协商缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2、协商缓存"}},[t._v("#")]),t._v(" 2-2、协商缓存")]),t._v(" "),a("p",[t._v("即若强缓存失效，即资源缓存超时，浏览器在请求头中携带相应的 "),a("u",[t._v("缓存tag")]),t._v(" 来向服务器发请求，服务器根据此 tag，来告知浏览器是否继续使用缓存；缓存 Tag 有两种，无分优劣， "),a("strong",[t._v("Last-Modified")]),t._v("、 "),a("strong",[t._v("ETag")])]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/22.png",align:"left"}}),t._v(" "),a("h5",{attrs:{id:"_2-2-1、last-modified"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1、last-modified"}},[t._v("#")]),t._v(" 2-2-1、Last-Modified")]),t._v(" "),a("p",[t._v("响应报文字段，表示资源最后修改时间；使用机制如下：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("首先，当浏览器首次向服务器发送请求后，服务器会在响应头中加上此字段；")])]),t._v(" "),a("li",[a("p",[t._v("然后，而浏览器接收到后，若再次请求，则会在请求头中携带  "),a("strong",[t._v("If-Modified-Since")]),t._v(" 字段，此字段值即服务器传来的最后修改时间；")])]),t._v(" "),a("li",[a("p",[t._v("然后，服务器拿到  请求头中的 "),a("strong",[t._v("If-Modified-Since")]),t._v(" 字段，"),a("u",[t._v("随即与服务器中该资源的最后修改时间作对比")]),t._v(":")]),t._v(" "),a("ul",[a("li",[t._v("若请求头中的值 < 服务器上的最后修改时间，即说明资源已更新，服务端返回新资源，与常规 HTTP 请求响应流程一致；")]),t._v(" "),a("li",[t._v("否则返回 304 状态码，告诉浏览器直接用缓存；")])])])]),t._v(" "),a("h5",{attrs:{id:"_2-2-2、etag"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2、etag"}},[t._v("#")]),t._v(" 2-2-2、ETag")]),t._v(" "),a("p",[t._v("响应报文字段，此字段是服务器基于当前文件内容，给文件生成的唯一标识，即值会随内容更新而改变；使用机制如下：")]),t._v(" "),a("ul",[a("li",[t._v("首先，浏览器接收到 "),a("strong",[t._v("ETag")]),t._v(" 值，若再次请求，则会在请求头中携带 "),a("strong",[t._v("If-None-Match")]),t._v("  字段，此字段值即 "),a("strong",[t._v("ETag")]),t._v(" 值；")]),t._v(" "),a("li",[t._v("然后，服务器接收到 **If-None-Match **后，"),a("u",[t._v("随即与服务器中该资源的 ETag 作对比")]),t._v(":\n"),a("ul",[a("li",[t._v("若两者不相同，即说明资源已更新，服务端返回新资源，与常规 HTTP 请求响应流程一致；")]),t._v(" "),a("li",[t._v("否则返回 304 状态码，告诉浏览器直接用缓存；")])])])]),t._v(" "),a("h5",{attrs:{id:"_2-2-3、两者对比"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-3、两者对比"}},[t._v("#")]),t._v(" 2-2-3、两者对比")]),t._v(" "),a("ul",[a("li",[t._v("精度上，"),a("u",[a("strong",[t._v("ETag")]),t._v(" 优于 "),a("strong",[t._v("Last-Modified")])]),t._v("：原因是前者按照内容给资源上标识，能准确感知资源变化，而后者在某些特殊情况下无法准确感知资源变化：\n"),a("ul",[a("li",[t._v("**"),a("u",[t._v("不该重新请求时，重新请求：")]),t._v("**编辑文件，但实际上文件内容并无变更，服务端并不清楚文件是否真正改变，仍通过最后编辑时间进行判断，此时资源再次被请求时，会被当做新资源处理，缓存作用失效；")]),t._v(" "),a("li",[t._v("**"),a("u",[t._v("该重新请求时，无重新请求：")]),t._v("**Last-Modified 能感知的最小单位时间是秒，若文件在 1 秒内发生多次改变则无法表现出修改，具有局限性；")])])]),t._v(" "),a("li",[t._v("性能上，"),a("u",[a("strong",[t._v("Last-Modified")]),t._v(" 优于 "),a("strong",[t._v("ETag")])]),t._v("：前者仅记录时间点，而后者需要服务器根据文件具体内容生成唯一哈希值；")]),t._v(" "),a("li",[t._v("优先上，若两种方式均支持，服务器会"),a("u",[t._v("优先考虑 "),a("strong",[t._v("ETag 机制 (客户端接收角度为 ETag 优先，服务端接收角度为 If-None-Match 优先)")]),t._v("；")])])]),t._v(" "),a("h4",{attrs:{id:"_2-3、缓存存放位置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3、缓存存放位置"}},[t._v("#")]),t._v(" 2-3、缓存存放位置")]),t._v(" "),a("p",[t._v("浏览器中的缓存位置一共有四种，按优先级从高到低排列分别是：")]),t._v(" "),a("ul",[a("li",[t._v("Service Worker")]),t._v(" "),a("li",[t._v("Memory Cache")]),t._v(" "),a("li",[t._v("Disk Cache")]),t._v(" "),a("li",[t._v("Push Cache")]),t._v(" "),a("li",[t._v("网络请求")])]),t._v(" "),a("h5",{attrs:{id:"_2-3-1、service-worker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-1、service-worker"}},[t._v("#")]),t._v(" 2-3-1、Service Worker")]),t._v(" "),a("p",[a("strong",[t._v("Service Worker")]),t._v("：与 Web Worker类似，是独立的线程(无法直接访问 DOM，无法干扰页面性能)，可帮助实现："),a("u",[t._v("离线缓存")]),t._v("、"),a("u",[t._v("消息推送")]),t._v("、"),a("u",[t._v("网络代理")]),t._v(" 等功能；借助 Service worker 实现的离线缓存即称 "),a("u",[t._v("Service Worker Cache")]),t._v("：可自由选择缓存哪些文件，以及文件的匹配与读取规则，且缓存是持续性的；SW 特点如下:")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("借鉴 "),a("code",[t._v("Web Worker")]),t._v(" 思路，且是 "),a("code",[t._v("PWA")]),t._v(" 重要实现机制；")])]),t._v(" "),a("li",[a("p",[t._v("使用 "),a("code",[t._v("Service Worker")]),t._v(" 会涉及到请求拦截，所以需要用 HTTPS 协议来保证安全，即传输协议必须是 "),a("code",[t._v("HTTPS")]),t._v("；")])]),t._v(" "),a("li",[a("p",[t._v("生命周期包括： install、active、working 三个阶段；一旦 Service Worker 被 install，就将始终存在，只会在 active 与 working 间切换，除非主动终止；这是它可用来实现 "),a("u",[t._v("离线存储")]),t._v(" 的重要先决条件；")])])]),t._v(" "),a("h5",{attrs:{id:"_2-3-2、memory-cache"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-2、memory-cache"}},[t._v("#")]),t._v(" 2-3-2、Memory Cache")]),t._v(" "),a("p",[a("strong",[t._v("Memory Cache")]),t._v("：即内存缓存，"),a("u",[t._v("存取效率最高、但存活时间最短")]),t._v("，非持续性，随进程释放而释放；")]),t._v(" "),a("p",[t._v("主要存储当前页面已抓取到的资源, 比如已下载的样式、脚本、图片；特点如下：")]),t._v(" "),a("ul",[a("li",[t._v("存取效率快，但缓存持续时间短，会随着进程释放而释放(一旦关闭 Tab 页即被释放，未关闭但, 排在前排缓存失效)；")]),t._v(" "),a("li",[t._v("从其中读取缓存时，浏览器会忽视 "),a("code",[t._v("Cache-Control")]),t._v("中的一些 "),a("code",[t._v("max-age、no-cache")]),t._v(" 等头部配置, 除非设置  "),a("code",[t._v("no-store")]),t._v(" 头部配置；")]),t._v(" "),a("li",[t._v("几乎所有的请求资源都能进入 "),a("u",[t._v("Memory Cache")]),t._v("，主要分为 "),a("u",[t._v("preloader")]),t._v(" 、"),a("u",[t._v("preload")]),t._v(" ：\n"),a("ul",[a("li",[t._v("preloader：用于 "),a("u",[t._v("当浏览器打开网页时，能边解析执行 js/css，边请求下一资源")]),t._v("，被请求的资源会被放入 "),a("code",[t._v("Memory Cache")]),t._v(" 中，供后续解析执行操作使用；")]),t._v(" "),a("li",[t._v("preload：用于显式指定预加载的资源，比如： "),a("code",[t._v('<link rel="preload">')])])])])]),t._v(" "),a("h5",{attrs:{id:"_2-3-3、disk-cache-http-cache"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-3、disk-cache-http-cache"}},[t._v("#")]),t._v(" 2-3-3、Disk Cache / HTTP Cache")]),t._v(" "),a("p",[a("strong",[t._v("Disk Cache")]),t._v("：即存储在磁盘中的缓存，"),a("u",[t._v("存取效率较低，但存储容量大和存储持续时间长")]),t._v("；")]),t._v(" "),a("p",[t._v("会根据 HTTP header 中的缓存字段来判断哪些资源需要缓存、哪些不需要请求而直接使用、哪些已过期需要重新获取，而若是命中缓存，浏览器会从硬盘中直接读取资源，虽无从内存中读取的快，但却比网络缓存快；")]),t._v(" "),a("ul",[a("li",[t._v("注意：强缓存、协商缓存也是属于 "),a("code",[t._v("Disk Cache")]),t._v("，它们最终都存储在硬盘里；")]),t._v(" "),a("li",[t._v("区别：Memory Cache 与 Disk Cache 存储位置选择的策略如下：\n"),a("ul",[a("li",[t._v("较大的 JS、CSS 文件会直接存入磁盘，反之内存；")]),t._v(" "),a("li",[t._v("当系统内存使用率比较高时，文件优先放入磁盘；")])])])]),t._v(" "),a("h5",{attrs:{id:"_2-3-4、push-cache"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-4、push-cache"}},[t._v("#")]),t._v(" 2-3-4、Push Cache")]),t._v(" "),a("p",[t._v("Push Cache 是指 HTTP2 在 server push 阶段存在的缓存，是浏览器缓存最后一道防线(国内尚未普及)，("),a("a",{attrs:{href:"https://jakearchibald.com/2017/h2-push-tougher-than-i-thought/",target:"_blank",rel:"noopener noreferrer"}},[t._v("资料1"),a("OutboundLink")],1),t._v("、"),a("a",{attrs:{href:"https://www.jianshu.com/p/54cc04190252",target:"_blank",rel:"noopener noreferrer"}},[t._v("资料2"),a("OutboundLink")],1),t._v(")：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("Push Cache 是缓存的最后一道防线；浏览器只有在 Memory Cache、HTTP Cache 和 Service Worker Cache 均未命中的情况下才会去询问 Push Cache；")])]),t._v(" "),a("li",[a("p",[t._v("Push Cache 是一种存在于会话—Session 阶段的缓存，当 session 终止时(关闭连接、关闭 Tab)，缓存也随之释放，且缓存时间短暂(Chrome 中只有5分钟)；")])]),t._v(" "),a("li",[a("p",[t._v("不同的页面只要共享同一个 HTTP2 连接，则就可共享同一个 Push Cache；")]),t._v(" "),a("ul",[a("li",[t._v("注意：视浏览器实现而定，某些浏览器出于对性能考虑，会对相同域名但不同 Tab 标签使用同一 HTTP 连接；")])])]),t._v(" "),a("li",[a("p",[t._v("所有资源都能被推送，且能够被缓存，但 Edge 和 Safari 支持相对较差")])]),t._v(" "),a("li",[a("p",[t._v("可推送 no-cache 和 no-store 资源；")])]),t._v(" "),a("li",[a("p",[t._v("Push Cache 中的缓存只能被使用一次；")])]),t._v(" "),a("li",[a("p",[t._v("浏览器可以拒绝接收已存在的资源推送；")])]),t._v(" "),a("li",[a("p",[t._v("可以给其他域名推送资源；")])])]),t._v(" "),a("h4",{attrs:{id:"_2-4、实际应用与场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4、实际应用与场景"}},[t._v("#")]),t._v(" 2-4、实际应用与场景")]),t._v(" "),a("h5",{attrs:{id:"_2-4-1、实际应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-1、实际应用"}},[t._v("#")]),t._v(" 2-4-1、实际应用")]),t._v(" "),a("ul",[a("li",[t._v("频繁变动的资源使用："),a("code",[t._v("Cache-Control: no-cache")]),t._v("；\n"),a("ul",[a("li",[t._v("注意：使得浏览器每次都请求服务器，然后配合 "),a("code",[t._v("ETag")]),t._v(" 或 "),a("code",[t._v("Last-Modified")]),t._v(" 来验证资源是否有效；虽不能节省请求数量，但能显著减少响应数据大小；")])])]),t._v(" "),a("li",[t._v("不频繁变动的资源使用："),a("code",[t._v("Cache-Control: max-age=31536000")]),t._v("，一年的总秒数…\n"),a("ul",[a("li",[t._v("注意：为解决更新问题，可在文件名添加 "),a("code",[t._v("hash")]),t._v("、版本号等动态字段，以实现更改 "),a("u",[t._v("引用URL")]),t._v(" 目的(实现更新内容-重新请求资源)；")])])])]),t._v(" "),a("h5",{attrs:{id:"_2-4-2、用户场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-2、用户场景"}},[t._v("#")]),t._v(" 2-4-2、用户场景")]),t._v(" "),a("ul",[a("li",[t._v("地址输入栏：先查找 Disk Cache 是否有匹配，否则发送请求；")]),t._v(" "),a("li",[t._v("普通 F5 刷新：优先使用 Memory Cache，其次是 Disk Cache；")]),t._v(" "),a("li",[t._v("强制 CtrlF5 刷新：浏览器不使用缓存")])]),t._v(" "),a("h4",{attrs:{id:"_2-5、缓存过程总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-5、缓存过程总结"}},[t._v("#")]),t._v(" 2-5、缓存过程总结")]),t._v(" "),a("p",[t._v("首次，浏览器发起 HTTP 请求到获得请求结果，可分为以下几个过程：")]),t._v(" "),a("ul",[a("li",[t._v("首先，浏览器首次发起 HTTP 请求，在浏览器缓存中没有发现请求的缓存结果和缓存标识；")]),t._v(" "),a("li",[t._v("然后，浏览器向服务器发起 HTTP 请求，获得该请求响应与缓存规则(即 "),a("code",[t._v("Last-Modified")]),t._v(" 或 "),a("code",[t._v("ETag")]),t._v(")；")]),t._v(" "),a("li",[t._v("然后，浏览器将响应内容存入 "),a("code",[t._v("Disk Cache")]),t._v("，将响应内容的引用，存入 "),a("code",[t._v("Memory Cache")]),t._v("；")]),t._v(" "),a("li",[t._v("最后，将响应内容存入 "),a("code",[t._v("Service Worker")]),t._v(" 的 "),a("code",[t._v("Cache Storage")]),t._v("  (若 "),a("code",[t._v("Service Worker")]),t._v(" 的脚本调用了 "),a("code",[t._v("cache.put()")]),t._v(")")])]),t._v(" "),a("p",[t._v("然后，在下一次请求相同资源时:")]),t._v(" "),a("ul",[a("li",[t._v("调用 "),a("code",[t._v("Service Worker")]),t._v(" 的 "),a("code",[t._v("fetch")]),t._v("  事件响应；")]),t._v(" "),a("li",[t._v("查看 "),a("code",[t._v("Memory Cache")])]),t._v(" "),a("li",[t._v("查看 "),a("code",[t._v("Disk Cache")]),t._v("，并通过 "),a("strong",[t._v("Cache-Control")]),t._v(" 验证 "),a("u",[t._v("强缓存")]),t._v(" 是否可用\n"),a("ul",[a("li",[t._v("若可用，直接使用，返回 200 状态码")]),t._v(" "),a("li",[t._v("否则进入 "),a("u",[t._v("协商缓存")]),t._v("，即发送 HTTP 请求，服务器通过请求头中的 "),a("strong",[t._v("If-Modified-Since")]),t._v(" 或 "),a("strong",[t._v("If-None-Match")]),t._v(" 字段检查资源是否更新\n"),a("ul",[a("li",[t._v("若资源更新，返回资源和  200 状态码；")]),t._v(" "),a("li",[t._v("否则，返回 304 状态码，告诉浏览器直接从缓存获取资源；")])])])])])]),t._v(" "),a("img",{staticStyle:{zoom:"40%"},attrs:{src:"/Image/Chromium/16.png",align:"left"}}),t._v(" "),a("h3",{attrs:{id:"三、浏览器存储"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、浏览器存储"}},[t._v("#")]),t._v(" 三、浏览器存储")]),t._v(" "),a("p",[t._v("浏览器的本地存储主要分为： "),a("strong",[t._v("Cookie")]),t._v("、"),a("strong",[t._v("WebStorage(可再分为 localStorage 和 sessionStorage)")]),t._v("、"),a("strong",[t._v("IndexedDB")]),t._v("；")]),t._v(" "),a("h4",{attrs:{id:"_3-1、cookie"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1、cookie"}},[t._v("#")]),t._v(" 3-1、Cookie")]),t._v(" "),a("p",[t._v("Cookie 设计之处并非用于本地存储，而是为了弥补 HTTP 在状态管理上的不足(无状态协议，服务端无法辨别每次请求的客户端的具体情况)；")]),t._v(" "),a("p",[t._v("Cookie 本质是浏览器中存储的一个很小的、内容以键值对形式存储的文本文件，每次向同一域名发送请求，均会自动携带相同 Cookie，服务器拿到 Cookie 后进行解析，即可获取客户端状态；即 Cookie 用于 "),a("u",[t._v("状态存储")]),t._v("，但缺点有如下：")]),t._v(" "),a("ul",[a("li",[t._v("容量缺陷：体积上限只有"),a("code",[t._v("4KB")]),t._v("，只能存储少量信息；")]),t._v(" "),a("li",[t._v("性能缺陷：Cookie 紧跟域名发送而不管是否真正需要，随着请求数增多性能浪费越严重——请求携带不必要数据；")]),t._v(" "),a("li",[t._v("安全缺陷：Cookie 纯文本形式，在飞行途中很容易被非法用户截获篡改，在有效期内发送给服务器更是危险操作；\n"),a("ul",[a("li",[t._v("此外，若 "),a("strong",[t._v("HttpOnly")]),t._v(" 字段为 false，Cookie 信息还可直接通过 JS 脚本来读取；")])])])]),t._v(" "),a("h4",{attrs:{id:"_3-2、localstorage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2、localstorage"}},[t._v("#")]),t._v(" 3-2、localStorage")]),t._v(" "),a("h5",{attrs:{id:"_3-2-1、与-cookie-的异同"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1、与-cookie-的异同"}},[t._v("#")]),t._v(" 3-2-1、与 Cookie 的异同")]),t._v(" "),a("p",[t._v("同一个域名下，会存储相同一段 "),a("strong",[t._v("localStorage / Cookie")]),t._v("，而不同在：")]),t._v(" "),a("ul",[a("li",[t._v("容量：针对每个域名，均有上限为 5M 的存储容量；")]),t._v(" "),a("li",[t._v("安全：只存在客户端，默认不参与与服务端通信；")]),t._v(" "),a("li",[t._v("接口：接口友好，通过 "),a("code",[t._v("localStorage")]),t._v(" 全局暴露，拥有诸多方法可供操作(Cookie 只能自定义)；")])]),t._v(" "),a("h5",{attrs:{id:"_3-2-2、操作方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-2、操作方式"}},[t._v("#")]),t._v(" 3-2-2、操作方式")]),t._v(" "),a("p",[a("strong",[t._v("localStorage")]),t._v("  存储的都是字符串，若是存储对象需要调用 "),a("code",[t._v("JSON.stringify")]),t._v("方法，并且用 "),a("code",[t._v("JSON.parse")]),t._v("来解析成对象；")]),t._v(" "),a("h5",{attrs:{id:"_3-2-3、应用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-3、应用场景"}},[t._v("#")]),t._v(" 3-2-3、应用场景")]),t._v(" "),a("p",[t._v("适合存储一些内容稳定的资源，比如官网的"),a("code",[t._v("logo")]),t._v("，存储"),a("code",[t._v("Base64")]),t._v("格式的图片资源，因此利用"),a("code",[t._v("localStorage")]),t._v("；")]),t._v(" "),a("h4",{attrs:{id:"_3-3、sessionstorage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3、sessionstorage"}},[t._v("#")]),t._v(" 3-3、sessionStorage")]),t._v(" "),a("h5",{attrs:{id:"_3-3-1、与-sessionstorage-的异同"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-1、与-sessionstorage-的异同"}},[t._v("#")]),t._v(" 3-3-1、与 sessionStorage 的异同")]),t._v(" "),a("p",[t._v("最大区别在："),a("strong",[t._v("sessionStorage")]),t._v(" 只是会话级别的存储，并非持久化存储，一旦会话结束(当前 tab 页面关闭)就消失；")]),t._v(" "),a("ul",[a("li",[t._v("容量：容量上限也为 5M；")]),t._v(" "),a("li",[t._v("安全：只存在客户端，默认不参与与服务端的通信；")]),t._v(" "),a("li",[t._v("接口：接口友好，类似 "),a("strong",[t._v("localStorage")]),t._v("；")])]),t._v(" "),a("h5",{attrs:{id:"_3-3-2、应用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-2、应用场景"}},[t._v("#")]),t._v(" 3-3-2、应用场景")]),t._v(" "),a("ul",[a("li",[t._v("表单信息进行维护：将表单信息存储在里面，可保证页面即使刷新也不会让先前表单信息丢失；")]),t._v(" "),a("li",[t._v("存储本次浏览记录：因关闭页面后不需要这些记录；")])]),t._v(" "),a("h4",{attrs:{id:"_3-5、indexeddb"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-5、indexeddb"}},[t._v("#")]),t._v(" 3-5、IndexedDB")]),t._v(" "),a("p",[t._v("其实运行在浏览器中的 "),a("u",[t._v("非关系型数据库")]),t._v("，理论上容量是无上限；"),a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API/Using_IndexedDB",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用文档"),a("OutboundLink")],1),t._v("，其拥有数据库本身的特性，比如：支持事务，存储二进制数据，还有其他特殊特性：")]),t._v(" "),a("ul",[a("li",[t._v("键值对存储：内部采用 "),a("u",[t._v("对象仓库")]),t._v(" 存放数据，在此仓库中数据采用 "),a("u",[t._v("键值对")]),t._v(" 形式存储；")]),t._v(" "),a("li",[t._v("异步操作：数据库的读写属于 I/O 操作，浏览器中对异步 I/O 提供了支持；")]),t._v(" "),a("li",[t._v("受同源策略限制，无法访问跨域的数据库；")])]),t._v(" "),a("h4",{attrs:{id:"_3-6、总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-6、总结"}},[t._v("#")]),t._v(" 3-6、总结")]),t._v(" "),a("ul",[a("li",[t._v("Cookie 并不适合存储，而且存在非常多的缺陷；")]),t._v(" "),a("li",[t._v("Web Storage 包括 localStorage 和 sessionStorage，默认不会参与和服务器的通信；")]),t._v(" "),a("li",[t._v("IndexedDB 为运行在浏览器上的非关系型数据库，为大型数据的存储提供了接口；")])]),t._v(" "),a("h3",{attrs:{id:"四、浏览器跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、浏览器跨域"}},[t._v("#")]),t._v(" 四、浏览器跨域")]),t._v(" "),a("p",[a("strong",[a("u",[a("em",[t._v("浏览器遵循同源政策")])])]),t._v("，即(scheme(协议)、host(主机)、port(端口)三种均同)，而非同源站点有如下限制:")]),t._v(" "),a("ul",[a("li",[t._v("不能读取和修改对方的 DOM；")]),t._v(" "),a("li",[t._v("不读访问对方的 Cookie、IndexDB 和 LocalStorage；")]),t._v(" "),a("li",[t._v("限制 XMLHttpRequest 请求；")])]),t._v(" "),a("p",[t._v("而当浏览器发起某次 Ajax 请求("),a("u",[t._v("跨域请求")]),t._v(")时，只要当前 URL 和目标 URL 不同源，就会产生 "),a("strong",[a("u",[a("em",[t._v("跨域")])])]),t._v("；"),a("strong",[a("u",[a("em",[t._v("表现为")])])]),t._v("：请求发出，服务器也成功响应，但前端就是拿不到响应；实际上，跨域请求的响应已到达客户端，只是被浏览器所拦截；即**"),a("u",[a("em",[t._v("跨域是由于浏览器的同源策略引起的")])]),t._v("**；")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("// 同源\nhttp://www.example.com:8080/index.html\nhttp://www.example.com:8080/home.html\n// 跨域\nhttp://www.example.com:8080/index.html\nhttp://www3.example.com:8080/index.html\n// 跨域：http 默认端口80，https 默认端口443\nhttp://www.example.com:80 === http://www.example.com\nhttps://www.example.com:443 === https://www.example.com\n")])])]),a("p",[a("strong",[a("u",[a("em",[t._v("浏览器禁止跨域原因：")])])])]),t._v(" "),a("p",[t._v("首先，跨域只存在于浏览器端；浏览器为 "),a("code",[t._v("web")]),t._v(" 提供了访问入口，且访问方式很简单(地址栏输入地址或点击某链接即可)，因而须要对此种 "),a("strong",[a("u",[t._v("开放的形态")])]),t._v(" 有所限制；")]),t._v(" "),a("p",[t._v("所以，"),a("u",[t._v("同源策略的产生主要是为了：保证用户信息的安全，防止恶意的网站窃取数据")]),t._v("；可细分为两种：Ajax同源策略、DOM同源策略：")]),t._v(" "),a("ul",[a("li",[t._v("前者限制：不同源页面不能获取 "),a("code",[t._v("cookie")]),t._v("、不同源页面不能发起 "),a("code",[t._v("Ajax")]),t._v(" 请求(可防 CSRF)；")]),t._v(" "),a("li",[t._v("后者限制：不同源页面不能获取 "),a("code",[t._v("DOM")]),t._v(" (可防点击劫持)；")])]),t._v(" "),a("h4",{attrs:{id:"_4-1、跨域拦截机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1、跨域拦截机制"}},[t._v("#")]),t._v(" 4-1、跨域拦截机制")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/5.png",align:"left"}}),t._v(" "),a("ul",[a("li",[t._v("首先，浏览器是多进程的，而 WebKit 渲染引擎 和 V8 引擎 都在渲染进程当中；所以当 "),a("code",[t._v("xhr.send")]),t._v(" 被调用时(即请求准备发送时)，尚在渲染进程的处理；\n"),a("ul",[a("li",[t._v("注意：为防止黑客通过脚本触碰系统资源，浏览器将每一"),a("u",[t._v("渲染进程分配进沙箱")]),t._v("，同时为防止 CPU 芯片一直存在的 "),a("u",[t._v("Spectre")]),t._v(" 和  "),a("u",[t._v("Meltdown")]),t._v(" 漏洞，采取 "),a("u",[t._v("站点隔离")]),t._v("  的手段，给每一"),a("u",[t._v("不同站点(一级域名不同)分配沙箱")]),t._v("，使其互不干扰；"),a("a",{attrs:{href:"https://www.youtube.com/watch?v=dBuykrdhK-A&feature=emb_logo",target:"_blank",rel:"noopener noreferrer"}},[t._v("YouTube上Chromium安全团队的演讲视频"),a("OutboundLink")],1),t._v("；")])])]),t._v(" "),a("li",[t._v("然后，沙箱中的渲染进程无法发送网络请求(只能通过网络进程来发送)，所以就需要 "),a("strong",[a("u",[t._v("进程间通信(IPC，Inter Process Communication)")])]),t._v("， 来将数据传递给浏览器主进程，主进程接收到后，才真正地发出相应网络请求；chromium  中进程间通信的源码调用顺序如下："),a("a",{attrs:{href:"https://chromium.googlesource.com/chromium/src/+/refs/heads/master/ipc/",target:"_blank",rel:"noopener noreferrer"}},[t._v("IPC源码地址"),a("OutboundLink")],1),t._v("、"),a("a",{attrs:{href:"https://blog.csdn.net/Luoshengyang/article/details/47822689",target:"_blank",rel:"noopener noreferrer"}},[t._v("Chromium IPC源码解析文章"),a("OutboundLink")],1),t._v("；\n"),a("ul",[a("li",[a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/6.png",align:"left"}})]),t._v(" "),a("li",[t._v("总结：利用 "),a("code",[t._v("Unix Domain Socket")]),t._v("套接字，配合事件驱动的高性能网络并发库  "),a("code",[t._v("libevent")]),t._v(" 完成进程通信 IPC 过程；")])])]),t._v(" "),a("li",[t._v("最后，服务端处理完并将响应返回，主进程检查到跨域行为，且无配置 CORS 响应头，遂将响应体全部丢弃，而不会发往渲染进程，实现了拦截数据的目的；")])]),t._v(" "),a("h4",{attrs:{id:"_4-2、跨域操作方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2、跨域操作方案"}},[t._v("#")]),t._v(" 4-2、跨域操作方案")]),t._v(" "),a("h5",{attrs:{id:"_4-2-1、cors"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1、cors"}},[t._v("#")]),t._v(" 4-2-1、CORS")]),t._v(" "),a("p",[t._v("CORS—跨域资源共享，是 W3C 标准之一，其允许浏览器向跨源服务器，发出 "),a("code",[t._v("XMLHttpRequest")]),t._v(" 或 "),a("code",[t._v("Fetch")]),t._v(" 请求，且整个 "),a("code",[t._v("CORS")]),t._v(" 通信过程均由浏览器自动完成，无需要用户参与；"),a("strong",[a("u",[t._v("完成 CORS 须要前提")])]),t._v("：浏览器须支持此功能："),a("u",[a("strong",[t._v("非 IE 和 IE10 以上")])]),t._v("、且服务器端也须同意此种跨域请求："),a("u",[a("strong",[t._v("服务器需附加特定的响应头")])]),t._v("；"),a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS#Preflighted_requests",target:"_blank",rel:"noopener noreferrer"}},[t._v("MDN"),a("OutboundLink")],1)]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("Access-Control-Allow-Origin")]),t._v("：表示可允许请求的源；可填具体源名，亦可填 "),a("code",[t._v("*")]),t._v(" 表示允许任意源请求；")]),t._v(" "),a("li",[a("strong",[t._v("Access-Control-Allow-Methods")]),t._v("：表示允许的请求方法列表；")]),t._v(" "),a("li",[a("strong",[t._v("Access-Control-Allow-Headers")]),t._v("：表示允许发送的请求头字段；")]),t._v(" "),a("li",[a("strong",[t._v("Access-Control-Allow-Credentials")]),t._v("：略；")]),t._v(" "),a("li",[a("strong",[t._v("Access-Control-Max-Age")]),t._v("：表示预检请求的有效期，在此期间，不必发出另外一条预检请求；")])]),t._v(" "),a("h5",{attrs:{id:"_4-2-1-1、一般流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-1、一般流程"}},[t._v("#")]),t._v(" 4-2-1-1、一般流程")]),t._v(" "),a("ul",[a("li",[t._v("首先，客户端先根据同源策略，对前端请求 URL 与后台交互地址 API 做匹配：\n"),a("ul",[a("li",[t._v("若同源则直接发送数据请求；")]),t._v(" "),a("li",[t._v("若不同源，则发送跨域请求；")])])]),t._v(" "),a("li",[t._v("然后，服务器收到客户端跨域请求后，根据自身配置返回相应文件头：\n"),a("ul",[a("li",[t._v("若未配置允许跨域，则文件头不包含 "),a("code",[t._v("Access-Control-Allow-origin")]),t._v(" 字段；")]),t._v(" "),a("li",[t._v("若已配置跨域允许，则返回 "),a("code",[t._v("Access-Control-Allow-origin + 相应配置规则中的域名的方式")]),t._v("；")])])]),t._v(" "),a("li",[t._v("最后，浏览器根据与接收到的响应头中的 "),a("code",[t._v("Access-Control-Allow-origin")]),t._v(" 字段匹配：\n"),a("ul",[a("li",[t._v("若无该字段，则说明不允许跨域，抛出错误；")]),t._v(" "),a("li",[t._v("若有该字段，则将 "),a("u",[t._v("字段内容")]),t._v(" 同 "),a("u",[t._v("当前域名")]),t._v(" 做比对，\n"),a("ul",[a("li",[t._v("若同源，则说明可跨域，浏览器接受该响应；")]),t._v(" "),a("li",[t._v("若不同源，则说明该域名不可跨域，浏览器不接受该响应，并抛出错误；")])])])])])]),t._v(" "),a("p",[t._v("注意：浏览器根据跨域请求方法和跨域请求头的特定字段，将跨域请求分为两类，凡满足下面条件的属于 "),a("strong",[a("u",[t._v("简单请求")])]),t._v("，否则为 "),a("strong",[a("u",[t._v("非简单请求")])]),t._v("，前者只是单纯请求，后者则会先使用 "),a("code",[t._v("OPTIONS")]),t._v(" 方法发起一个预检请求到服务器，以获知服务器是否允许该实际请求，避免跨域请求对服务器的用户数据产生未预期的影响；")]),t._v(" "),a("ul",[a("li",[t._v("请求方法为 GET、POST、HEAD 之一；")]),t._v(" "),a("li",[t._v("请求头取值范围："),a("code",[t._v("Accept")]),t._v("、"),a("code",[t._v("Accept-Language")]),t._v("、"),a("code",[t._v("Content-Language")]),t._v("、"),a("code",[t._v("Content-Type")]),t._v("、"),a("code",[t._v("DPR")]),t._v("、"),a("code",[t._v("Downlink")]),t._v("、"),a("code",[t._v("Save-Data")]),t._v("、"),a("code",[t._v("Viewport-Width")]),t._v("、"),a("code",[t._v("Width")]),t._v(" "),a("ul",[a("li",[t._v("注意："),a("code",[t._v("Content-Type")]),t._v(" 仅限3值："),a("code",[t._v("application/x-www-form-urlencoded")]),t._v("、"),a("code",[t._v("multipart/form-data")]),t._v("、"),a("code",[t._v("text/plain")])])])]),t._v(" "),a("li",[t._v("请求中的任意 "),a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequestUpload",target:"_blank",rel:"noopener noreferrer"}},[t._v("XMLHttpRequestUpload"),a("OutboundLink")],1),t._v(" 对象均无注册任何事件监听器；"),a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequestUpload",target:"_blank",rel:"noopener noreferrer"}},[t._v("XMLHttpRequestUpload"),a("OutboundLink")],1),t._v(" 对象可使用 "),a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/upload",target:"_blank",rel:"noopener noreferrer"}},[t._v("XMLHttpRequest.upload"),a("OutboundLink")],1),t._v(" 属性访问；")]),t._v(" "),a("li",[t._v("请求中没有使用 "),a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream",target:"_blank",rel:"noopener noreferrer"}},[t._v("ReadableStream"),a("OutboundLink")],1),t._v(" 对象")])]),t._v(" "),a("h5",{attrs:{id:"_4-2-1-2、简单请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-2、简单请求"}},[t._v("#")]),t._v(" 4-2-1-2、简单请求")]),t._v(" "),a("p",[t._v("在请求发出前，浏览器会自动为请求头中，添加字段 "),a("code",[t._v("Origin")]),t._v("，用以说明请求来源；当服务器拿到请求并回应时，会相应地添加字段 "),a("code",[t._v("Access-Control-Allow-Origin")]),t._v("，并设置字段值(或请求 Origin 值，或别的值)；然后，当浏览器收到时，若发现 "),a("code",[t._v("Origin")]),t._v(" 的值不在此字段范围内时，就会将响应拦截；所以，"),a("strong",[a("u",[t._v("字段 "),a("code",[t._v("Access-Control-Allow-Origin")]),t._v(" 是服务器用来决定浏览器是否拦截此响应的必需字段")])]),t._v("；")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1、./index")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("a href"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/cors"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CORS")]),t._v("跨域"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("a"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1-1、./cors/index")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("script src"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://cdn.bootcss.com/axios/0.19.2/axios.min.js"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("button id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"getName"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("get")]),t._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("button"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  getName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onclick")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 简单请求")]),t._v("\n  axios"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://127.0.0.1:8080/api/corsname"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2、client.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Koa "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fs'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Koa")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("method "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'GET'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFileSync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./index.html'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("method "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'GET'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/cors'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFileSync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./cors/index.html'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'client 8000...'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3、server.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Koa "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Koa")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 关键之处:")]),t._v("\n  ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Access-Control-Allow-Origin"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("header"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("origin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/api/corsname'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Test'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'server 8080...'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("此外，还有其他可选的功能性字段，用以描述若不拦截时，则字段将会发挥各自的作用：")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("Access-Control-Allow-Credentials")]),t._v("：布尔值，表示是否允许发送 Cookie，对于跨域请求，浏览器默认值设为 false，否则需要设置为 true，并需在前端也需设置 "),a("code",[t._v("withCredentials")]),t._v(" 属性:")])]),t._v(" "),a("div",{staticClass:"language-http extra-class"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[t._v("let xhr = new XMLHttpRequest();\nxhr.withCredentials = true;\n")])])]),a("ul",[a("li",[a("strong",[t._v("Access-Control-Expose-Headers")]),t._v("：给 XMLHttpRequest 对象赋能，使此对象不仅可拿到基本的 6 个响应头字段("),a("code",[t._v("Cache-Control")]),t._v("、"),a("code",[t._v("Content-Language")]),t._v("、"),a("code",[t._v("Content-Type")]),t._v("、"),a("code",[t._v("Expires")]),t._v("、"),a("code",[t._v("Last-Modified")]),t._v("、"),a("code",[t._v("Pragma")]),t._v(")，还可拿到此字段声明的 "),a("strong",[t._v("响应头字段")]),t._v("：")])]),t._v(" "),a("div",{staticClass:"language-http extra-class"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[t._v("// 服务端设置响应\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Expose-Headers:")]),t._v(" xxx\n// 前端可通过 `XMLHttpRequest.getResponseHeader('xxx')` 拿到 `xxx` 这个字段的值\n")])])]),a("h5",{attrs:{id:"_4-2-1-3、非简单请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-3、非简单请求"}},[t._v("#")]),t._v(" 4-2-1-3、非简单请求")]),t._v(" "),a("p",[t._v("非简单请求不同于简单请求，前者只是单纯请求，后者则会先使用 "),a("code",[t._v("OPTIONS")]),t._v(" 方法发起一个预检请求到服务器，以获知服务器是否允许该实际请求，避免跨域请求对服务器的用户数据产生未预期的影响；即主要体现在两方面："),a("strong",[a("u",[t._v("预检请求")])]),t._v("、"),a("strong",[a("u",[t._v("响应字段")])]),t._v("，主流程是：")]),t._v(" "),a("ul",[a("li",[t._v("首先，客户端先发送 "),a("u",[a("strong",[t._v("预检请求(而非实际请求)")])]),t._v("，用以告知服务器接下来的 CORS 请求的具体信息(方法、请求头)；\n"),a("ul",[a("li",[t._v("Access-Control-Request-Method：指出 (接下来的)CORS 请求用到哪个 HTTP 方法；")]),t._v(" "),a("li",[t._v("Access-Control-Request-Headers：指出 (接下来的)CORS 请求将要加上什么请求头；")])])])]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 以非简单请求 PUT 方法为例")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" url "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://xxx.com'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" xhr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XMLHttpRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nxhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("open")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'PUT'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nxhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setRequestHeader")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'X-Custom-Header'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'xxx'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nxhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("div",{staticClass:"language-http extra-class"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[t._v("// 预检请求请求头 - 代码执行后浏览器随即自动发送 预检请求\n// 预检请求方法为 OPTIONS\nOPTIONS / HTTP/1.1\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Origin:")]),t._v(" 源地址\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Host:")]),t._v(" xxx.com - 目的地址\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Request-Method:")]),t._v(" PUT - 非简单请求标志之一\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Request-Headers:")]),t._v(" X-Custom-Header - 非简单请求标志之一\n")])])]),a("ul",[a("li",[t._v("然后，服务端接收并返回 "),a("u",[a("strong",[t._v("预检请求的响应")])]),t._v("，客户端检查此响应：\n"),a("ul",[a("li",[t._v("若 CORS 请求不满足预检请求响应头的条件，则触发 "),a("code",[t._v("XMLHttpRequest")]),t._v(" 的 "),a("code",[t._v("onerror")]),t._v("方法，后续真正 CORS 请求不发出；")]),t._v(" "),a("li",[t._v("若 CORS 请求满足，则发出真正 CORS 请求；")])])])]),t._v(" "),a("div",{staticClass:"language-http extra-class"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[t._v("// 预检请求响应头\n"),a("span",{pre:!0,attrs:{class:"token response-status"}},[t._v("HTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v("200 OK")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Allow-Origin:")]),t._v(" *\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Allow-Methods:")]),t._v(" GET, POST, PUT\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Allow-Headers:")]),t._v(" X-Custom-Header\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Allow-Credentials:")]),t._v(" true\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Max-Age:")]),t._v(" 1728000\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Content-Type:")]),t._v(" text/html; charset=utf-8\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Content-Encoding:")]),t._v(" gzip\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Content-Length:")]),t._v(" 0\n")])])]),a("ul",[a("li",[a("p",[t._v("Access-Control-Allow-Credentials：略；")])]),t._v(" "),a("li",[a("p",[t._v("Access-Control-Allow-Methods：表示允许的请求方法列表；")])]),t._v(" "),a("li",[a("p",[t._v("Access-Control-Allow-Headers：表示允许发送的请求头字段；")])]),t._v(" "),a("li",[a("p",[t._v("Access-Control-Max-Age：表示预检请求的有效期，在此期间，不必发出另外一条预检请求；")])]),t._v(" "),a("li",[a("p",[t._v("Access-Control-Allow-Origin：表示可允许请求的源；可填具体源名，亦可填 "),a("code",[t._v("*")]),t._v(" 表示允许任意源请求；")])]),t._v(" "),a("li",[a("p",[t._v("最后，若一切允许，则客户端发送真正的 CORS 跨域请求：流程同简单请求：客户端自动加上 "),a("code",[t._v("Origin")]),t._v(" 字段，服务端返回  "),a("code",[t._v("Access-Control-Allow-Origin")]),t._v("；")])])]),t._v(" "),a("h5",{attrs:{id:"_4-2-1-4、注意事项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-4、注意事项"}},[t._v("#")]),t._v(" 4-2-1-4、注意事项")]),t._v(" "),a("h5",{attrs:{id:"_4-2-1-4-1、减少预检请求次数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-4-1、减少预检请求次数"}},[t._v("#")]),t._v(" 4-2-1-4-1、减少预检请求次数：")]),t._v(" "),a("ul",[a("li",[t._v("尽量发出简单请求；")]),t._v(" "),a("li",[t._v("服务端设置 "),a("code",[t._v("Access-Control-Max-Age")]),t._v(" 字段：在有效时间内浏览器无需再为同一请求发送预检请求；\n"),a("ul",[a("li",[t._v("局限性：只能为同一请求缓存，无法针对整个域或模糊匹配 URL 做缓存；")])])])]),t._v(" "),a("h5",{attrs:{id:"_4-2-1-4-2、携带身份凭证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-4-2、携带身份凭证"}},[t._v("#")]),t._v(" 4-2-1-4-2、携带身份凭证")]),t._v(" "),a("p",[t._v("跨域 "),a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest",target:"_blank",rel:"noopener noreferrer"}},[t._v("XMLHttpRequest"),a("OutboundLink")],1),t._v(" 或 "),a("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API",target:"_blank",rel:"noopener noreferrer"}},[t._v("Fetch"),a("OutboundLink")],1),t._v(" 请求，浏览器默认 **"),a("u",[t._v("不会")]),t._v(" **发送身份凭证信息比如 Cookie，若要坚持发送凭证信息，则需满足 3 个条件：")]),t._v(" "),a("ul",[a("li",[t._v("客户端请求头设置 "),a("code",[t._v("withCredentials")]),t._v(" 为 "),a("code",[t._v("true")]),t._v("；")]),t._v(" "),a("li",[t._v("服务器设置首部字段 "),a("code",[t._v("Access-Control-Allow-Credentials")]),t._v(" 为 "),a("code",[t._v("true")]),t._v("；")]),t._v(" "),a("li",[t._v("服务器的 "),a("code",[t._v("Access-Control-Allow-Origin")]),t._v(" 不能为 "),a("code",[t._v("*")]),t._v("；")])]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1、login")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 关键 1:")]),t._v("\naxios"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("defaults"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("withCredentials "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\naxios"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("defaults"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("baseURL "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://127.0.0.1:8080'")]),t._v("\nlogin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onclick")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\taxios"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("post")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/api/login'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2、server.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Koa "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"koa"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" router "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"koa-router"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" koaBody "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"koa-body"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Koa")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TOKEN")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxxxxxx-yyyyyyy-zzzzzzzz"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 关键 2:")]),t._v("\n  ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Access-Control-Allow-Origin"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("header"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("origin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Access-Control-Request-Method"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"PUT,POST,GET,DELETE,OPTIONS"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Access-Control-Allow-Headers"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Origin, X-Requested-With, Content-Type, Access, cc"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 关键 3: ")]),t._v("\n  ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Access-Control-Allow-Credentials"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 若是登录接口则跳过后面的token验证")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/api/login"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 对所有非登录的请求验证 token")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" cookies "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookies"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"token"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cookies"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cookies "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" cookies "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TOKEN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    code"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("401")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    msg"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"权限错误"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 若不加 multipart：true ctx.request.body 会获取不到值")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("koaBody")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" multipart"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nrouter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/api/corsname"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Test"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nrouter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("post")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/api/login"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookies"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"token"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TOKEN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    expires"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Date")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Date")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    msg"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"成功"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    code"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("router"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("routes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"server 8080..."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h5",{attrs:{id:"_4-2-1-5、补充"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-5、补充"}},[t._v("#")]),t._v(" 4-2-1-5、补充")]),t._v(" "),a("p",[t._v("简单请求：")]),t._v(" "),a("ul",[a("li",[t._v("当发起跨域请求时：\n"),a("ul",[a("li",[a("strong",[a("u",[a("em",[t._v("若是非简单请求")])])]),t._v("，浏览器会帮我们自动触发预检请求，也就是 OPTIONS 请求，用于确认目标资源是否支持跨域；")]),t._v(" "),a("li",[a("strong",[a("u",[a("em",[t._v("如果是简单请求")])])]),t._v("，则不会触发预检，直接发出正常请求；")])])]),t._v(" "),a("li",[t._v("浏览器会根据服务端响应的 header 自动处理剩余的请求，如果响应支持跨域，则继续发出正常请求，若不支持，则在控制台显示错误；")])]),t._v(" "),a("p",[t._v("非简单请求：")]),t._v(" "),a("ul",[a("li",[t._v("1、浏览器先根据同源策略，对前端页面和后台交互地址做匹配，若同源，则直接发送数据请求；若不同源，则发送跨域请求；")]),t._v(" "),a("li",[t._v("2、服务器收到浏览器跨域请求后，根据自身配置返回对应文件头；\n"),a("ul",[a("li",[t._v("若未配置过任何允许跨域，则文件头里不包含 "),a("code",[t._v("Access-Control-Allow-origin")]),t._v(" 字段；")]),t._v(" "),a("li",[t._v("若配置过域名，则返回 "),a("code",[t._v("Access-Control-Allow-origin + 对应配置规则里的域名的方式")]),t._v("；")])])]),t._v(" "),a("li",[t._v("3、浏览器根据接受到的 响应头里的 "),a("code",[t._v("Access-Control-Allow-origin")]),t._v(" 字段做匹配：\n"),a("ul",[a("li",[t._v("若无该字段，说明不允许跨域，从而抛出一个错误；")]),t._v(" "),a("li",[t._v("若有该字段，则对字段内容和当前域名做比对；\n"),a("ul",[a("li",[t._v("若同源，则说明可以跨域，浏览器接受该响应；")]),t._v(" "),a("li",[t._v("若不同源，则说明该域名不可跨域，浏览器不接受该响应，并抛出一个错误；")])])])])])]),t._v(" "),a("p",[t._v("注意：在 "),a("code",[t._v("CORS")]),t._v(" 中有 "),a("code",[t._v("简单请求")]),t._v(" 和 "),a("code",[t._v("非简单请求")]),t._v("，简单请求不会触发 "),a("code",[t._v("CORS")]),t._v(" 预检请求，而非简单请求会。")]),t._v(" "),a("p",[t._v("注意："),a("code",[t._v('"需预检的请求"')]),t._v(" 要求必须首先使用 "),a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/OPTIONS",target:"_blank",rel:"noopener noreferrer"}},[t._v("OPTIONS"),a("OutboundLink")],1),t._v("  方法发起一个预检请求到服务器，以获知服务器是否允许该实际请求；")]),t._v(" "),a("p",[t._v('注意："预检请求“的使用，可避免跨域请求对服务器的用户数据产生未预期的影响；')]),t._v(" "),a("h5",{attrs:{id:"_4-2-2、jsonp"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-2、jsonp"}},[t._v("#")]),t._v(" 4-2-2、JSONP")]),t._v(" "),a("p",[t._v("JSONP 原理：XMLHttpRequest 对象遵循同源政策，但 "),a("code",[t._v("script")]),t._v(" 标签没有跨域限制，可通过 src 填上目标地址发出 GET 请求，实现跨域请求；")]),t._v(" "),a("p",[t._v("JSONP 原理：主要利用 "),a("code",[t._v("script")]),t._v(" 标签的"),a("code",[t._v("src")]),t._v("属性没有跨域的限制，通过指向一个需要访问的地址，由服务端返回一个预先定义好的 "),a("code",[t._v("Javascript")]),t._v(" 函数的调用，并且将服务器数据以该函数参数的形式传递过来，此方法需要前后端配合完成；")]),t._v(" "),a("p",[t._v("最大优势是兼容性好(兼容 IE 低版本)，但缺点也明显：只支持 GET 请求；执行过程如下：")]),t._v(" "),a("ul",[a("li",[t._v("首先，前端定义一个解析函数；比如： "),a("code",[t._v("jsonpCallback = function (res) {}")])]),t._v(" "),a("li",[t._v("然后，通过 "),a("code",[t._v("params")]),t._v("  的形式包装 "),a("code",[t._v("script")]),t._v(" 标签的请求参数，并声明为上述执行函数名；比如："),a("code",[t._v("cb=jsonpCallback")]),t._v("；")]),t._v(" "),a("li",[t._v("然后，后端获取到前端声明的执行函数("),a("code",[t._v("jsonpCallback")]),t._v(")，并以带上参数且调用执行函数的方式传递给前端")]),t._v(" "),a("li",[t._v("最后，前端在 "),a("code",[t._v("script")]),t._v(" 标签请求返回资源时就会去执行 "),a("code",[t._v("jsonpCallback")]),t._v("，并通过回调的方式拿到数据；")])]),t._v(" "),a("p",[a("strong",[a("u",[a("em",[t._v("JSONP 实现1：")])])])]),t._v(" "),a("div",{staticClass:"language-html extra-class"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[t._v("// 1、创建全局函数，等待执行\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v("text/javascript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token script"}},[a("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n    window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("jsonpCallback")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("res")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n// 2、通过下方代码 jsonp 构建的请求脚本，写入 html 后便等待请求内容返回\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("src")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v("http://localhost:8080/api/jsonp?id=1&cb=jsonpCallback"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v("text/javascript"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token script"}}),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n// 3、服务端拿到 URL 参数，处理请求，最后在响应体中写入 jsonpCallback(...)，并将处理后的内容以函数参数形式传入\n// 4、前端拿到后台内容并执行，执行调用全局函数，并将参数传入函数中执行；\n")])])]),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1、前端")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("jsonp")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callbackName "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("generateURL")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" dataStr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" key "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      dataStr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("&")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    dataStr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("callback=")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("callbackName"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("?")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("dataStr"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reject")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 初始化回调函数名称")]),t._v("\n    callbackName "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" callbackName "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" Math"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("random")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("toString"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("replace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("','")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建 script 元素并加入到当前文档中")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" scriptEle "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'script'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    scriptEle"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("src "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("generateURL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("appendChild")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scriptEle"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 绑定到 window 上，为了后面调用")]),t._v("\n    window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("callbackName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// script 执行完了，成为无用元素，需要清除")]),t._v("\n      document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("removeChild")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scriptEle"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3、调用")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("jsonp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  url"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://localhost:3000'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  params"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" \n    a"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    b"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("data")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 拿到数据进行处理")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 数据包")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2、后端")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" express "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'express'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("express")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 注意，返回给 script 标签，浏览器直接把这部分字符串执行")]),t._v("\n  res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("callback"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("('数据包')")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[a("strong",[a("u",[a("em",[t._v("JSONP 实现2：")])])])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1、前端")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSONP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" params "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callbackKey "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cb"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 定义本地的唯一 callbackId，若是没有的话则初始化为 1")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSONP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callbackId "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSONP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callbackId "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" callbackId "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSONP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callbackId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 把要执行的回调加入到 JSON 对象中，避免污染 window")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSONP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callbacks "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSONP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callbacks "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSONP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callbacks"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("callbackId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" callback"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 把这个名称加入到参数中: 'cb=JSONP.callbacks[1]'")]),t._v("\n  params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("callbackKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("JSONP.callbacks[")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("callbackId"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 得到'id=1&cb=JSONP.callbacks[1]'")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" paramString "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("keys")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("encodeURIComponent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"&"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建 script 标签")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" script "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"script"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  script"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setAttribute")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"src"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("?")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("paramString"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("appendChild")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// id 自增，保证唯一")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSONP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callbackId"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSONP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  url"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://localhost:8080/api/jsonps"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  params"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    a"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2&b=3"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    b"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"4"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  callbackKey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cb"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("callback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("res")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSONP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  url"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://localhost:8080/api/jsonp"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  params"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  callbackKey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cb"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("callback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("res")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 注意: encodeURI 和 encodeURIComponent 区别：")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 前者不会对本身属于 URI 的特殊字符进行编码，例如冒号、正斜杠、问号和井字号；")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 后者则会对它发现的任何非标准字符进行编码")]),t._v("\n")])])]),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2、后端")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Koa "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Koa")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" items "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" title"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'title1'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" title"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'title2'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/api/jsonp'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" cb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" id "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" title "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" items"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("find")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("item")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" item"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'title'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("cb"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("stringify")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("title"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/api/jsonps'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" cb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("cb"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("stringify")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'listen 8080...'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h5",{attrs:{id:"_4-2-3、nginx-代理服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-3、nginx-代理服务"}},[t._v("#")]),t._v(" 4-2-3、Nginx 代理服务")]),t._v(" "),a("ul",[a("li",[t._v("正向代理服务器是帮助 "),a("strong",[t._v("客户端")]),t._v("，访问自身无法访问的服务器并将结果返回客户端；")]),t._v(" "),a("li",[t._v("反向代理服务器是帮助其他 "),a("strong",[t._v("服务器")]),t._v("，获取到客户端发送请求并转交服务器；")])]),t._v(" "),a("img",{staticStyle:{zoom:"40%"},attrs:{src:"/Image/Chromium/7.png",align:"left"}}),t._v(" "),a("p",[t._v("Nginx 是一种高性能的反向代理服务器，可解决跨域问题：")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("  client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("api "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Nginx 相当于是一个跳板机，域名是 "),a("code",[t._v("client.com")]),t._v("，客户端首先访问 "),a("code",[t._v("client.com/api")]),t._v("，然后 Nginx 服务器作为反向代理，将请求转发给 "),a("code",[t._v("server.com")]),t._v("，当响应返回时又将响应给到客户端，完成整个跨域请求；")]),t._v(" "),a("h5",{attrs:{id:"_4-2-4、题外话"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-4、题外话"}},[t._v("#")]),t._v(" 4-2-4、题外话")]),t._v(" "),a("p",[t._v("其实还有一些不太常用的方式，大家了解即可，比如"),a("code",[t._v("postMessage")]),t._v("，当然"),a("code",[t._v("WebSocket")]),t._v("也是一种方式，但是已经不属于 HTTP 的范畴，另外一些奇技淫巧就不建议大家去死记硬背了，一方面从来不用，名字都难得记住，另一方面临时背下来，面试官也不会对你印象加分，因为看得出来是背的。当然没有背并不代表减分，把跨域原理和前面三种主要的跨域方式理解清楚，经得起更深一步的推敲，反而会让别人觉得你是一个靠谱的人。")]),t._v(" "),a("h4",{attrs:{id:"_4-x、跨标签通讯"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-x、跨标签通讯"}},[t._v("#")]),t._v(" 4-X、跨标签通讯")]),t._v(" "),a("p",[t._v("不同标签页间的通讯，本质原理就是去运用一些可以 "),a("u",[t._v("共享的中间介质")]),t._v("，常用以下方法:")]),t._v(" "),a("ul",[a("li",[t._v("通过父页面 "),a("code",[t._v("window.open()")]),t._v("和子页面 "),a("code",[t._v("postMessage")]),t._v("；\n"),a("ul",[a("li",[t._v("异步下，通过 "),a("code",[t._v("window.open('about: blank')")]),t._v(" 和 "),a("code",[t._v("tab.location.href = '*'；")])])])]),t._v(" "),a("li",[t._v("设置同域下共享的 "),a("code",[t._v("localStorage")]),t._v("与监听  "),a("code",[t._v("window.onstorage")]),t._v("；\n"),a("ul",[a("li",[t._v("重复写入相同的值无法触发；")]),t._v(" "),a("li",[t._v("会受到浏览器隐身模式等的限制；")])])]),t._v(" "),a("li",[t._v("设置共享 "),a("code",[t._v("cookie")]),t._v(" 与不断轮询脏检查( "),a("code",[t._v("setInterval")]),t._v(")；")]),t._v(" "),a("li",[t._v("借助服务端或者中间层实现；")])]),t._v(" "),a("h3",{attrs:{id:"五、浏览器应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、浏览器应用"}},[t._v("#")]),t._v(" 五、浏览器应用")]),t._v(" "),a("h4",{attrs:{id:"_5-1、防抖与节流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-1、防抖与节流"}},[t._v("#")]),t._v(" 5-1、防抖与节流")]),t._v(" "),a("p",[t._v("防抖与节流函数是一种最常用的 "),a("strong",[t._v("高频触发优化方式")]),t._v("，均为缓解函数频繁调用、在时间轴上控制函数的执行次数、控制事件触发频率；")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/333.png",align:"left"}}),t._v(" "),a("h5",{attrs:{id:"_5-1-1、防抖-debounce"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-1、防抖-debounce"}},[t._v("#")]),t._v(" 5-1-1、防抖 (debounce)")]),t._v(" "),a("p",[t._v('基本：等待一定时间再触发，概念衍生自机械开关和继电器的 "去弹跳"(debounce)；')]),t._v(" "),a("p",[a("u",[t._v("防抖，即短时间内大量触发同一事件，只会执行一次函数，将多次高频操作优化为只在最后一次执行；")])]),t._v(" "),a("p",[t._v("原理：为设置一个定时器，约定在xx毫秒后再触发事件处理，每次触发事件都会重新设置计时器，直到xx毫秒内无第二次操作；")]),t._v(" "),a("p",[t._v("场景：输入验证过滤、表单提交、滚动条的监听事件处理、只需再输入完成后做一次输入校验即可；")]),t._v(" "),a("ul",[a("li",[t._v("按钮提交场景：防止多次提交按钮，只执行最后提交的一次、表单验证")]),t._v(" "),a("li",[t._v("后台验证场景：表单验证需要服务端配合，只执行一段连续的输入事件的最后一次，还有搜索联想词功能类似")]),t._v(" "),a("li",[t._v("用户窗口缩放：resize事件(如窗口停止改变大小之后重新计算布局)等，没错，这里也可以用防抖")]),t._v(" "),a("li",[t._v("搜索输入查询：用户在输入时，没有必要不停地调用去请求服务端接口，等用户停止输入的时候，再调用，设置一个合适的时间间隔，有效减轻服务端压力")]),t._v(" "),a("li",[t._v("更多："),a("a",{attrs:{href:"https://github.com/Advanced-Frontend/Daily-Interview-Question/issues/129",target:"_blank",rel:"noopener noreferrer"}},[t._v("input 搜索防抖处理中文输入"),a("OutboundLink")],1),t._v(" - "),a("u",[t._v("提示：利用 e.target.compositionstart-ed 事件")])])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 思路：每次触发事件时都取消之前的延时调用方法；")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 思路：将多个信号合并成一个信号；防抖意味着 N 秒内函数只会被执行一次，若 N 秒内再次被触发，则重新计算延迟时间；")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 思路：持续触发不执行、不触发一段时间后再执行；")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 实现1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("debounce")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("func"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wait")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将 debounce 处理结果当做函数返回")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 保留调用时的 this 上下文")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" context "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 保留调用时传入的参数")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" args "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" arguments\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 事件触发时清除先前旧的定时器")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("clearTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设立新定时器")]),t._v("\n        timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("func")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 实现2")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("debounce")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" immediate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" timer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" args "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" arguments\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" context "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("immediate "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("timer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("timer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("clearTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("timer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        timer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 实现3")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("debounce")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("func"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wait")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" context "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" args "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" arguments"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("clearTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("func")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用")]),t._v("\nwindow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("onscroll "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("debounce")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'debounce'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用2")]),t._v("\ndocument"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'scroll'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("debounce")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" consol"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'debounce done'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("img",{staticStyle:{zoom:"80%"},attrs:{src:"/Image/Chromium/334.png",align:"left"}}),t._v(" "),a("h5",{attrs:{id:"_5-1-2、节流-throttle"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-2、节流-throttle"}},[t._v("#")]),t._v(" 5-1-2、节流 (throttle)")]),t._v(" "),a("p",[t._v("区别：防抖是延迟执行，而节流是间隔执行；防抖每次触发事件都重置定时器，而节流在定时器到时间后再清空定时器；")]),t._v(" "),a("p",[a("u",[t._v("节流，即每隔一段时间就执行一次；每隔一段时间后执行一次，也就是降低频率(稀释函数的执行频率)，将高频操作优化成低频操作；")])]),t._v(" "),a("p",[t._v("原理：设置一个定时器，约定xx毫秒后执行事件，若时间到了，则执行函数并重置定时器；")]),t._v(" "),a("p",[t._v("场景：滚动条事件、resize 事件，通常每隔 100~500 ms 执行一次即可；")]),t._v(" "),a("ul",[a("li",[t._v("拖拽场景：固定时间内只执行一次，防止超高频次触发位置变动")]),t._v(" "),a("li",[t._v("缩放场景：监控浏览器resize")]),t._v(" "),a("li",[t._v("动画场景：避免短时间内多次触发动画引起性能问题")]),t._v(" "),a("li",[t._v("其他场景：按钮点击事件、拖拽事件、onScoll、计算鼠标移动的距离(mousemove)")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 思路：每次触发事件时都判断当前是否有等待执行的延时函数；")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 思路：规定在单位时间内，只能触发一次函数，若这个单位时间内触发多次函数，只有一次生效；")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 思路：持续触发并不会执行多次，到一定时间再去执行；")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 实现1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("throttle")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("func"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wait")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" context "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" args "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" arguments\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("func")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 实现2")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用两个时间戳 prev 旧时间戳和 now 新时间戳，每次触发事件都判断二者的时间差，如果到达规定时间，执行函数并重置旧时间戳")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("throttle")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("func"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wait")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" prev "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" now "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" context "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" args "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" arguments"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("now "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" prev "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("func")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            prev "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" now"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 实现3")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("throttle")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" immediate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" timer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" callNow "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" immediate\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" context "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            args "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" arguments\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("callNow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            callNow "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("timer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            timer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                timer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 实现4")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("throttle")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" delay")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" prevTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" curTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("curTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" prevTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" delay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" arguments"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      prevTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" curTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 实现5")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("throttle")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" delay "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" flag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("flag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    flag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" arguments"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      flag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" delay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ES6")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("throttle")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("fn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" delay "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" flag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("args")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("flag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    flag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      flag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" delay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 实现6")]),t._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" throtteScroll "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("throttle")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'throtte'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nwindow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("onscroll "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" throtteScroll"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/335.png",align:"left"}}),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/336.png",align:"left"}}),t._v(" "),a("p",[t._v("5-1-3、用 Throttle 来优化 Debbounce")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/337.png",align:"left"}}),t._v(" "),a("h4",{attrs:{id:"_5-2、图片懒加载"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-2、图片懒加载"}},[t._v("#")]),t._v(" 5-2、图片懒加载")]),t._v(" "),a("h4",{attrs:{id:"_5-3、webworker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-3、webworker"}},[t._v("#")]),t._v(" 5-3、WebWorker")]),t._v(" "),a("p",[t._v("现代浏览器为 JS 创造的 "),a("strong",[t._v("多线程环境")]),t._v("；可新建并将部分任务分配到"),a("code",[t._v("worker")]),t._v("线程并行运行，两个线程可 "),a("strong",[t._v("独立运行，互不干扰")]),t._v("，可通过自带的 "),a("strong",[t._v("消息机制")]),t._v(" 相互通信；")]),t._v(" "),a("ul",[a("li",[t._v("同源限制")]),t._v(" "),a("li",[t._v("无法使用 "),a("code",[t._v("document")]),t._v(" / "),a("code",[t._v("window")]),t._v(" / "),a("code",[t._v("alert")]),t._v(" / "),a("code",[t._v("confirm")])]),t._v(" "),a("li",[t._v("无法加载本地资源")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建 worker")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" worker "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Worker")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'work.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 向 worker 线程推送消息")]),t._v("\nworker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("postMessage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Hello World'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 监听 worker 线程发送过来的消息")]),t._v("\nworker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onmessage")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Received message '")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"六、输入url到展示过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#六、输入url到展示过程"}},[t._v("#")]),t._v(" 六、输入URL到展示过程")]),t._v(" "),a("ul",[a("li",[t._v("DNS 解析：通过域名查询到具体的 IP (详看 DNS 章节)\n"),a("ul",[a("li",[t._v("操作系统会在本地缓存中查询 IP；若无则去系统配置的 DNS 服务器中查询；若无则直接去 DNS "),a("u",[t._v("根服务器查询")]),t._v("，查询会找出负责 "),a("code",[t._v("com")]),t._v(" 这个一级域名的服务器；然后去 "),a("u",[t._v("一级域名服务器")]),t._v(" 查询 "),a("code",[t._v("google")]),t._v(" 这个二级域名，直至找到最终匹配域名 IP；")]),t._v(" "),a("li",[t._v("上述为 DNS 迭代查询，还有种递归查询，区别是前者是由客户端发起请求，后者是由系统配置的 DNS 服务器做请求，得到结果后将数据返回给客户端；")])])]),t._v(" "),a("li",[t._v("TCP 三次握手；\n"),a("ul",[a("li",[t._v("应用层会下发数据给传输层，TCP 协议会指明两端的端口号，然后下发给网络层；网络层中的 IP 协议会确定 IP 地址，并且指示数据传输中如何跳转路由器；然后包会再被封装到数据链路层的数据帧结构中，最后就是物理层面的传输；")])])]),t._v(" "),a("li",[t._v("TLS 握手；握手流程与加密方式发展；")]),t._v(" "),a("li",[t._v("分析 URL，设置请求报文(头，主体)，发送请求；")]),t._v(" "),a("li",[t._v("服务器响应；")]),t._v(" "),a("li",[t._v("浏览器解析与渲染；\n"),a("ul",[a("li",[t._v("解析时，若是 gzip 格式的话则先解压，然后通过文件的编码格式知道该如何去解码文件；")]),t._v(" "),a("li",[t._v("若遇到 script 标签，判断是否存在 async 或 defer ：\n"),a("ul",[a("li",[t._v("前者会并行进行下载和执行 JS，后者会先下载文件，后等待 HTML 解析完成后顺序执行；否则阻塞渲染；")])])]),t._v(" "),a("li",[t._v("HTML parser --\x3e DOM Tree\n"),a("ul",[a("li",[t._v("标记化算法，进行元素状态的标记；")]),t._v(" "),a("li",[t._v("DOM 树构建；")])])]),t._v(" "),a("li",[t._v("CSS parser --\x3e Style Tree\n"),a("ul",[a("li",[t._v("解析 CSS 代码，生成样式树；")])])]),t._v(" "),a("li",[t._v("attachment --\x3e Render Tree\n"),a("ul",[a("li",[t._v("结合 DOM 树 与 style 树，生成渲染树；")])])]),t._v(" "),a("li",[t._v("Layout：布局")]),t._v(" "),a("li",[t._v("GPU painting: 像素绘制页面")])])])]),t._v(" "),a("h4",{attrs:{id:"_6-1、网络相关"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-1、网络相关"}},[t._v("#")]),t._v(" 6-1、网络相关")]),t._v(" "),a("h5",{attrs:{id:"_6-1-1、网络请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-1、网络请求"}},[t._v("#")]),t._v(" 6-1-1、网络请求")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("构建请求：浏览器会构建请求行 "),a("code",[t._v("GET / HTTP/1.1")])])]),t._v(" "),a("li",[a("p",[t._v("查找强缓存：检查强缓存，若命中直接使用，否则进入下一步；")])]),t._v(" "),a("li",[a("p",[t._v("DNS 解析：域名与 IP 的转换系统，但浏览器提供 "),a("u",[t._v("DNS数据缓存功能")]),t._v("，若某域名已解析过，则会将结果缓存再利用；默认端口 80；")])]),t._v(" "),a("li",[a("p",[t._v("建立 TCP 连接：Chrome 在同一域名下要求同时最多只能有 6 个 TCP 连接，超过则需等待；"),a("u",[t._v("详看 TCP 协议")]),t._v("；")])]),t._v(" "),a("li",[a("p",[t._v("发送 HTTP 请求：请求体只在 POST 方式才会存在；"),a("u",[t._v("详看 HTTP 协议")]),t._v("；")])])]),t._v(" "),a("div",{staticClass:"language-http extra-class"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Accept:")]),t._v(" text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Accept-Encoding:")]),t._v(" gzip, deflate, br\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Accept-Language:")]),t._v(" zh-CN,zh;q=0.9\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Cache-Control:")]),t._v(" no-cache\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Connection:")]),t._v(" keep-alive\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Cookie:")]),t._v(" ......\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Host:")]),t._v(" www.google.com\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Pragma:")]),t._v(" no-cache\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Upgrade-Insecure-Requests:")]),t._v(" 1\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("User-Agent:")]),t._v(" Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1\n")])])]),a("h5",{attrs:{id:"_6-1-2、网络响应"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-2、网络响应"}},[t._v("#")]),t._v(" 6-1-2、网络响应")]),t._v(" "),a("p",[t._v("HTTP 请求到达服务器，服务器进行相关处理并响应；"),a("u",[t._v("详看 HTTP 协议")]),t._v("；")]),t._v(" "),a("p",[t._v("响应头包含了服务器及其返回数据的一些信息、服务器生成数据的时间、返回的数据类型以及对即将写入的 Cookie 等信息；")]),t._v(" "),a("p",[t._v("注意：若请求或响应头中包含 "),a("strong",[t._v("Connection: Keep-Alive")]),t._v("，则表示建立 "),a("u",[t._v("持久连接")]),t._v("，随后请求统一站点的资源会复用此连接，否则断开连接, 流程结束；")]),t._v(" "),a("div",{staticClass:"language-http extra-class"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Cache-Control:")]),t._v(" no-cache\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Connection:")]),t._v(" keep-alive\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Content-Encoding:")]),t._v(" gzip\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Content-Type:")]),t._v(" text/html;charset=utf-8\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Date:")]),t._v(" Wed, 04 Dec 2019 12:29:13 GMT\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Server:")]),t._v(" apache\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Set-Cookie:")]),t._v(" rsv_i=f9a0SIItKqzv7kqgAAgphbGyRts3RwTg%2FLyU3Y5Eh5LwyfOOrAsvdezbay0QqkDqFZ0DfQXby4wXKT8Au8O7ZT9UuMsBq2k; path=/; domain=.google.com\n")])])]),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/15.png"}}),t._v(" "),a("h4",{attrs:{id:"_6-x、浏览器解析渲染流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-x、浏览器解析渲染流程"}},[t._v("#")]),t._v(" 6-X、浏览器解析渲染流程")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/17.png"}}),t._v(" "),a("ul",[a("li",[t._v("渲染进程将 HTML 内容转换为能够读懂的 "),a("strong",[a("u",[t._v("DOM 树")])]),t._v("；")]),t._v(" "),a("li",[t._v("渲染引擎将 CSS 样式表转化为浏览器可理解的 styleSheets，计算出 DOM 节点的样式；")]),t._v(" "),a("li",[t._v("创建 "),a("strong",[a("u",[t._v("布局树")])]),t._v("，并计算元素的布局信息；")]),t._v(" "),a("li",[t._v("对布局树进行分层，并生成 "),a("strong",[a("u",[t._v("分层树")])]),t._v("；")]),t._v(" "),a("li",[t._v("为每个图层生成 "),a("strong",[a("u",[t._v("绘制列表")])]),t._v("，并将其提交到 "),a("strong",[a("u",[t._v("合成线程")])]),t._v("，合成线程将图层分图块，并栅格化将图块转换成位图；")]),t._v(" "),a("li",[t._v("合成线程发送绘制图块命令给浏览器进程，浏览器进程根据指令生成页面，并显示到显示器上；")])]),t._v(" "),a("h4",{attrs:{id:"_6-2、解析相关"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2、解析相关"}},[t._v("#")]),t._v(" 6-2、解析相关")]),t._v(" "),a("p",[t._v("完成网络请求，若响应头中  "),a("code",[t._v("Content-Type")]),t._v(" 值是 "),a("code",[t._v("text/html")]),t._v("，则**"),a("u",[t._v("进入浏览器解析与渲染工作")]),t._v("**，解析部分主要分为以下几个步骤:")]),t._v(" "),a("ul",[a("li",[a("strong",[a("u",[t._v("构建 DOM 树")])])]),t._v(" "),a("li",[a("strong",[a("u",[t._v("样式计算")])])]),t._v(" "),a("li",[a("u",[a("strong",[t._v("生成布局树(Layout Tree)")])])])]),t._v(" "),a("p",[a("strong",[a("u",[t._v("注意：下述内容极为简略，只作为回忆说明：")])])]),t._v(" "),a("ul",[a("li",[t._v("DOM 树：字节数据—>字符串—>Token—>Node—>DOM\n"),a("ul",[a("li",[t._v("网络01 "),a("u",[t._v("字节数据")]),t._v("—>")]),t._v(" "),a("li",[a("u",[t._v("HTML字符串")]),t._v("—>")]),t._v(" "),a("li",[t._v("通过词法分析转换为 "),a("u",[t._v("标记(标记化—tokenization)(标记还是字符串，是构成代码的最小单位)")]),t._v("—>")]),t._v(" "),a("li",[t._v("转换为 Node，并根据不同 Node 之前的联系构建为一颗 DOM 树；")])])]),t._v(" "),a("li",[t._v("CSSOM 树(同步进行)：字节数据—>字符串—>Token—>Node—>CSSOM\n"),a("ul",[a("li",[t._v("格式化、标准化、并根据继承与层叠规则计算节点具体样式；")])])]),t._v(" "),a("li",[t._v("生成渲染树(旧式)")]),t._v(" "),a("li",[t._v("布局显示(旧式)")])]),t._v(" "),a("h5",{attrs:{id:"_6-2-1、构建-dom-树"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-1、构建-dom-树"}},[t._v("#")]),t._v(" 6-2-1、构建 DOM 树")]),t._v(" "),a("p",[t._v("由于浏览器无法直接理解 "),a("strong",[a("u",[t._v("HTML字符串")])]),t._v("，因此需要先将 HTML 的原始字节数据，转换为文件指定编码的字符，然后浏览器会根据 HTML 规范来将字符串转换成各种令牌标签，最终解析成一个树状的对象数据结构——"),a("strong",[a("u",[t._v("DOM树")])]),t._v("；其本质上是一个以 "),a("code",[t._v("document")]),t._v(" 为根节点的多叉树；")]),t._v(" "),a("h5",{attrs:{id:"_6-2-1-1、html-文法本质"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-1-1、html-文法本质"}},[t._v("#")]),t._v(" 6-2-1-1、HTML 文法本质")]),t._v(" "),a("p",[t._v("注意：此处的 HTML 的文法并非指 "),a("strong",[a("u",[t._v("上下文无关文法")])]),t._v("；在计算机科学 "),a("u",[t._v("编译原理")]),t._v(" 学科中，有非常明确的定义:")]),t._v(" "),a("blockquote",[a("p",[t._v("若一个形式文法G = (N, Σ, P, S) 的产生式规则都取如下的形式：V->w，则叫上下文无关语法。其中 V∈N ，w∈(N∪Σ)* 。")])]),t._v(" "),a("p",[t._v("其中把 G = (N, Σ, P, S) 中各个参量的意义解释一下:")]),t._v(" "),a("ol",[a("li",[t._v("N 是"),a("u",[a("strong",[t._v("非终结符")])]),t._v("(即最后的符号不是它，下同)集合；")]),t._v(" "),a("li",[t._v("Σ 是"),a("u",[a("strong",[t._v("终结符")])]),t._v("集合；")]),t._v(" "),a("li",[t._v("P 是**"),a("u",[t._v("开始符")]),t._v("**，它必须属于 N ，也即非终结符；")]),t._v(" "),a("li",[t._v("S 就是不同的产生式的集合；比如 S -> aSb 等等；")])]),t._v(" "),a("p",[t._v("用人话讲，"),a("strong",[a("u",[t._v("上下文无关的文法，就是这个文法中所有产生式的左边都是一个非终结符")])]),t._v(" ，比如：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("// 下面文法中，每个产生式左边都会有一个非终结符，这就是: 上下文无关的文法; 此时，`xBy`一定是可以规约出`xAy`的；\nA -> B\n")])])]),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("// 反例:\n// 下面就是: 非上下文无关的文法; 当遇到 B 时，无法判断是否可以规约出 A，因为取决于左边或右边是否有 a 存在, 故下面是和上下文有关的\naA -> B\nAa -> B\n")])])]),a("p",[t._v("注意："),a("strong",[a("u",[t._v("规范的 HTML 语法")])]),t._v("，"),a("strong",[a("u",[t._v("是符合上下文无关文法的")])]),t._v("，能够体现它 "),a("strong",[a("u",[t._v("非上下文无关文法的")])]),t._v(" 在它的 "),a("strong",[t._v("不标准的语法")]),t._v("，比如反例证明如下：")]),t._v(" "),a("p",[t._v("因为：解析器扫描到 "),a("code",[t._v("form")]),t._v(" 标签时，"),a("strong",[a("u",[t._v("上下文无关文法")])]),t._v(" 的处理方式是直接创建对应 form 的 DOM 对象，而真实 HTML5 场景中却不是这样，解析器会查看 "),a("code",[t._v("form")]),t._v(" 上下文，若此 "),a("code",[t._v("form")]),t._v(" 标签的父标签也是 "),a("code",[t._v("form")]),t._v("，则 "),a("strong",[t._v("直接跳过")]),t._v(" 当前 "),a("code",[t._v("form")]),t._v(" 标签，否则才创建 DOM 对象；")]),t._v(" "),a("p",[t._v("所以：在不标准的语法时，是非上下文无关文法，则标准语法中，就是上下文无关文法(注意多重否定表肯定)；")]),t._v(" "),a("p",[a("strong",[a("u",[t._v("注意：上面的叙述想表达的是规范的 HTML 语法是符合上下文无关文法的，但真实场景和实际解析中，考虑到不标准语法的行为，所以是非上下文无关文法；")])])]),t._v(" "),a("p",[a("strong",[a("u",[t._v("注意：即理论与实际不符，表示 HTML 不能使用常规语言解析器(常规编程语言一般为上下文无关)完成 HTML Parse；")])])]),t._v(" "),a("h5",{attrs:{id:"_6-2-1-2、解析算法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-1-2、解析算法"}},[t._v("#")]),t._v(" 6-2-1-2、解析算法")]),t._v(" "),a("p",[t._v("HTML5 "),a("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/parsing.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("规范"),a("OutboundLink")],1),t._v(" 详细地介绍解析算法，算法分为两个阶段:")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("标记化算法")]),t._v("；对应过程为 "),a("strong",[t._v("词法分析")]),t._v("；")]),t._v(" "),a("li",[a("strong",[t._v("建树算法")]),t._v("；对应过程为 "),a("strong",[t._v("语法分析")]),t._v("；")])]),t._v(" "),a("h5",{attrs:{id:"_6-2-1-2-1、标记化算法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-1-2-1、标记化算法"}},[t._v("#")]),t._v(" 6-2-1-2-1、标记化算法")]),t._v(" "),a("p",[t._v("算法输入为 "),a("u",[t._v("HTML文本")]),t._v("，输出为 "),a("u",[t._v("HTML标记")]),t._v("，故亦称 "),a("u",[a("strong",[t._v("标记生成器")])]),t._v("；")]),t._v(" "),a("p",[t._v("算法运用 "),a("strong",[a("u",[t._v("有限自动状态机")])]),t._v(" 来完成：即在当前状态下，接收一或多个字符，就会更新到下一状态；比如：")]),t._v(" "),a("div",{staticClass:"language-html extra-class"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[t._v("// 标记化过程展示示例\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("body")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    Hello Beijing\n  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("body")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("ul",[a("li",[t._v("首先，遇到 "),a("code",[t._v("<")]),t._v(", 状态为 "),a("strong",[t._v("标记打开")]),t._v("；")]),t._v(" "),a("li",[t._v("然后，接收 "),a("code",[t._v("[a-z]")]),t._v(" 字符，并进入 "),a("strong",[t._v("标记名称状态")]),t._v("；")]),t._v(" "),a("li",[t._v("然后，上述状态一直保持，直到遇到 "),a("code",[t._v(">")]),t._v("，表示标记名称记录完成，此时进入 "),a("strong",[t._v("数据状态")]),t._v("；")]),t._v(" "),a("li",[t._v("然后，后续的 "),a("code",[t._v("body")]),t._v("  标签做同样处理；")]),t._v(" "),a("li",[t._v("然后，当来到 "),a("code",[t._v("<body>")]),t._v(" 中的 "),a("code",[t._v(">")]),t._v("，进入"),a("strong",[t._v("数据状态")]),t._v("，之后保持此状态接收后面字符 "),a("strong",[t._v("hello sanyuan")]),t._v("；")]),t._v(" "),a("li",[t._v("接着，接收 "),a("code",[t._v("</body>")]),t._v("  中的 "),a("code",[t._v("<")]),t._v("，回到 "),a("strong",[t._v("标记打开")]),t._v("，在接收下一个字符 "),a("code",[t._v("/")]),t._v("  时，此时会创建一个 "),a("code",[t._v("end tag")]),t._v(" 的 token；")]),t._v(" "),a("li",[t._v("随后，进入 "),a("strong",[t._v("标记名称状态")]),t._v("，遇到 "),a("code",[t._v(">")]),t._v(" 则回到"),a("strong",[t._v("数据状态")]),t._v("；")]),t._v(" "),a("li",[t._v("最后，以同样的样式处理 "),a("code",[t._v("</html>")]),t._v("；")])]),t._v(" "),a("h5",{attrs:{id:"_6-2-1-2-2、建树算法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-1-2-2、建树算法"}},[t._v("#")]),t._v(" 6-2-1-2-2、建树算法")]),t._v(" "),a("p",[t._v("​\t回顾一下，解析第一步是构建 "),a("strong",[a("u",[t._v("DOM 树")])]),t._v("，是因为浏览器无法直接理解 "),a("strong",[a("u",[t._v("HTML字符串")])]),t._v("，因此需要先将这系列的字节流，转换为一种有意义的、且方便操作的数据结构——"),a("strong",[a("u",[t._v("DOM 树")])]),t._v("；而 **"),a("u",[t._v("DOM 树")]),t._v("**是一个以 "),a("code",[t._v("document")]),t._v(" 为根节点的多叉树；所以，"),a("u",[a("strong",[t._v("解析器")])]),t._v("  首先会创建一个 "),a("code",[t._v("document")]),t._v(" 对象 (作为 "),a("strong",[a("u",[t._v("DOM 树")])]),t._v(" 的根节点)；")]),t._v(" "),a("p",[t._v("​\t随后，"),a("u",[a("strong",[t._v("标记生成器")])]),t._v(" 会将每个标记的信息发送给 "),a("strong",[a("u",[t._v("建树器")])]),t._v("，"),a("strong",[a("u",[t._v("建树器")])]),t._v("  接收到相应的标记时，会 "),a("strong",[t._v("创建对应的 DOM 对象")]),t._v("，在创建这个 "),a("code",[t._v("DOM对象")]),t._v(" 后会做两件事：")]),t._v(" "),a("ul",[a("li",[t._v("将 "),a("code",[t._v("DOM对象")]),t._v(" 加入 "),a("strong",[a("u",[t._v("DOM 树")])]),t._v(" 中；")]),t._v(" "),a("li",[t._v("将对应标记，压入存放 "),a("strong",[t._v("开放(与"),a("u",[t._v("闭合标签")]),t._v("意思对应)元素")]),t._v(" 的栈中；")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("<html>\n  <body>\n    Hello Beijing\n  </body>\n</html>\n")])])]),a("ul",[a("li",[t._v("首先，状态为  "),a("strong",[t._v("初始化状态")]),t._v("；")]),t._v(" "),a("li",[t._v("然后，("),a("strong",[a("u",[t._v("建树器")])]),t._v(")接收到 "),a("strong",[a("u",[t._v("标记生成器")])]),t._v(" 传来的 "),a("code",[t._v("html")]),t._v(" 标记，此时状态变为 "),a("strong",[t._v("before html状态")]),t._v("，同时创建一个 "),a("code",[t._v("HTMLHtmlElement")]),t._v(" DOM 元素，并将其添加到 "),a("code",[t._v("document")]),t._v(" 根对象上，并进行压栈操作；")]),t._v(" "),a("li",[t._v("随后，状态自动变为 "),a("strong",[t._v("before head")]),t._v("，此时从标记生成器那边传来 "),a("code",[t._v("body")]),t._v(" 标记，表示并没有 "),a("code",[t._v("head")]),t._v(" 标签， 此时 "),a("strong",[a("u",[t._v("建树器")])]),t._v(" 会自动创建一个 "),a("code",[t._v("HTMLHeadElement")]),t._v("  (DOM 元素)，并将其添加入到 "),a("strong",[a("u",[t._v("DOM 树")])]),t._v(" 中；")]),t._v(" "),a("li",[t._v("然后，进入到 "),a("strong",[t._v("in head")]),t._v(" 状态，随机直接跳到  "),a("strong",[t._v("after head")]),t._v("；")]),t._v(" "),a("li",[t._v("然后，现在 "),a("strong",[a("u",[t._v("标记生成器")])]),t._v(" 传来了 "),a("code",[t._v("body")]),t._v(" 标记，创建 "),a("code",[t._v("HTMLBodyElement")]),t._v("(DOM 元素)，插入到 "),a("strong",[a("u",[t._v("DOM 树")])]),t._v(" 中，同时压入开放标记栈；")]),t._v(" "),a("li",[t._v("随后，状态变为 "),a("strong",[t._v("in body")]),t._v("，然后接收后面系列字符："),a("strong",[t._v("Hello Beijing")]),t._v("，接收到第一个字符时，会创建 "),a("strong",[t._v("Text")]),t._v(" 节点并将字符插入其中，然后把 "),a("strong",[t._v("Text")]),t._v(" 节点插入到 "),a("strong",[a("u",[t._v("DOM 树")])]),t._v(" 中的 "),a("code",[t._v("body元素")]),t._v("的下面；后续不断接收后面字符，字符会附在 "),a("strong",[t._v("Text")]),t._v(" 节点上；")]),t._v(" "),a("li",[t._v("然后，"),a("strong",[t._v("标记生成器")]),t._v(" 传过来一个 "),a("code",[t._v("body")]),t._v(" 的结束标记，进入 "),a("strong",[t._v("after body")]),t._v(" 状态；")]),t._v(" "),a("li",[t._v("最后，**标记生成器 **传过来一个 "),a("code",[t._v("html")]),t._v(" 的结束标记，进入 "),a("strong",[t._v("after after body")]),t._v(" 状态，表示解析过程到此结束；")])]),t._v(" "),a("h5",{attrs:{id:"_6-2-1-2-3、容错机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-1-2-3、容错机制"}},[t._v("#")]),t._v(" 6-2-1-2-3、容错机制")]),t._v(" "),a("p",[t._v("HTML5规范宽容策略十分强悍，接下来是 WebKit 中一些经典的容错示例：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("表单元素嵌套：直接忽略里面的 "),a("code",[t._v("form")]),t._v("；")])]),t._v(" "),a("li",[a("p",[t._v("使用 "),a("code",[t._v("</br>")]),t._v("  而不是 "),a("code",[t._v("<br>")])])])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("if (t->isCloseTag(brTag) && m_document->inCompatMode()) {\n  reportError(MalformedBRError);\n  t->beginTag = true;\n}\n// 全部换为 <br> 形式\n")])])]),a("ul",[a("li",[t._v("表格离散")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("<table>\n  <table>\n    <tr><td>inner table</td></tr>\n  </table>\n  <tr><td>outer table</td></tr>\n</table>\n")])])]),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("// WebKit 会自动转换为:\n<table>\n    <tr><td>outer table</td></tr>\n</table>\n<table>\n    <tr><td>inner table</td></tr>\n</table>\n")])])]),a("h5",{attrs:{id:"_6-2-1-2-4、流程总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-1-2-4、流程总结"}},[t._v("#")]),t._v(" 6-2-1-2-4、流程总结")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/18.png",align:"left"}}),t._v(" "),a("ul",[a("li",[a("strong",[t._v("转码(Bytes -> Characters)")]),t._v(" "),a("ul",[a("li",[t._v("读取接收到的 HTML 二进制数据，按指定编码格式将字节转换为 HTML 字符串；")])])]),t._v(" "),a("li",[a("strong",[t._v("Tokens 化(Characters -> Tokens)")]),t._v(" "),a("ul",[a("li",[t._v("解析 HTML，将 HTML 字符串转换为结构清晰的 Tokens，每个 Token 都有特殊的含义同时有自己的一套规则；")])])]),t._v(" "),a("li",[a("strong",[t._v("构建 Nodes(Tokens -> Nodes)")]),t._v(" "),a("ul",[a("li",[t._v("每个 Node 都添加特定的属性(或属性访问器)，通过指针能够确定 Node 的父、子、兄弟关系和所属 treeScope")]),t._v(" "),a("li",[t._v("比如：iframe 的 treeScope 与外层页面的 treeScope 不同；")])])]),t._v(" "),a("li",[a("strong",[t._v("构建 DOM 树(Nodes -> DOM Tree)")]),t._v(" "),a("ul",[a("li",[t._v("最重要的工作是建立起每个结点的父子兄弟关系；")])])])]),t._v(" "),a("h5",{attrs:{id:"_6-2-2、样式计算"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-2、样式计算"}},[t._v("#")]),t._v(" 6-2-2、样式计算")]),t._v(" "),a("p",[t._v("即渲染引擎将 CSS 样式表转化为浏览器可以理解的 styleSheets，计算出 DOM 节点的样式；")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/19.png",align:"left"}}),t._v(" "),a("p",[t._v("上图即将所有值转换为渲染引擎容易理解、标准化的计算值，此过程为 "),a("strong",[a("u",[t._v("属性值标准化")])]),t._v("，处理完成后再处理样式的 "),a("strong",[a("u",[t._v("继承和层叠")])]),t._v("，整一过程亦称 CSSOM 构建过程；")]),t._v(" "),a("h5",{attrs:{id:"_6-2-2-1、格式化样式表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-2-1、格式化样式表"}},[t._v("#")]),t._v(" 6-2-2-1、格式化样式表")]),t._v(" "),a("p",[t._v("CSS 样式来源有三种：link 标签引用、style 标签样式、元素的内嵌 style 属性；")]),t._v(" "),a("p",[t._v("浏览器是无法直接识别 CSS 样式文本，因此渲染引擎收到 CSS 文本后第一件事情就是将其转化为一个结构化的对象 "),a("strong",[a("u",[t._v("styleSheets")])]),t._v("；在浏览器控制台能够通过"),a("code",[t._v("document.styleSheets")]),t._v("来查看这个最终结构，结构包含了以上 3 种 CSS来源，为后面的样式操作提供基础；")]),t._v(" "),a("p",[t._v("补充：格式化的过程过于复杂，而且对于不同的浏览器会有不同的优化策略，这里就不展开了；")]),t._v(" "),a("h5",{attrs:{id:"_6-2-2-2、标准化样式属性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-2-2、标准化样式属性"}},[t._v("#")]),t._v(" 6-2-2-2、标准化样式属性")]),t._v(" "),a("p",[t._v("有些 CSS 样式的数值并不容易被渲染引擎所理解，因此在计算样式前需要将它们标准化；比如 "),a("code",[t._v("em->px、red->#ff0000、bold->700")]),t._v(" 等；")]),t._v(" "),a("h5",{attrs:{id:"_6-2-2-3、计算每个节点的具体样式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-2-3、计算每个节点的具体样式"}},[t._v("#")]),t._v(" 6-2-2-3、计算每个节点的具体样式")]),t._v(" "),a("p",[t._v("CSS 样式被 "),a("u",[t._v("格式化")]),t._v(" 和 "),a("u",[t._v("标准化")]),t._v(" 后，便可计算每个节点的具体样式信息；计算遵从两个规则："),a("strong",[t._v("继承")]),t._v("、"),a("strong",[t._v("层叠")]),t._v("；")]),t._v(" "),a("ul",[a("li",[t._v("继承规则：每个子节点均默认继承父节点样式属性，若父节点中没有找到，则采用浏览器默认样式 "),a("code",[t._v("UserAgent样式")]),t._v("；")]),t._v(" "),a("li",[t._v("层叠规则："),a("u",[t._v("CSS 最大特点在于它的层叠性，也即最终样式取决于各个属性共同作用的效果")]),t._v("；")]),t._v(" "),a("li",[t._v("注意：在计算完样式之后，所有样式值会被挂在到 "),a("code",[t._v("window.getComputedStyle")]),t._v(" 当中，故可通过 JS 来获取计算后的样式；")])]),t._v(" "),a("h5",{attrs:{id:"_6-2-3、生成布局树"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-3、生成布局树"}},[t._v("#")]),t._v(" 6-2-3、生成布局树")]),t._v(" "),a("p",[t._v("布局过程即：利用前面的 "),a("strong",[a("u",[t._v("DOM 树")])]),t._v(" 和 "),a("strong",[a("u",[t._v("DOM 样式")])]),t._v(" ，排除 "),a("code",[t._v("script、meta")]),t._v(" 等功能化、非视觉节点，排除 "),a("code",[t._v("display: none")]),t._v(" 的节点，并通过浏览器的布局系统 "),a("u",[t._v("计算元素位置信息")]),t._v("、"),a("u",[t._v("确定元素位置")]),t._v("，构建一棵只包含可见元素的 "),a("strong",[a("u",[t._v("布局树(Layout Tree)")])]),t._v("；")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/20.png",align:""}}),t._v(" "),a("ul",[a("li",[t._v("遍历生成的 "),a("strong",[a("u",[t._v("DOM 树")])]),t._v(" 节点，并将它们添加到 "),a("strong",[a("u",[t._v("布局树")])]),t._v(" 中；")]),t._v(" "),a("li",[t._v("计算 "),a("strong",[a("u",[t._v("布局树")])]),t._v(" 节点的坐标位置；")]),t._v(" "),a("li",[t._v("注意："),a("strong",[a("u",[t._v("布局树")])]),t._v("  包含可见元素，设置"),a("code",[t._v("display: none")]),t._v("的元素和 "),a("code",[t._v("head")]),t._v(" 等功能标签，将不会被放入其中；")]),t._v(" "),a("li",[t._v("注意：现在 Chrome 团队已经做了大量重构，已经没有生成 "),a("strong",[a("u",[t._v("渲染树(Render Tree)")])]),t._v(" 的过程(布局树的信息已非常完善，完全拥有 Render Tree 的功能)；")]),t._v(" "),a("li",[t._v("补充："),a("a",{attrs:{href:"https://www.rrfed.com/2017/02/26/chrome-layout/",target:"_blank",rel:"noopener noreferrer"}},[t._v("从Chrome源码看浏览器如何layout布局"),a("OutboundLink")],1),t._v("。")])]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/9.png",align:"left"}}),t._v(" "),a("h4",{attrs:{id:"_6-3、渲染相关"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3、渲染相关"}},[t._v("#")]),t._v(" 6-3、渲染相关")]),t._v(" "),a("p",[t._v("渲染分为几个步骤：")]),t._v(" "),a("ul",[a("li",[a("strong",[a("u",[t._v("建立 图层树(Layer Tree)")])])]),t._v(" "),a("li",[a("strong",[a("u",[t._v("生成 绘制列表")])])]),t._v(" "),a("li",[a("strong",[a("u",[t._v("生成 图块 并 栅格化(生成位图)")])])]),t._v(" "),a("li",[a("strong",[a("u",[t._v("显示器显示内容")])])])]),t._v(" "),a("h5",{attrs:{id:"_6-3-1、建图层树-分层树-layer-tree"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-1、建图层树-分层树-layer-tree"}},[t._v("#")]),t._v(" 6-3-1、建图层树/分层树(Layer Tree)")]),t._v(" "),a("p",[t._v("​\t解析阶段得到 DOM节点、样式、位置信息，但还不足以开始绘制页面，因还需考虑页面中的复杂效果与场景，比如复杂 3D 动画变换效果、页面滚动、元素含层叠上下文时的显示与隐藏、使用 z-indexing 做 z 轴排序等；而为更加方便地实现这些效果，在浏览器在构建完 "),a("strong",[a("u",[t._v("布局树")])]),t._v(" 后(解析阶段最后一步)，渲染引擎还需为特定的节点生成专用图层，构建一棵 "),a("strong",[a("u",[t._v("图层树(Layer Tree)")])]),t._v("；")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/21.png"}}),t._v(" "),a("p",[t._v("​\t图层树通过显示隐式合成构建，一般情况下，节点的图层会默认属于父节点的图层("),a("strong",[t._v("亦称合成层")]),t._v(")，某些条件会触发将 "),a("strong",[a("u",[t._v("多个合成层")])]),t._v(" 提升为 "),a("strong",[a("u",[t._v("单独合成层")])]),t._v("，可分两种情况讨论："),a("strong",[t._v("显式合成")]),t._v("、"),a("strong",[t._v("隐式合成")])]),t._v(" "),a("h5",{attrs:{id:"_6-3-1-1、显式合成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-1-1、显式合成"}},[t._v("#")]),t._v(" 6-3-1-1、显式合成")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("拥有 "),a("u",[t._v("层叠上下文")]),t._v(" 属性的元素会单独提升为单独一层：层叠上下文是 HTML 元素的三维概念，这些 HTML 元素在一条假想的、相对于面向视窗或用户的 z 轴上延伸，HTML 元素依据其自身属性，按照优先级顺序占用层叠上下文空间；")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("根元素(HTML)")]),t._v(" 本身就具有层叠上下文；")]),t._v(" "),a("li",[t._v("元素的 "),a("strong",[t._v("filter")]),t._v(" 值不为 none；")]),t._v(" "),a("li",[t._v("元素的 "),a("strong",[t._v("clip-path")]),t._v(" 值不为 none；")]),t._v(" "),a("li",[t._v("元素的 "),a("strong",[t._v("transform")]),t._v(" 值不为 none；")]),t._v(" "),a("li",[t._v("元素的 "),a("strong",[t._v("perspective")]),t._v(" 值不为 none；")]),t._v(" "),a("li",[t._v("元素的 "),a("strong",[t._v("mix-blend-mode")]),t._v(" 值不为 normal；")]),t._v(" "),a("li",[t._v("元素的 "),a("strong",[t._v("z-index")]),t._v(" 值不为 auto，且为 flex 子项；")]),t._v(" "),a("li",[t._v("元素的 "),a("strong",[t._v("z-index")]),t._v(" 值不为 auto，且为 grid 子项；")]),t._v(" "),a("li",[t._v("元素的 "),a("strong",[t._v("z-index")]),t._v(" 值不为 auto，且为绝对/相对定位元素；")]),t._v(" "),a("li",[t._v("元素的 "),a("strong",[t._v("mask")]),t._v("、"),a("strong",[t._v("mask-image")]),t._v("、"),a("strong",[t._v("mask-border")]),t._v(" 不为 none；")]),t._v(" "),a("li",[t._v("元素的 "),a("strong",[t._v("isolation")]),t._v(" 值是 isolate；")]),t._v(" "),a("li",[t._v("元素的 "),a("strong",[t._v("-webkit-overflow-scrolling")]),t._v(" 值是 touch；")]),t._v(" "),a("li",[t._v("元素的 "),a("strong",[t._v("contain")]),t._v(" 值是 layout、paint、strict、content；")]),t._v(" "),a("li",[t._v("元素的 "),a("strong",[t._v("opacity")]),t._v(" 值是小于 1；(the specification for opacity)")]),t._v(" "),a("li",[t._v("元素的 **will-change ** 值是指定的任意属性；("),a("a",{attrs:{href:"https://dev.opera.com/articles/css-will-change-property/",target:"_blank",rel:"noopener noreferrer"}},[t._v("详看"),a("OutboundLink")],1),t._v(" )")])])]),t._v(" "),a("li",[a("p",[t._v("需要 "),a("u",[t._v("剪裁")]),t._v(" 的地方也会被创建为图层：")]),t._v(" "),a("ul",[a("li",[t._v("比如某个翠存放巨量文字的 100 * 100 像素大小的 DIV，超出的文字部分就需要被剪裁；若出现滚动条，则滚动条会被单独提升为一个图层；")])])])]),t._v(" "),a("h5",{attrs:{id:"_6-3-1-2、隐式合成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-1-2、隐式合成"}},[t._v("#")]),t._v(" 6-3-1-2、隐式合成")]),t._v(" "),a("p",[a("u",[t._v("层叠等级低")]),t._v(" 的节点被提升为单独图层后，则 "),a("u",[t._v("所有层叠等级比它高")]),t._v(" 的节点 **都会 **成为一个单独的图层；")]),t._v(" "),a("ul",[a("li",[t._v("注意：隐式合成隐藏巨大风险：若在一个大型应用中，当某个"),a("code",[t._v("z-index")]),t._v(" 比较低的元素，被提升为单独图层后，层叠在它上面的元素统统都会被提升为单独的图层，此时瞬间可能会增加上千个图层，大大增加内存压力，甚至直接让页面崩溃；此乃 "),a("strong",[a("u",[t._v("层爆炸")])]),t._v(" 原理，"),a("a",{attrs:{href:"https://segmentfault.com/a/1190000014520786",target:"_blank",rel:"noopener noreferrer"}},[t._v("例子在此"),a("OutboundLink")],1),t._v("；")]),t._v(" "),a("li",[t._v("注意：但当需要 "),a("code",[t._v("repaint")]),t._v(" 时，只需 "),a("code",[t._v("repaint")]),t._v(" 本身，而不会影响到其他的层；")])]),t._v(" "),a("h5",{attrs:{id:"_6-3-2、生成绘制列表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-2、生成绘制列表"}},[t._v("#")]),t._v(" 6-3-2、生成绘制列表")]),t._v(" "),a("p",[t._v("然后渲染引擎会将图层的绘制拆分成一个个绘制指令；比如先画背景、再描绘边框等，然后将这些指令按顺序组合成一个 "),a("strong",[a("u",[t._v("待绘制列表")])]),t._v("，相当于制作一份绘制操作任务清单，可在 Chrome 开发者工具中的"),a("code",[t._v("Layers")]),t._v("面板观察绘制列表:")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/11.png"}}),t._v(" "),a("h5",{attrs:{id:"_6-3-3、生成图块并栅格化-生成位图"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-3、生成图块并栅格化-生成位图"}},[t._v("#")]),t._v(" 6-3-3、生成图块并栅格化(生成位图)")]),t._v(" "),a("p",[t._v("实际上在渲染进程中，绘制操作由专门的线程—"),a("strong",[a("u",[t._v("合成线程")])]),t._v(" 来完成：")]),t._v(" "),a("ul",[a("li",[t._v("首先，当绘制列表准备好后，"),a("strong",[a("u",[t._v("渲染进程的主线程")])]),t._v(" 会给 "),a("strong",[a("u",[t._v("合成线程")])]),t._v(" 发送 "),a("code",[t._v("commit")]),t._v(" 消息，将 "),a("strong",[a("u",[t._v("绘制列表")])]),t._v(" 提交给 "),a("strong",[a("u",[t._v("合成线程")])]),t._v("；")]),t._v(" "),a("li",[t._v("然后，为避免："),a("u",[t._v("在有限视口内一次性绘制所有页面")]),t._v(" 而造成的性能浪费，"),a("strong",[a("u",[t._v("合成线程")])]),t._v(" 需要先将图层 "),a("strong",[t._v("分块")]),t._v("；\n"),a("ul",[a("li",[t._v("注意：分块大小规格一般为 256 * 256 或 512 * 512 ，以加速页面首屏展示；")]),t._v(" "),a("li",[t._v("注意：图块数据要进入 GPU 内存，而将数据从浏览器内存上传到 GPU 内存的操作较慢(即使绘制一部分图块也可能会耗费大量时间)，为解决此问题，Chrome 采用如下策略：首次合成图块时只采用一个 "),a("u",[t._v("低分辨率的图片")]),t._v(" ，故首屏展示时只是展示此图片，继续进行合成操作，当正常图块内容绘制完毕后，才将当前低分辨率的图块内容替换；此亦 Chrome 底层优化首屏加载速度的一个手段；")])])]),t._v(" "),a("li",[t._v("然后，"),a("strong",[a("u",[t._v("合成线程")])]),t._v(" 会选择视口附近的 "),a("strong",[t._v("图块")]),t._v("，优先将其交给 "),a("strong",[a("u",[t._v("栅格化线程池")])]),t._v(" 来生成位图；\n"),a("ul",[a("li",[t._v("注意：渲染进程中专门维护一个 "),a("strong",[a("u",[t._v("栅格化线程池")])]),t._v("，负责将 "),a("strong",[t._v("图块")]),t._v(" 转换为 "),a("strong",[t._v("位图数据")]),t._v("；")]),t._v(" "),a("li",[t._v("注意：生成位图的过程实际上都会使用 GPU 进行加速，生成的位图最后发送给 "),a("strong",[a("u",[t._v("合成线程")])]),t._v("；")])])])]),t._v(" "),a("h5",{attrs:{id:"_6-3-4、显示器显示内容"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-4、显示器显示内容"}},[t._v("#")]),t._v(" 6-3-4、显示器显示内容")]),t._v(" "),a("p",[t._v("生成图块并栅格化操作完成后，"),a("strong",[a("u",[t._v("合成线程")])]),t._v(" 会生成一个绘制命令—"),a("code",[t._v("DrawQuad")]),t._v("，并发送给浏览器进程的 "),a("strong",[a("u",[t._v("viz组件")])]),t._v("，组件根据这个命令，将页面内容绘制到内存(缓冲)，然后把这部分内存数据发送给显卡；所以，当某个动画大量占用内存时，浏览器生成图像的速度变慢，图像传送显卡数据不及时，而显示器还是以不变频率刷新，因此会出现卡顿，出现明显的掉帧现象；")]),t._v(" "),a("ul",[a("li",[t._v("注意：无论是 PC 显示器还是手机屏幕，都有一个固定的刷新频率，一般是 60 HZ(60 帧、每秒更新60张图，停留 16.7 ms/图)，而每次更新的图片均来自于显卡的 "),a("strong",[a("u",[t._v("前缓冲区")])]),t._v("；当显卡接收到浏览器进程传来的新的页面后，会合成相应的新图像，并将新图像保存到  "),a("u",[a("strong",[t._v("后缓冲区")])]),t._v("；然后系统自动将 "),a("strong",[a("u",[t._v("前缓冲区")])]),t._v(" 和  "),a("strong",[a("u",[t._v("后缓冲区")])]),t._v(" 对换位置，如此循环更新；")])]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/10.png"}}),t._v(" "),a("h4",{attrs:{id:"_6-4、重排、重绘、合成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-4、重排、重绘、合成"}},[t._v("#")]),t._v(" 6-4、重排、重绘、合成")]),t._v(" "),a("p",[t._v("回顾渲染流水线：")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/12.png",align:"left"}}),t._v(" "),a("ul",[a("li",[t._v("重绘是：当节点需要更改外观而不会影响布局的，比如改变 "),a("code",[t._v("color")]),t._v(" 就叫称为重绘；")]),t._v(" "),a("li",[t._v("回流是：布局或几何属性需要改变就称为回流；")])]),t._v(" "),a("h5",{attrs:{id:"_6-4-1、重排-回流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-1、重排-回流"}},[t._v("#")]),t._v(" 6-4-1、重排/回流")]),t._v(" "),a("p",[t._v("对 DOM 修改导致元素的尺寸或位置发生变化时，浏览器需要重新计算渲染树，触发重排/回流；")]),t._v(" "),a("ul",[a("li",[t._v("触发条件：对 DOM 结构的修改引发 DOM 几何尺寸变化时，会导致 "),a("strong",[a("u",[t._v("重排(reflow)")])]),t._v("；\n"),a("ul",[a("li",[t._v("页面初次渲染；")]),t._v(" "),a("li",[t._v("元素字体大小变化；")]),t._v(" "),a("li",[t._v("浏览器窗口大小改变；")]),t._v(" "),a("li",[t._v("激活 CSS 伪类；比如 :hover；")]),t._v(" "),a("li",[t._v("DOM 元素的几何属性变化，常见的比如："),a("code",[t._v("width")]),t._v("、"),a("code",[t._v("height")]),t._v("、"),a("code",[t._v("padding")]),t._v("、"),a("code",[t._v("margin")]),t._v("、"),a("code",[t._v("left")]),t._v("、"),a("code",[t._v("top")]),t._v("、"),a("code",[t._v("border")]),t._v(" 等；")]),t._v(" "),a("li",[t._v("元素尺寸、位置、内容发生改变；")]),t._v(" "),a("li",[t._v("使 DOM 节点发生 "),a("code",[t._v("增减")]),t._v(" 或 "),a("code",[t._v("移动")]),t._v("；")]),t._v(" "),a("li",[t._v("读写 "),a("code",[t._v("offset")]),t._v(" 族、"),a("code",[t._v("scroll")]),t._v("族、"),a("code",[t._v("client")]),t._v(" 族属性时，浏览器为获取这些值，需要进行回流操作；")]),t._v(" "),a("li",[t._v("查询某些属性或调用某些方法\n"),a("ul",[a("li",[t._v("clientWidth、clientHeight、clientTop、clientLeft")]),t._v(" "),a("li",[t._v("offsetWidth、offsetHeight、offsetTop、offsetLeft")]),t._v(" "),a("li",[t._v("scrollWidth、scrollHeight、scrollTop、scrollLeft")]),t._v(" "),a("li",[t._v("getComputedStyle()")]),t._v(" "),a("li",[t._v("getBoundingClientRect()")]),t._v(" "),a("li",[t._v("scrollTo()")])])])])]),t._v(" "),a("li",[t._v("回流过程：依照下面的渲染流水线，触发重排/回流时，若 DOM 结构发生改变，则重新渲染 DOM 树，然后将后续流程(含主线程外的任务)全部走一遍；相当于将解析和合成的过程重新又走了一篇，开销巨大；")])]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/13.png",align:"left"}}),t._v(" "),a("h5",{attrs:{id:"_6-4-2、重绘"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-2、重绘"}},[t._v("#")]),t._v(" 6-4-2、重绘")]),t._v(" "),a("p",[t._v("DOM 修改导致样式发生变化，但无影响其几何属性，触发重绘，而不触发回流；而由于 DOM 位置信息无需更新，省去布局过程，性能上优于回流；")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("触发条件：当 DOM 的修改导致样式变化，且没有影响几何属性时，会导致 "),a("strong",[a("u",[t._v("重绘(repaint)")])]),t._v("；")])]),t._v(" "),a("li",[a("p",[t._v("重绘过程：由于没有导致 DOM 几何属性变化，故元素的位置信息无需更新，从而省去布局与建图层树过程，然后继续进行分块、生成位图等后面系列操作；")])])]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/14.png",align:"left"}}),t._v(" "),a("ul",[a("li",[t._v("注意：重排跳过了 "),a("u",[t._v("生成布局树")]),t._v(" 和 "),a("u",[t._v("建图层树")]),t._v(" 阶段，直接生成绘制列表，然后继续进行分块、生成位图等后面一系列操作；")]),t._v(" "),a("li",[t._v("注意：重绘不一定导致回流，但回流一定发生了重绘；")]),t._v(" "),a("li",[t._v("注意："),a("strong",[a("u",[a("em",[t._v("回流比重绘的代价要更高")])])]),t._v("；有时即使仅仅回流一个单一的元素，其父元素及任何跟随它的元素也会产生回流；为避免频繁回流导致的性能问题，现代浏览器会对频繁的回流或重绘操作进行**"),a("u",[a("em",[t._v("优化")])]),a("strong",[t._v("：浏览器会维护一个 flush 队列，以存放触发回流与重绘的任务，若队列中任务数量或时间间隔达到一个阈值时，浏览器就会将此队列任务一次性出队清空，进行一次批处理，如此可将多次回流和重绘变成一次；")]),a("u",[a("em",[t._v("但当")])]),t._v("**访问一些即使属性时，为获得此时此刻的、最准确的属性值，浏览器会提前将 flush 队列的任务出队：clientwidth、clientHeight、clientTop、clientLeftoffsetwidth、offsetHeight、offsetTop、offsetLeftscrollwidth、scrollHeight、scrollTop、scrollLeftwidth、heightgetComputedStyle()、getBoundingClientRect()")])]),t._v(" "),a("h5",{attrs:{id:"_6-4-3、合成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-3、合成"}},[t._v("#")]),t._v(" 6-4-3、合成")]),t._v(" "),a("p",[t._v("直接合成，比如利用 CSS3 的 "),a("code",[t._v("transform")]),t._v("、"),a("code",[t._v("opacity")]),t._v("、"),a("code",[t._v("filter")]),t._v(" 等属性可实现合成效果，即  "),a("strong",[a("u",[t._v("GPU加速")])]),t._v("；")]),t._v(" "),a("p",[t._v("补充：GPU加速即：在使用"),a("code",[t._v("CSS3")]),t._v("中的"),a("code",[t._v("transform")]),t._v("、"),a("code",[t._v("opacity")]),t._v("、"),a("code",[t._v("filter")]),t._v("属性时，跳过布局和绘制流程，直接进入非主线处理的部分，即交给合成线程；")]),t._v(" "),a("ul",[a("li",[t._v("GPU 加速原因：在合成的情况下，会直接跳过布局和绘制流程，直接进入"),a("code",[t._v("非主线程")]),t._v("处理的部分，即直接交给 "),a("strong",[a("u",[t._v("合成线程")])]),t._v(" 处理：\n"),a("ul",[a("li",[t._v("充分发挥 GPU 优势："),a("strong",[a("u",[t._v("合成线程")])]),t._v(" 生成位图的过程中：会调用线程池，并在其中使用 GPU 进行加速生成，而 GPU 是擅长处理位图数据；")]),t._v(" "),a("li",[a("strong",[a("u",[a("em",[t._v("无占用主线程资源")])])]),t._v("：即使主线程卡住，但效果依然能够流畅地展示；")])])]),t._v(" "),a("li",[t._v("GPU 使用注意：GPU 渲染字体会导致字体模糊，过多 GPU 处理会导致内存问题；")])]),t._v(" "),a("h5",{attrs:{id:"_6-4-4、注意事项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-4、注意事项"}},[t._v("#")]),t._v(" 6-4-4、注意事项")]),t._v(" "),a("p",[a("strong",[t._v("回流必定触发重绘，重绘不一定触发回流；重绘的开销较小，回流的代价较高")]),t._v("；改变父节点里的子节点很可能会导致父节点的一系列回流；")]),t._v(" "),a("h5",{attrs:{id:"_6-4-4-1、最佳实践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-4-1、最佳实践"}},[t._v("#")]),t._v(" 6-4-4-1、最佳实践")]),t._v(" "),a("p",[t._v("CSS：")]),t._v(" "),a("ul",[a("li",[t._v("避免使用多层内联样式；")]),t._v(" "),a("li",[t._v("避免使用 CSS 表达式，比如 "),a("code",[t._v("clac()")]),t._v("；")]),t._v(" "),a("li",[t._v("CSS 选择符 "),a("u",[t._v("从右往左")]),t._v(" 匹配查找，避免节点层级过多；")]),t._v(" "),a("li",[t._v("使用 "),a("code",[t._v("visibility")]),t._v(" 替换 "),a("code",[t._v("display: none")]),t._v("，前者只引起重绘，后者则触发回流；")]),t._v(" "),a("li",[t._v("避免使用 "),a("code",[t._v("table")]),t._v(" 布局，可能很小的一个小改动会造成整个 "),a("code",[t._v("table")]),t._v(" 的重新布局；")]),t._v(" "),a("li",[t._v("使用 "),a("code",[t._v("transform")]),t._v(" 替代 "),a("code",[t._v("top")]),t._v("，"),a("code",[t._v("transform")]),t._v(" 和 "),a("code",[t._v("opacity")]),t._v(" 效果，不会触发 "),a("code",[t._v("layout")]),t._v(" 和 "),a("code",[t._v("repaint;")])]),t._v(" "),a("li",[t._v("动画效果/动画元素，可使用绝对定位使其脱离文档流；减少频繁地触发回流重绘；\n"),a("ul",[a("li",[t._v("比如：将动画效果应用到 "),a("code",[t._v("position")]),t._v("  属性为 "),a("code",[t._v("absolute")]),t._v(" 或 "),a("code",[t._v("fixed")]),t._v(" 元素上；")])])])]),t._v(" "),a("p",[t._v("JavaScript：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("避免频繁操作样式，可汇总后统一 "),a("u",[t._v("一次修改")]),t._v("；")])]),t._v(" "),a("li",[a("p",[t._v("避免频繁使用 "),a("code",[t._v("style")]),t._v("，而采用修改 "),a("code",[t._v("class")]),t._v(" 方式；")])]),t._v(" "),a("li",[a("p",[t._v("极限优化时，修改样式可将其 "),a("code",[t._v("display: none")]),t._v(" 后修改；")])]),t._v(" "),a("li",[a("p",[t._v("使用 "),a("code",[t._v("resize")]),t._v("、"),a("code",[t._v("scroll")]),t._v("  时进行防抖和节流处理，减少回流次数；")])]),t._v(" "),a("li",[a("p",[t._v("避免频繁读取会引发回流重绘的属性，若需多次使用则可考虑缓存；")])]),t._v(" "),a("li",[a("p",[t._v("避免频繁操作 DOM，减少 "),a("code",[t._v("dom")]),t._v("的增删次数，可使用 "),a("u",[t._v("字符串")]),t._v(" 或 "),a("code",[t._v("documentFragment")]),t._v(" 一次性插入；")]),t._v(" "),a("ul",[a("li",[t._v("比如：使用 "),a("code",[t._v("createDocumentFragment")]),t._v(" 进行批量 DOM 操作，修改完毕后，再放入文档流；")]),t._v(" "),a("li",[t._v("比如：先使用 "),a("code",[t._v("display:none")]),t._v(" 避开回流重绘，操作结束后再显示；")])])]),t._v(" "),a("li",[a("p",[t._v("避免多次触发上面提到的那些会触发回流的方法，可使用变量将查询结果缓存，避免多次查询；")])]),t._v(" "),a("li",[a("p",[t._v("动画实现的速度的选择，动画速度越快，回流次数越多，也可选择使用 "),a("code",[t._v("requestAnimationFrame;")])])]),t._v(" "),a("li",[a("p",[t._v("将频繁重绘或者回流的节点提升为合成层，图层能够阻止该节点的渲染行为影响别的节点；比如对于 "),a("code",[t._v("video")]),t._v(" 标签来说，浏览器会自动将该节点变为图层；")]),t._v(" "),a("ul",[a("li",[t._v("设置节点为图层的方式有很多，我们可以通过以下几个常用属性可以生成新图层：")]),t._v(" "),a("li",[a("code",[t._v("will-change")])]),t._v(" "),a("li",[a("code",[t._v("video")]),t._v("、"),a("code",[t._v("iframe")]),t._v(" 标签")])])]),t._v(" "),a("li",[a("p",[t._v("添加 "),a("code",[t._v("will-change: tranform")]),t._v("：让渲染引擎为节点单独实现一图层；在变换发生时，仅利用 "),a("strong",[a("u",[t._v("合成线程")])]),t._v(" 去处理这些变换而不牵扯主线程，提高渲染效率；")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("注意：值并非限制 tranform，任何可实现合成效果的 CSS 属性均可使用 "),a("code",[t._v("will-change")]),t._v(" 来声明；"),a("a",{attrs:{href:"https://juejin.im/post/5da52531518825094e373372",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用例子"),a("OutboundLink")],1),t._v("；")])]),t._v(" "),a("li",[a("p",[t._v("注意：通俗说即利用 CSS3 的"),a("code",[t._v("transform")]),t._v("、"),a("code",[t._v("opacity")]),t._v("、"),a("code",[t._v("filter")]),t._v(" 这些属性，以实现合成的效果，即"),a("code",[t._v("GPU")]),t._v("加速；")])]),t._v(" "),a("li",[a("div",{staticClass:"language-css extra-class"},[a("pre",{pre:!0,attrs:{class:"language-css"}},[a("code",[a("span",{pre:!0,attrs:{class:"token selector"}},[t._v("#divId")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v("will-change")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" transform"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])])])])]),t._v(" "),a("h5",{attrs:{id:"_6-4-4-2、优化检测"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-4-2、优化检测"}},[t._v("#")]),t._v(" 6-4-4-2、优化检测")]),t._v(" "),a("p",[t._v("当发生 "),a("code",[t._v("DOMContentLoaded")]),t._v(" 事件后，就会生成渲染树，生成渲染树就可以进行渲染了，这一过程更大程度上和硬件有关系：")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"/Image/Chromium/23.png"}}),t._v(" "),a("h5",{attrs:{id:"_6-4-5、与eventloop关系"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-5、与eventloop关系"}},[t._v("#")]),t._v(" 6-4-5、与EventLoop关系")]),t._v(" "),a("ul",[a("li",[t._v("首先，当 Eventloop 执行完 Microtasks 后，会判断 "),a("code",[t._v("document")]),t._v(" 是否需要更新，因为浏览器是 60Hz 的刷新率，每 16.6ms 才会更新一次；")]),t._v(" "),a("li",[t._v("然后，判断是否有 "),a("code",[t._v("resize")]),t._v(" 或者 "),a("code",[t._v("scroll")]),t._v(" 事件，有则触发，所以 "),a("code",[t._v("resize")]),t._v(" 和 "),a("code",[t._v("scroll")]),t._v(" 事件也是至少 16ms 才会触发一次，并且自带节流功能；")]),t._v(" "),a("li",[t._v("然后，判断是否触发了 media query；")]),t._v(" "),a("li",[t._v("然后，更新动画并且发送事件；")]),t._v(" "),a("li",[t._v("然后，判断是否有全屏操作事件；")]),t._v(" "),a("li",[t._v("然后，执行 "),a("code",[t._v("requestAnimationFrame")]),t._v(" 回调；")]),t._v(" "),a("li",[t._v("然后，执行 "),a("code",[t._v("IntersectionObserver")]),t._v(" 回调，该方法用于判断元素是否可见，可用于懒加载，但兼容性不好；")]),t._v(" "),a("li",[t._v("最后，更新界面；")]),t._v(" "),a("li",[t._v("注意：以上是一帧中可能会做的事情；若在一帧中有空闲时间，就会去执行 "),a("code",[t._v("requestIdleCallback")]),t._v(" 回调；"),a("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model",target:"_blank",rel:"noopener noreferrer"}},[t._v("详看"),a("OutboundLink")],1)])]),t._v(" "),a("h4",{attrs:{id:"_6-x、实际问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-x、实际问题"}},[t._v("#")]),t._v(" 6-X、实际问题")]),t._v(" "),a("h5",{attrs:{id:"_6-x-1、dom-操作性能问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-x-1、dom-操作性能问题"}},[t._v("#")]),t._v(" 6-X-1、DOM 操作性能问题")]),t._v(" "),a("p",[t._v("原因：因为 DOM 是属于渲染引擎中的东西，而 JS 又是 JS 引擎中的东西；通过 JS 操作 DOM 时，涉及到两个线程间的通信，势必会带来一些性能上的损耗。操作 DOM 次数一多，也就等同于一直在进行线程间的通信，且操作 DOM 可能还会带来重绘回流的情况，所以也就导致了性能上的问题；")]),t._v(" "),a("p",[t._v("改进：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("requestAnimationFrame")]),t._v("  方式去循环的插入 DOM；")]),t._v(" "),a("li",[t._v("虚拟滚动 (virtualized scroller)：只渲染可视区域内的内容，非可见区域的完全不渲染，当用户在滚动的时就实时去替换渲染的内容  "),a("a",{attrs:{href:"https://github.com/bvaughn/react-virtualized",target:"_blank",rel:"noopener noreferrer"}},[t._v("react-virtualized"),a("OutboundLink")],1),t._v("；")])]),t._v(" "),a("h5",{attrs:{id:"_6-x-2、渲染阻塞问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-x-2、渲染阻塞问题"}},[t._v("#")]),t._v(" 6-X-2、渲染阻塞问题")]),t._v(" "),a("ul",[a("li",[t._v("首先，渲染的前提是生成渲染树，故 HTML 和 CSS 势必会阻塞渲染；\n"),a("ul",[a("li",[t._v("优化：若想渲染快，可降低初始所需的渲染的文件 大小，并且扁平层级，优化选择器；")]),t._v(" "),a("li",[t._v("注意：CSS 由单独的下载线程异步下载，由于 DOM 树的解析和构建此步与 css 并无关系，故并不会影响 DOM 解析，但最终布局树需要 DOM 树和 DOM 样式的，因此 CSS 会阻塞布局树的建立；")])])]),t._v(" "),a("li",[t._v("然后，当浏览器在解析到  "),a("code",[t._v("script")]),t._v(" 标签时，会暂停构建 DOM，完成后才会从暂停的地方重新开始(即 script 会阻塞页面渲染)；\n"),a("ul",[a("li",[t._v("注意：因为 JS属于单线程，在加载 "),a("code",[t._v("script")]),t._v(" 标签内容时，渲染线程会被暂停，因 "),a("code",[t._v("script")]),t._v("标签中内容可能会操作"),a("code",[t._v("DOM")]),t._v("，若加载"),a("code",[t._v("script")]),t._v("标签的同时渲染页面就会产生冲突，渲染线程("),a("code",[t._v("GUI")]),t._v(")和 JS 引擎线程是互斥的；")]),t._v(" "),a("li",[t._v("优化：若想首屏渲染快，一般而言不应在首屏时就加载 JS 文件，而将 "),a("code",[t._v("script")]),t._v(" 标签放在 "),a("code",[t._v("body")]),t._v(" 标签底部；")]),t._v(" "),a("li",[t._v("优化：若想首屏渲染快，亦可给 "),a("code",[t._v("script")]),t._v(" 标签添加 "),a("code",[t._v("defer")]),t._v(" 或 "),a("code",[t._v("async")]),t._v(" 属性：\n"),a("ul",[a("li",[a("code",[t._v("defer")]),t._v(" 属性表示该 JS 文件会并行下载，但会放到 HTML 解析完成后顺序执行，此时的 "),a("code",[t._v("script")]),t._v(" 标签可放在任意位置；")]),t._v(" "),a("li",[t._v("对于没有任何依赖的 JS 文件可以加上 "),a("code",[t._v("async")]),t._v(" 属性，表示 JS 文件下载和解析不会阻塞渲染；")]),t._v(" "),a("li",[t._v("注意：一般脚本与 DOM 元素和其它脚本间的依赖关系不强时会选用 async；当脚本依赖于 DOM 元素和其它脚本的执行结果时会选用 defer；")])])])])])]),t._v(" "),a("h5",{attrs:{id:"_6-x-2-1、script-引入方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-x-2-1、script-引入方式"}},[t._v("#")]),t._v(" 6-X-2-1、script 引入方式")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("JS 动态插入 "),a("code",[t._v("<script>")])])]),t._v(" "),a("li",[a("p",[t._v("HTML 静态引入 "),a("code",[t._v("<script>")])]),t._v(" "),a("ul",[a("li",[a("code",[t._v("<script defer>")]),t._v("：延迟加载，元素解析完成后执行；")]),t._v(" "),a("li",[a("code",[t._v("<script async>")]),t._v("：异步加载，但执行时会阻塞元素渲染；")])])])]),t._v(" "),a("h5",{attrs:{id:"_6-x-3、关键渲染路径问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-x-3、关键渲染路径问题"}},[t._v("#")]),t._v(" 6-X-3、关键渲染路径问题")]),t._v(" "),a("p",[t._v("不考虑缓存和优化网络协议，只考虑可以通过哪些方式来最快的渲染页面：")]),t._v(" "),a("ul",[a("li",[t._v("从文件大小：前略；")]),t._v(" "),a("li",[t._v("从 "),a("code",[t._v("script")]),t._v(" 标签使用：前略；")]),t._v(" "),a("li",[t._v("从 CSS、HTML 的代码书写：前略；")]),t._v(" "),a("li",[t._v("从需要下载的内容是否需要在首屏使用：前略；")])]),t._v(" "),a("h3",{attrs:{id:"x、打开页面需要启动的进程-简略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#x、打开页面需要启动的进程-简略"}},[t._v("#")]),t._v(" X、打开页面需要启动的进程-简略")]),t._v(" "),a("p",[t._v("浏览器从关闭状态进行启动，然后新开 1 个页面至少需要 1 个网络进程、1 个浏览器进程、1 个 GPU 进程以及 1 个渲染进程，共 4 个进程；")]),t._v(" "),a("p",[t._v("后续再新开标签页，浏览器、网络进程、GPU进程是共享的，不会重新启动，若 2 个页面属于同一站点的话，并且从a页面中打开的b页面，则他们也会共用一个渲染进程，否则新开一个渲染进程；")]),t._v(" "),a("p",[t._v("最新的 Chrome 浏览器包括：1 个浏览器（Browser）主进程、1 个 GPU 进程、1 个网络（NetWork）进程、多个渲染进程和多个插件进程：")]),t._v(" "),a("ul",[a("li",[t._v("浏览器进程：主要负责界面显示、用户交互、子进程管理，同时提供存储等功能；")]),t._v(" "),a("li",[t._v("渲染进程：核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，排版引擎 Blink 和 JavaScript 引擎 V8 都是运行在该进程中，默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下；")]),t._v(" "),a("li",[t._v("GPU 进程：其实，Chrome 刚开始发布的时候是没有 GPU 进程的。而 GPU 的使用初衷是为了实现 3D CSS 的效果，只是随后网页、Chrome 的 UI 界面都选择采用 GPU 来绘制，这使得 GPU 成为浏览器普遍的需求。最后，Chrome 在其多进程架构上也引入了 GPU 进程；")]),t._v(" "),a("li",[t._v("网络进程：主要负责页面的网络资源加载，之前是作为一个模块运行在浏览器进程里面的，直至最近才独立出来，成为一个单独的进程；")]),t._v(" "),a("li",[t._v("插件进程：主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响；")])]),t._v(" "),a("h3",{attrs:{id:"y、浏览器架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#y、浏览器架构"}},[t._v("#")]),t._v(" Y、浏览器架构")]),t._v(" "),a("ul",[a("li",[t._v("用户界面")]),t._v(" "),a("li",[t._v("主进程")]),t._v(" "),a("li",[t._v("内核\n"),a("ul",[a("li",[t._v("渲染引擎")]),t._v(" "),a("li",[t._v("JS 引擎\n"),a("ul",[a("li",[t._v("执行栈")])])]),t._v(" "),a("li",[t._v("事件触发线程\n"),a("ul",[a("li",[t._v("消息队列\n"),a("ul",[a("li",[t._v("微任务")]),t._v(" "),a("li",[t._v("宏任务")])])])])]),t._v(" "),a("li",[t._v("网络异步线程")]),t._v(" "),a("li",[t._v("定时器线程")])])])]),t._v(" "),a("p",[t._v("https://juejin.im/post/5e11cd225188253a73288212")]),t._v(" "),a("p",[t._v("https://juejin.im/post/5e572a34518825490f722b9e#heading-2")])])}),[],!1,null,null,null);s.default=e.exports}}]);